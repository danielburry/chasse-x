"use strict";var qe=Object.defineProperty,ze=Object.defineProperties,Je=Object.getOwnPropertyDescriptors,Ce=Object.getOwnPropertySymbols,Xe=Object.prototype.hasOwnProperty,He=Object.prototype.propertyIsEnumerable,ve=(X,K,g)=>K in X?qe(X,K,{enumerable:!0,configurable:!0,writable:!0,value:g}):X[K]=g,ne=(X,K)=>{for(var g in K||(K={}))Xe.call(K,g)&&ve(X,g,K[g]);if(Ce)for(var g of Ce(K))He.call(K,g)&&ve(X,g,K[g]);return X},ge=(X,K)=>ze(X,Je(K));(self.webpackChunkchasse_pwa_front=self.webpackChunkchasse_pwa_front||[]).push([[5171],{90512:(X,K,g)=>{g.d(K,{Z:()=>Q});var F=g(15861);class Q{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(R,A,j){this._layerById[A]=j,this._layerByName[R]=j}featureSetByName(R,A=!0,j=["*"]){var C=this;return(0,F.Z)(function*(){return void 0===C._layerByName[R]?null:C._layerByName[R]})()}featureSetById(R,A=!0,j=["*"]){var C=this;return(0,F.Z)(function*(){return void 0===C._layerById[R]?null:C._layerById[R]})()}castToText(){return"object, FeatureSetCollection"}}},85171:(X,K,g)=>{g.r(K),g.d(K,{constructAssociationMetaDataFeatureSetFromUrl:()=>Be,constructFeatureSet:()=>re,constructFeatureSetFromPortalItem:()=>Ve,constructFeatureSetFromRelationship:()=>ke,constructFeatureSetFromUrl:()=>le,convertToFeatureSet:()=>Qe,createFeatureSetCollectionFromMap:()=>Me,createFeatureSetCollectionFromService:()=>We,getPortal:()=>Ge,initialiseMetaDataCache:()=>Le,lookupUser:()=>Ke});var F=g(15861),Q=g(24263),W=g(84792),R=g(90512),A=g(53997),j=g(88879),C=g(47562),v=g(52724),T=g(95896),P=g(49086),m=g(91510),p=g(57366),D=g(77132),f=g(83947),E=g(45333),I=g(10410);class s{clone(){const e=new s;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,n){const r=new s;r.field=e;const d=I.WhereClause.create(t,n),i=function o(b){if("function"===b.parseTree.type){if(0===b.parseTree.args.value.length)return{name:b.parseTree.name,expr:null};if(b.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");const e=I.WhereClause.create((0,f.XF)(b.parseTree.args.value[0],D.Bj.Standardised,b.parameters),b.fieldsIndex);return{name:b.parseTree.name,expr:e}}return null}(d);if(null===i)throw new Error("Invalid Statistic Function");const h=i.name.toUpperCase().trim();if("MIN"===h){if(r.typeofstat="MIN",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===h){if(r.typeofstat="MAX",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===h)r.typeofstat="COUNT",r.workingexpr=i.expr;else if("STDEV"===h){if(r.typeofstat="STDDEV",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===h){if(r.typeofstat="SUM",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===h){if(r.typeofstat="AVG",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===h){if(r.typeofstat="AVG",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==h)throw new Error("Invalid Statistic Function");if(r.typeofstat="VAR",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}return r}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}var a=g(50011),u=g(65234),_=g(36255),c=g(60466);function w(b){if(!b)return"COUNT";switch(b.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class N extends P.Z{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){var t=this;return(0,F.Z)(function*(){if(null===t._wset){const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,t._wset}return t._wset})()}_isInFeatureSet(){return D.dj.InFeatureSet}_nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}_convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,n=1;const r=this._parent?this._parent.getFieldsIndex():new c.Z([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let i=!1;for(let h=0;h<this._config.groupbyfields.length;h++)if(this._config.groupbyfields[h].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}if(!1===i)for(let h=0;h<this._config.statsfields.length;h++)if(this._config.statsfields[h].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}!1===i?t=!0:(this.objectIdField="ROW__ID"+n.toString(),n++)}for(const i of this._config.statsfields){const h=new s;h.field=i.name,h.tofieldname=i.name,h.workingexpr=i.expression instanceof I.WhereClause?i.expression:I.WhereClause.create(i.expression,r),h.typeofstat=w(i.statistic),this._decodedStatsfield.push(h)}this._decodedGroupbyfield=[];for(const i of this._config.groupbyfields){const h={name:i.name,singlefield:null,tofieldname:i.name,expression:i.expression instanceof I.WhereClause?i.expression:I.WhereClause.create(i.expression,r)};this._decodedGroupbyfield.push(h)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const i of this._parent.fields)e[i.name.toUpperCase()]=1;this.types=null}else this.geometryType=D.Qk.point,this.typeIdField="",this.types=null,this.spatialReference=new u.Z({wkid:4326});this.fields=[];const d=new s;d.field=this._nextUniqueName(e),d.tofieldname=this.objectIdField,d.workingexpr=I.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),d.typeofstat="MIN",this._decodedStatsfield.push(d);for(const i of this._decodedGroupbyfield){const h=new _.Z;if(i.name=this._nextUniqueName(e),h.name=i.tofieldname,h.alias=h.name,(0,f.y5)(i.expression)){const l=this._parent.getField((0,f.zR)(i.expression,D.Bj.Standardised));if(!l)throw new Error("Field is not present for Aggregation");i.name=l.name,i.singlefield=l.name,this.phsyicalgroupbyfields.push(l.name),h.type=l.type}else{h.type=this._convertToEsriFieldType((0,f.DT)(i.expression,this._parent.fields));const l=new _.Z;l.name=i.name,l.alias=l.name,this.phsyicalgroupbyfields.push(i.name),this._adaptedFields.push(new v.yN(l,i.expression)),this._candosimplegroupby=!1}this.fields.push(h)}if(this._adaptedFields.length>0)for(const i of this._parent.fields)this._adaptedFields.push(new v.$X(i));for(let i=0;i<this._decodedStatsfield.length;i++){const h=new _.Z;let l=null;const S=this._decodedStatsfield[i];S.field=this._nextUniqueName(e),S.tofieldname===this.objectIdField&&(this._internalObjectIdField=S.field),h.name=S.tofieldname,h.alias=h.name;const y=null!==S.workingexpr&&(0,f.y5)(S.workingexpr)?(0,f.zR)(S.workingexpr,D.Bj.Standardised):"";switch(this._decodedStatsfield[i].typeofstat){case"SUM":if(""!==y){if(l=this._parent.getField(y),!l)throw new Error("Field is not present for Aggregation");h.type=l.type}else h.type="double";break;case"MIN":case"MAX":if(""!==y){if(l=this._parent.getField(y),!l)throw new Error("Field is not present for Aggregation");h.type=l.type}else h.type="double";break;case"COUNT":h.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==y&&(l=this._parent.getField(y),!l))throw new Error("Field is not present for Aggregation");h.type="double"}this.fields.push(h)}}_canDoAggregates(){return(0,F.Z)(function*(){return!1})()}_getFeatures(e,t,n,r){var d=this;return(0,F.Z)(function*(){const i=d._maxQuery;return!0===d._checkIfNeedToExpandKnownPage(e,i)?(yield d._expandPagedSet(e,i,0,0,r),d._getFeatures(e,t,n,r)):"success"})()}_getFilteredSet(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){if(""!==e)return new m.Z([],[],!0,null);let h=null;const l={ordered:!1,nowhereclause:!1};if(yield i._ensureLoaded(),null!==n)for(let y=0;y<i._decodedStatsfield.length;y++)if(!0===(0,f.hq)(n,i._decodedStatsfield[y].tofieldname)){l.nowhereclause=!0,n=null;break}if(null!==r){l.ordered=!0;for(let y=0;y<i._decodedStatsfield.length;y++)if(!0===r.scanForField(i._decodedStatsfield[y].tofieldname)){r=null,l.ordered=!1;break}if(null!==r)for(const y of i._decodedGroupbyfield)if(null===y.singlefield&&!0===r.scanForField(y.tofieldname)){r=null,l.ordered=!1;break}}if(!1!==i._candosimplegroupby&&(yield i._parent._canDoAggregates(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,null))){let y=null;n&&(y=i._reformulateWhereClauseWithoutGroupByFields(n));let Z=null;r&&(Z=i._reformulateOrderClauseWithoutGroupByFields(r));const L=yield i._parent._getAggregatePagesDataSourceDefinition(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,y,Z,i._internalObjectIdField);return i._checkCancelled(d),h=!0===l.nowhereclause?new m.Z(L._candidates.slice(0).concat(L._known.slice(0)),[],!0===l.ordered&&L._ordered,i._clonePageDefinition(L.pagesDefinition)):new m.Z(L._candidates.slice(0),L._known.slice(0),!0===l.ordered&&L._ordered,i._clonePageDefinition(L.pagesDefinition)),h}let S=i._parent;if(i._adaptedFields.length>0&&(S=new v.Xx({parentfeatureset:i._parent,adaptedFields:i._adaptedFields,extraFilter:null})),!0===l.nowhereclause)h=new m.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new T.Z({parentfeatureset:S,orderbyclause:new p.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}});else{let y=S;if(null!==n){let Z=null;n&&(Z=i._reformulateWhereClauseWithoutGroupByFields(n)),y=new A.Z({parentfeatureset:y,whereclause:Z})}h=new m.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new T.Z({parentfeatureset:y,orderbyclause:new p.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}})}return h})()}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=(0,f.bB)(e,t.tofieldname,(0,f.zR)(t.workingexpr,D.Bj.Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=(0,f.bB)(e,t.tofieldname,(0,f.zR)(t.expression,D.Bj.Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const n of this._decodedGroupbyfield)n.tofieldname!==n.name&&t.push({field:n.tofieldname,newfield:n.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,n){var r=this;return(0,F.Z)(function*(){return!0===r._checkIfNeedToExpandCandidatePage(e,r._maxQuery)?(yield r._expandPagedSet(e,r._maxQuery,0,0,n),r._refineSetBlock(e,t,n)):(r._checkCancelled(n),r._refineKnowns(e,t),e)})()}_expandPagedSet(e,t,n,r,d){return this._expandPagedSetFeatureSet(e,t,n,r,d)}_getPhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){if(!0===e.pagesDefinition.aggregatefeaturesetpagedefinition)return r._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,n,[]);const d=yield r._getAgregagtePhysicalPage(e,t,n);for(const i of d){const h={geometry:i.geometry,attributes:{}};for(const l of r._decodedGroupbyfield)h.attributes[l.tofieldname]=i.attributes[l.name];for(const l of r._decodedStatsfield)h.attributes[l.tofieldname]=i.attributes[l.field];r._featureCache[h.attributes[r.objectIdField]]=new j.Z(h)}return d.length})()}_sequentialGetPhysicalItem(e,t,n,r){return new Promise((d,i)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(n)),!0===e.pagesDefinition.internal.fullyResolved||0===t?d(r.length):this._nextAggregateItem(e,t,n,r,h=>{d(null===h?r.length:this._sequentialGetPhysicalItem(e,t-=1,n,r))},i)})}_nextAggregateItem(e,t,n,r,d,i){try{(0,C.X)(e.pagesDefinition.internal.iterator.next()).then(h=>{if(null===h)if(null!==e.pagesDefinition.internal.workingItem){const l=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(l),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(l.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,d(null)}else e.pagesDefinition.internal.fullyResolved=!0,d(null);else{const l=this._generateAggregateHash(h);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[h],id:l};else{if(l!==e.pagesDefinition.internal.workingItem.id){const S=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return r.push(S),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(S.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[h],id:l},void d(S)}e.pagesDefinition.internal.workingItem.features.push(h)}this._nextAggregateItem(e,t,n,r,d,i)}},i)}catch(h){i(h)}}_calculateFieldStat(e,t,n){const r=[];for(let d=0;d<e.features.length;d++)if(null!==t.workingexpr){const i=t.workingexpr.calculateValue(e.features[d]);null!==i&&r.push(i)}else r.push(null);switch(t.typeofstat){case"MIN":n.attributes[t.tofieldname]=(0,E.tj)("min",r,-1);break;case"MAX":n.attributes[t.tofieldname]=(0,E.tj)("max",r,-1);break;case"SUM":n.attributes[t.tofieldname]=(0,E.tj)("sum",r,-1);break;case"COUNT":n.attributes[t.tofieldname]=r.length;break;case"VAR":n.attributes[t.tofieldname]=(0,E.tj)("var",r,-1);break;case"STDDEV":n.attributes[t.tofieldname]=(0,E.tj)("stddev",r,-1);break;case"AVG":n.attributes[t.tofieldname]=(0,E.tj)("avg",r,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const r of this._decodedGroupbyfield){const d=r.singlefield?e.features[0].attributes[r.singlefield]:r.expression.calculateValue(e.features[0]);t.attributes[r.tofieldname]=d}for(const r of this._decodedStatsfield)this._calculateFieldStat(e,r,t);const n=[];for(let r=0;r<this._decodedStatsfield.length;r++)n.push(this._calculateFieldStat(e,this._decodedStatsfield[r],t));return this._featureCache[t.attributes[this.objectIdField]]=new j.Z({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const n of this._decodedGroupbyfield){const r=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=null==r?":":":"+r.toString()}return(0,a.F)(t,a.M.String)}_stat(){return(0,F.Z)(function*(){return{calculated:!1}})()}getFeatureByObjectId(){return(0,F.Z)(function*(){return null})()}static registerAction(){P.Z._featuresetFunctions.groupby=function(e,t){return new N({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}var M=g(3482),O=g(79429),x=g(22386),U=g(91179),k=g(32258),te=g(82054),Fe=(g(26584),g(8314),g(63290),g(15283),g(2865)),De=(g(85931),g(21726),g(16730),g(37053),g(20477)),be=g(17253),Y=g(84952),Ee=(g(87183),g(67736),g(90463)),Re=(g(29132),g(24865)),Se=g(67010),Te=(g(13924),g(6871),g(98558)),we=g(60776),xe=g(6729);class ie extends P.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return D.tI}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}convertQueryToLruCacheKey(e){const t=(0,D.hd)(e.toJSON());return(0,a.F)(t,a.M.String)}loadImpl(){var e=this;return(0,F.Z)(function*(){return!0===e._layer.loaded?(e._initialiseFeatureSet(),e):(yield e._layer.load(),e._initialiseFeatureSet(),e)})()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const n of this._layer.outFields)if(n.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const n of this.fields)if("oid"===n.type)e.push(n),t.push(n.name);else for(const r of this._overrideFields)if(r.toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=D.Bj.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=D.Bj.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=D.Bj.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=D.Bj.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}_isInFeatureSet(){return D.dj.InFeatureSet}_refineSetBlock(e){return(0,F.Z)(function*(){return e})()}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,F.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_runDatabaseProbe(e){var t=this;return(0,F.Z)(function*(){yield t._ensureLoaded();const n=new Y.Z;n.where=e.replace("OBJECTID",t._layer.objectIdField);try{return yield t._layer.queryObjectIds(n),!0}catch(r){return!1}})()}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}queryPBF(e){var t=this;return(0,F.Z)(function*(){e.quantizationParameters={mode:"edit"};const n=yield(0,De.executeQueryPBF)(t._layer.parsedUrl,e,new Te.J({}));return be.default.fromJSON((0,te.cn)(n.data)).unquantize()})()}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const n="execute"===t?Fe.e:"executeForCount"===t?Ee.P:Re.G,r="execute"===t&&this.pbfSupportedForQuery(e);let d=null;if(this.recentlyUsedQueries){const i=this.convertQueryToLruCacheKey(e);d=this.recentlyUsedQueries.getFromCache(i),null===d&&(d=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(i,d),d=d.catch(h=>{throw this.recentlyUsedQueries.removeFromCache(i),h}))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===d&&(d=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e)),d}_getFilteredSet(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){const h=yield i.databaseType();if(i.isTable()&&t&&null!==e&&""!==e)return new m.Z([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,n,r,d);let l="",S=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(l=r.constructClause(),S=!0);const y=new Y.Z;y.where=null===n?null===t?"1=1":"":(0,f.zR)(n,h),i._requestStandardised&&(y.sqlFormat="standard"),y.spatialRelationship=i._makeRelationshipEnum(e),y.outSpatialReference=i.spatialReference,y.orderByFields=""!==l?l.split(","):null,y.geometry=null===t?null:t,y.relationParameter=i._makeRelationshipParam(e);let Z=yield i.executeQuery(y,"executeForIds");return null===Z&&(Z=[]),i._checkCancelled(d),new m.Z([],Z,S,null)})()}_expandPagedSet(e,t,n,r,d){return this._expandPagedSetFeatureSet(e,t,n,r,d)}_getFilteredSetUsingPaging(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){let h="",l=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(h=r.constructClause(),l=!0);const S=yield i.databaseType();let y=null===n?null===t?"1=1":"":(0,f.zR)(n,S);i._layer.definitionExpression&&i._useDefinitionExpression&&(y=""!==y?"(("+i._layer.definitionExpression+") AND ("+y+"))":i._layer.definitionExpression);let Z=i._maxQueryRate();const L=i._layer.capabilities.query.maxRecordCount;void 0!==L&&L<Z&&(Z=L);let B=null;if(!0===i._pageJustIds)B=new m.Z([],["GETPAGES"],l,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:Z,resultOffset:0,geometry:null===t?null:t,where:y,orderByFields:h,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let z=!0;!0===i._removeGeometry&&(z=!1);const q=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);B=new m.Z([],["GETPAGES"],l,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:q.join(","),resultRecordCount:Z,resultOffset:0,geometry:null===t?null:t,where:y,orderByFields:h,returnGeometry:z,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return yield i._expandPagedSet(B,Z,0,1,d),B})()}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){const d=e.pagesDefinition.internal.lastRetrieved,i=d,h=e.pagesDefinition.internal.lastPage,l=new Y.Z;r._requestStandardised&&(l.sqlFormat="standard"),l.spatialRelationship=e.pagesDefinition.spatialRel,l.relationParameter=e.pagesDefinition.relationParam,l.outFields=e.pagesDefinition.outFields.split(","),l.num=e.pagesDefinition.resultRecordCount,l.start=e.pagesDefinition.internal.lastPage,l.geometry=e.pagesDefinition.geometry,l.where=e.pagesDefinition.where,l.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,l.returnGeometry=e.pagesDefinition.returnGeometry,l.outSpatialReference=r.spatialReference;const S=yield r.executeQuery(l,"execute");if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==h)return"done";for(let y=0;y<S.features.length;y++)e.pagesDefinition.internal.set[i+y]=S.features[y].attributes[r._layer.objectIdField];if(!1===r._pageJustIds)for(let y=0;y<S.features.length;y++)r._featureCache[S.features[y].attributes[r._layer.objectIdField]]=S.features[y];return(void 0===S.exceededTransferLimit&&S.features.length!==e.pagesDefinition.resultRecordCount||!1===S.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=d+S.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFeatures(e,t,n,r){var d=this;return(0,F.Z)(function*(){const i=[];if(-1!==t&&void 0===d._featureCache[t]&&i.push(t),!0===d._checkIfNeedToExpandKnownPage(e,d._maxProcessingRate()))return yield d._expandPagedSet(e,d._maxProcessingRate(),0,0,r),d._getFeatures(e,t,n,r);let h=0;for(let y=e._lastFetchedIndex;y<e._known.length;y++){if(e._lastFetchedIndex+=1,h++,void 0===d._featureCache[e._known[y]]){let Z=!1;if(null!=d._layer._mode){const L=d._layer._mode;if(void 0!==L._featureMap[e._known[y]]){const B=L._featureMap[e._known[y]];null!==B&&(Z=!0,d._featureCache[e._known[y]]=B)}}if(!1===Z&&(e._known[y]!==t&&i.push(e._known[y]),i.length>=d._maxProcessingRate()-1))break}if(h>=n&&0===i.length)break}if(0===i.length)return"success";const l=new Y.Z;d._requestStandardised&&(l.sqlFormat="standard"),l.objectIds=i,l.outFields=null!==d._overrideFields?d._overrideFields:d._fieldsIncludingObjectId(d._layer.outFields?d._layer.outFields:["*"]),l.returnGeometry=!0,!0===d._removeGeometry&&(l.returnGeometry=!1),l.outSpatialReference=d.spatialReference;const S=yield d.executeQuery(l,"execute");if(d._checkCancelled(r),void 0!==S.error)throw new Error(S.error);for(let y=0;y<S.features.length;y++)d._featureCache[S.features[y].attributes[d._layer.objectIdField]]=S.features[y];return"success"})()}_getDistinctPages(e,t,n,r,d,i,h,l,S){var y=this;return(0,F.Z)(function*(){yield y._ensureLoaded();const Z=yield y.databaseType();let L=n.parseTree.column;for(let G=0;G<y._layer.fields.length;G++)if(y._layer.fields[G].name.toLowerCase()===L.toLowerCase()){L=y._layer.fields[G].name;break}const B=new Y.Z;y._requestStandardised&&(B.sqlFormat="standard");let z=null===i?null===d?"1=1":"":(0,f.zR)(i,Z);y._layer.definitionExpression&&y._useDefinitionExpression&&(z=""!==z?"(("+y._layer.definitionExpression+") AND ("+z+"))":y._layer.definitionExpression),B.where=z,B.spatialRelationship=y._makeRelationshipEnum(r),B.relationParameter=y._makeRelationshipParam(r),B.geometry=null===d?null:d,B.returnDistinctValues=!0,B.returnGeometry=!1,B.outFields=[L];const q=yield y.executeQuery(B,"execute");if(y._checkCancelled(S),!q.hasOwnProperty("features"))throw new Error("Unnexected Result querying statistics from layer");let H=!1;for(let G=0;G<y._layer.fields.length;G++)if(y._layer.fields[G].name===L){"date"===y._layer.fields[G].type&&(H=!0);break}for(let G=0;G<q.features.length;G++){if(H){const J=q.features[G].attributes[L];l.push(null!==J?new Date(J):J)}else l.push(q.features[G].attributes[L]);if(l.length>=h)break}return 0===q.features.length?l:q.features.length===y._layer.capabilities.query.maxRecordCount&&l.length<h?{calculated:!0,result:yield y._getDistinctPages(e+q.features.length,t,n,r,d,i,h,l,S)}:l})()}_distinctStat(e,t,n,r,d,i,h){var l=this;return(0,F.Z)(function*(){return{calculated:!0,result:yield l._getDistinctPages(0,e,t,n,r,d,i,[],h)}})()}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(e,t,n,r){var d=this;return(0,F.Z)(function*(){const i=yield d.databaseType(),h=new Y.Z;if(d._requestStandardised&&(h.sqlFormat="standard"),d.isTable()&&n&&null!==t&&""!==t)return{calculated:!0,result:0};let l=null===r?null===n?"1=1":"":(0,f.zR)(r,i);return d._layer.definitionExpression&&d._useDefinitionExpression&&(l=""!==l?"(("+d._layer.definitionExpression+") AND ("+l+"))":d._layer.definitionExpression),h.where=l,h.where=l,h.spatialRelationship=d._makeRelationshipEnum(t),h.relationParameter=d._makeRelationshipParam(t),h.geometry=null===n?null:n,h.returnGeometry=!1,{calculated:!0,result:yield d.executeQuery(h,"executeForCount")}})()}_stats(e,t,n,r,d,i,h){var l=this;return(0,F.Z)(function*(){yield l._ensureLoaded();const S=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsSqlExpression,y=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsStatistics,Z=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsDistinct;if("count"===e)return Z?l._countstat(e,n,r,d):{calculated:!1};if(!1===y||!1===(0,f.y5)(t)&&!1===S||!1===t.isStandardized)return""!==n||null!==d?{calculated:!1}:l._manualStat(e,t,i,h);if("distinct"===e)return!1===Z?""!==n||null!==d?{calculated:!1}:l._manualStat(e,t,i,h):l._distinctStat(e,t,n,r,d,i,h);const L=yield l.databaseType();if(l.isTable()&&r&&null!==n&&""!==n)return{calculated:!0,result:null};const B=new Y.Z;l._requestStandardised&&(B.sqlFormat="standard");let z=null===d?null===r?"1=1":"":(0,f.zR)(d,L);l._layer.definitionExpression&&l._useDefinitionExpression&&(z=""!==z?"(("+l._layer.definitionExpression+") AND ("+z+"))":l._layer.definitionExpression),B.where=z,B.spatialRelationship=l._makeRelationshipEnum(n),B.relationParameter=l._makeRelationshipParam(n),B.geometry=null===r?null:r;const q=new we.Z;q.statisticType=(0,E.g3)(e),q.onStatisticField=(0,f.zR)(t,L),q.outStatisticFieldName="ARCADE_STAT_RESULT",B.returnGeometry=!1;let H="ARCADE_STAT_RESULT";B.outStatistics=[q];const G=yield l.executeQuery(B,"execute");if(!G.hasOwnProperty("features")||0===G.features.length)throw new Error("Unnexected Result querying statistics from layer");let J=!1;for(let ee=0;ee<G.fields.length;ee++)if("ARCADE_STAT_RESULT"===G.fields[ee].name.toUpperCase()){H=G.fields[ee].name,"date"===G.fields[ee].type&&(J=!0);break}if(J){let ee=G.features[0].attributes[H];return null!==ee&&(ee=new Date(G.features[0].attributes[H])),{calculated:!0,result:ee}}return{calculated:!0,result:G.features[0].attributes[H]}})()}_stat(e,t,n,r,d,i,h){return this._stats(e,t,n,r,d,i,h)}_canDoAggregates(e,t){var n=this;return(0,F.Z)(function*(){yield n._ensureLoaded();let r=!1;const d=n._layer.capabilities&&n._layer.capabilities.query&&!0===n._layer.capabilities.query.supportsSqlExpression;if(void 0!==n._layer.capabilities&&null!==n._layer.capabilities.query&&!0===n._layer.capabilities.query.supportsStatistics&&!0===n._layer.capabilities.query.supportsOrderBy&&(r=!0),r)for(let i=0;i<t.length-1;i++)null!==t[i].workingexpr&&(!1===t[i].workingexpr.isStandardized||!1===(0,f.y5)(t[i].workingexpr)&&!1===d)&&(r=!1);return!1!==r})()}_makeRelationshipEnum(e){if(e.includes("esriSpatialRelRelation"))return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.includes("esriSpatialRelRelation")?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,n,r,d,i,h){var l=this;return(0,F.Z)(function*(){yield l._ensureLoaded();const S=yield l.databaseType();let y="",Z=!1,L=!1;null!==i&&l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsOrderBy&&(y=i.constructClause(),L=!0),l._layer.capabilities&&l._layer.capabilities.query&&!1===l._layer.capabilities.query.supportsPagination&&(L=!1,Z=!0,y=l._layer.objectIdField);const B=[];for(let G=0;G<t.length;G++){const J=new we.Z;J.onStatisticField=null!==t[G].workingexpr?(0,f.zR)(t[G].workingexpr,S):"",J.outStatisticFieldName=t[G].field,J.statisticType=t[G].toStatisticsName(),B.push(J)}""===y&&(y=e.join(","));let z=l._maxQueryRate();const q=l._layer.capabilities.query.maxRecordCount;void 0!==q&&q<z&&(z=q);let H=null===d?null===r?"1=1":"":(0,f.zR)(d,S);return l._layer.definitionExpression&&l._useDefinitionExpression&&(H=""!==H?"(("+l._layer.definitionExpression+") AND ("+H+"))":l._layer.definitionExpression),new m.Z([],["GETPAGES"],L,{groupbypage:!0,spatialRel:l._makeRelationshipEnum(n),relationParam:l._makeRelationshipParam(n),outFields:["*"],useOIDpagination:Z,generatedOid:h,resultRecordCount:z,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:B,geometry:null===r?null:r,where:H,orderByFields:y,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})()}_getAgregagtePhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){let d=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(d=""!==d?"("+d+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const i=e.pagesDefinition.internal.lastRetrieved,h=i,l=e.pagesDefinition.internal.lastPage,S=new Y.Z;if(r._requestStandardised&&(S.sqlFormat="standard"),S.where=d,S.spatialRelationship=e.pagesDefinition.spatialRel,S.relationParameter=e.pagesDefinition.relationParam,S.outFields=e.pagesDefinition.outFields,S.outStatistics=e.pagesDefinition.outStatistics,S.geometry=e.pagesDefinition.geometry,S.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,S.num=e.pagesDefinition.resultRecordCount,S.start=e.pagesDefinition.internal.lastPage,S.returnGeometry=e.pagesDefinition.returnGeometry,S.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,r.isTable()&&S.geometry&&S.spatialRelationship)return[];const y=yield r.executeQuery(S,"execute");if(r._checkCancelled(n),!y.hasOwnProperty("features"))throw new Error("Unnexected Result querying aggregates from layer");const Z=[];if(e.pagesDefinition.internal.lastPage!==l)return[];for(let L=0;L<y.features.length;L++)e.pagesDefinition.internal.set[h+L]=y.features[L].attributes[e.pagesDefinition.generatedOid];for(let L=0;L<y.features.length;L++)Z.push(new j.Z({attributes:y.features[L].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===y.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=y.features[y.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===y.exceededTransferLimit&&y.features.length!==e.pagesDefinition.resultRecordCount||!1===y.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+y.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,Z})()}static create(e,t,n,r,d){const i=new k.default({url:e,outFields:null===t?["*"]:t});return new ie({layer:i,spatialReference:n,lrucache:r,interceptor:d})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,D.US)(this._layer.parsedUrl.path)}queryAttachments(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){if(i._layer.capabilities.data.supportsAttachment&&i._layer.capabilities.operations.supportsQueryAttachments){const h={objectIds:[e],returnMetadata:d};(t&&t>0||n&&n>0)&&(h.size=[t&&t>0?t:0,n&&n>0?n:t+1]),r&&r.length>0&&(h.attachmentTypes=r),i.featureSetQueryInterceptor&&i.featureSetQueryInterceptor.preLayerQueryCallback({layer:i._layer,query:h,method:"attachments"});const l=yield i._layer.queryAttachments(h),S=[];return l&&l[e]&&l[e].forEach(y=>{const Z=i._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+y.id.toString();let L=null;d&&y.exifInfo&&(L=xe.Z.convertJsonToArcade(y.exifInfo,!0)),S.push(new x.Z(y.id,y.name,y.contentType,y.size,Z,L))}),S}return[]})()}queryRelatedFeatures(e){var t=this;return(0,F.Z)(function*(){const n={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};null!=e.resultOffset&&(n.resultOffset=e.resultOffset.toString()),null!=e.resultRecordCount&&(n.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(n.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(n.outSR=JSON.stringify(e.outSpatialReference.toJSON())),t.featureSetQueryInterceptor&&t.featureSetQueryInterceptor.preRequestCallback({layer:t._layer,queryPayload:n,method:"relatedrecords",url:t._layer.parsedUrl.path+"/queryRelatedRecords"});const r=yield(0,W.default)(t._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:n});if(r.data){const d={},i=r.data;if(i&&i.relatedRecordGroups){const h=i.spatialReference;for(const l of i.relatedRecordGroups){const S=l.objectId,y=[];for(const Z of l.relatedRecords){Z.geometry&&(Z.geometry.spatialReference=h);const L=new j.Z({geometry:Z.geometry?(0,U.im)(Z.geometry):null,attributes:Z.attributes});y.push(L)}d[S]={features:y,exceededTransferLimit:!0===i.exceededTransferLimit}}}return d}throw new Error("Invalid Request")})()}getFeatureByObjectId(e,t){var n=this;return(0,F.Z)(function*(){const r=new Y.Z;r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=n.spatialReference,r.where=n.objectIdField+"="+e.toString(),n.featureSetQueryInterceptor&&n.featureSetQueryInterceptor.preLayerQueryCallback({layer:n._layer,query:r,method:"execute"});const d=yield(0,Fe.e)(n._layer.parsedUrl.path,r);return 1===d.features.length?d.features[0]:null})()}getIdentityUser(){var e=this;return(0,F.Z)(function*(){yield e.load();const t=Q.id.findCredential(e._layer.url);return t?t.userId:null})()}getOwningSystemUrl(){var e=this;return(0,F.Z)(function*(){yield e.load();const t=Q.id.findServerInfo(e._layer.url);if(t)return t.owningSystemUrl;let n=e._layer.url;const r=n.toLowerCase().indexOf("/rest/services");if(n=r>-1?n.substring(0,r):n,n){n+="/rest/info";try{const d=yield(0,W.default)(n,{query:{f:"json"}});let i="";return d.data&&d.data.owningSystemUrl&&(i=d.data.owningSystemUrl),i}catch(d){return""}}return""})()}getDataSourceFeatureSet(){const e=new ie({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e}}var Pe=g(16776);class Oe extends P.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return D.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var e=this;return(0,F.Z)(function*(){return yield Promise.all([e._layer.load(),e.relatedLayer.load()]),e._initialiseFeatureSet(),e})()}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],n=[];for(const r of this.fields)if("oid"===r.type)t.push(r),n.push(r.name);else for(const d of this._overrideFields)if(d.toLowerCase()===r.name.toLowerCase()){t.push(r),n.push(r.name);break}this.fields=t,this._overrideFields=n}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){var e=this;return(0,F.Z)(function*(){return yield e.relatedLayer.databaseType(),e._databaseType=e.relatedLayer._databaseType,e._databaseType})()}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return D.dj.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,F.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_changeFeature(e){const t={};for(const n of this.fields)t[n.name]=e.attributes[n.name];return new j.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){if(yield i.databaseType(),i.isTable()&&t&&null!==e&&""!==e)return new m.Z([],[],!0,null);const h=i._layer.nativeCapabilities();if(!1===h.canQueryRelated)return new m.Z([],[],!0,null);if(h.capabilities.queryRelated&&h.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,n,r,d);let l="",S=!1;null!==r&&h.capabilities&&h.capabilities.queryRelated&&!0===h.capabilities.queryRelated.supportsOrderBy&&(l=r.constructClause(),S=!0);const y=new Se.Z;y.objectIds=[i._findObjectId];const Z=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map(J=>J.name):["*"]);y.outFields=Z,y.relationshipId=i.relationship.id,y.where="1=1";let L=!0;!0===i._removeGeometry&&(L=!1),y.returnGeometry=L,i._requestStandardised&&(y.sqlFormat="standard"),y.outSpatialReference=i.spatialReference,y.orderByFields=""!==l?l.split(","):null;const B=yield h.source.queryRelatedFeatures(y);i._checkCancelled(d);const z=B[i._findObjectId]?B[i._findObjectId].features:[],q=[];for(let J=0;J<z.length;J++)i._featureCache[z[J].attributes[i.relatedLayer.objectIdField]]=z[J],q.push(z[J].attributes[i.relatedLayer.objectIdField]);const H=t&&null!==e&&""!==e,G=null!=n;return new m.Z(H||G?q:[],H||G?[]:q,S,null)})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){let h="",l=!1;const S=i._layer.nativeCapabilities();null!==r&&S&&S.capabilities.queryRelated&&!0===S.capabilities.queryRelated.supportsOrderBy&&(h=r.constructClause(),l=!0),yield i.databaseType();let Z=i._maxQueryRate();const L=S.capabilities.query.maxRecordCount;void 0!==L&&L<Z&&(Z=L);const B=t&&null!==e&&""!==e,z=null!=n;let q=null,H=!0;!0===i._removeGeometry&&(H=!1);const G=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map(J=>J.name):["*"]);return q=new m.Z(B||z?["GETPAGES"]:[],B||z?[]:["GETPAGES"],l,{outFields:G.join(","),resultRecordCount:Z,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:h,returnGeometry:H,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),yield i._expandPagedSet(q,Z,0,0,d),q})()}_expandPagedSet(e,t,n,r,d){return this._expandPagedSetFeatureSet(e,t,n,r,d)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){const d=e.pagesDefinition.internal.lastRetrieved,i=d,h=e.pagesDefinition.internal.lastPage,l=r._layer.nativeCapabilities(),S=new Se.Z;!0===r._requestStandardised&&(S.sqlFormat="standard"),S.relationshipId=r.relationship.id,S.objectIds=e.pagesDefinition.objectIds,S.resultOffset=e.pagesDefinition.internal.lastPage,S.resultRecordCount=e.pagesDefinition.resultRecordCount,S.outFields=e.pagesDefinition.outFields.split(","),S.where=e.pagesDefinition.where,S.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,S.returnGeometry=e.pagesDefinition.returnGeometry,S.outSpatialReference=r.spatialReference;const y=yield l.source.queryRelatedFeatures(S);if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==h)return 0;const Z=y[r._findObjectId]?y[r._findObjectId].features:[];for(let B=0;B<Z.length;B++)e.pagesDefinition.internal.set[i+B]=Z[B].attributes[r.relatedLayer.objectIdField];for(let B=0;B<Z.length;B++)r._featureCache[Z[B].attributes[r.relatedLayer.objectIdField]]=Z[B];return Z.length!==e.pagesDefinition.resultRecordCount&&(!y[r._findObjectId]||!1===y[r._findObjectId].exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=d+Z.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,Z.length})()}_getFeatures(e,t,n,r){var d=this;return(0,F.Z)(function*(){const i=[];-1!==t&&void 0===d._featureCache[t]&&i.push(t);const h=d._maxQueryRate();if(!0===d._checkIfNeedToExpandKnownPage(e,h))return yield d._expandPagedSet(e,h,0,0,r),d._getFeatures(e,t,n,r);let l=0;for(let S=e._lastFetchedIndex;S<e._known.length&&(l++,l<=n&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[S]&&void 0===d._featureCache[e._known[S]]&&(e._known[S]!==t&&i.push(e._known[S]),i.length>n)))&&!(l>=n&&0===i.length);S++);if(0===i.length)return"success";throw new Error("Unaccounted for Features. Not in Feature Collection")})()}_refineSetBlock(e,t,n){return(0,F.Z)(function*(){return e})()}_stat(e,t,n,r,d,i,h){return(0,F.Z)(function*(){return{calculated:!1}})()}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,t,n,r,d){return(0,F.Z)(function*(){return!1})()}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(e,t,n,r,d){return this.relatedLayer.queryAttachments(e,t,n,r,d)}getFeatureByObjectId(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this.relatedLayer}}var V=g(53791),Ae=g(84687),Ze=g(55463);function Le(){null===V.Z.applicationCache&&(V.Z.applicationCache=new V.Z)}function se(b,e){return ae.apply(this,arguments)}function ae(){return(ae=(0,F.Z)(function*(b,e){if(V.Z.applicationCache){const t=V.Z.applicationCache.getLayerInfo(b);if(t){const d=yield t;return new k.default({url:b,outFields:e,sourceJSON:d})}const n=new k.default({url:b,outFields:e}),r=(0,F.Z)(function*(){return yield n.load(),n.sourceJSON})();if(V.Z.applicationCache){V.Z.applicationCache.setLayerInfo(b,r);try{return yield r,n}catch(d){throw V.Z.applicationCache.clearLayerInfo(b),d}}return yield r,n}return new k.default({url:b,outFields:e})})).apply(this,arguments)}function le(b,e,t,n,r){return oe.apply(this,arguments)}function oe(){return(oe=(0,F.Z)(function*(b,e,t,n,r,d=null){return re(yield se(b,["*"]),e,t,n,r,d)})).apply(this,arguments)}function re(b,e=null,t=null,n=!0,r=null,d=null){return!0===b._hasMemorySource()?new Pe.Z({layer:b,spatialReference:e,outFields:t,includeGeometry:n,lrucache:r,interceptor:d}):new ie({layer:b,spatialReference:e,outFields:t,includeGeometry:n,lrucache:r,interceptor:d})}function je(b){return ue.apply(this,arguments)}function ue(){return(ue=(0,F.Z)(function*(b){if(null!==V.Z.applicationCache){const t=V.Z.applicationCache.getLayerInfo(b);if(null!==t)return t}const e=(0,F.Z)(function*(){const t=yield(0,W.default)(b,{responseType:"json",query:{f:"json"}});return t.data?t.data:null})();if(null!==V.Z.applicationCache){V.Z.applicationCache.setLayerInfo(b,e);try{return yield e}catch(t){throw V.Z.applicationCache.clearLayerInfo(b),t}}return e})).apply(this,arguments)}function Ne(b,e){return de.apply(this,arguments)}function de(){return(de=(0,F.Z)(function*(b,e){const t="QUERYDATAELEMTS:"+e.toString()+":"+b;if(null!==V.Z.applicationCache){const r=V.Z.applicationCache.getLayerInfo(t);if(null!==r)return r}const n=(0,F.Z)(function*(){const r=yield(0,W.default)(b+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}});if(r.data){const d=r.data;if(d.layerDataElements&&d.layerDataElements[0])return d.layerDataElements[0]}throw new Error("Not Found")})();if(null!==V.Z.applicationCache){V.Z.applicationCache.setLayerInfo(t,n);try{return yield n}catch(r){throw V.Z.applicationCache.clearLayerInfo(t),r}}return n})).apply(this,arguments)}function Ie(b){return ce.apply(this,arguments)}function ce(){return(ce=(0,F.Z)(function*(b){if(null!==V.Z.applicationCache){const t=V.Z.applicationCache.getLayerInfo(b);if(null!==t)return t}const e=(0,F.Z)(function*(){const t=yield(0,W.default)(b,{responseType:"json",query:{f:"json"}});if(t.data){const n=t.data;return n.layers||(n.layers=[]),n.tables||(n.tables=[]),n}return{layers:[],tables:[]}})();if(null!==V.Z.applicationCache){V.Z.applicationCache.setLayerInfo(b,e);try{return yield e}catch(t){throw V.Z.applicationCache.clearLayerInfo(b),t}}return e})).apply(this,arguments)}function Be(b,e){return he.apply(this,arguments)}function he(){return(he=(0,F.Z)(function*(b,e){const t={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},n=yield Ie(b);if(t.metadata=n,n.controllerDatasetLayers&&null!=n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers)for(const i of n.layers)t.layerNameLkp[i.id]=i.name;if(n.tables)for(const i of n.tables)t.layerNameLkp[i.id]=i.name;const r=n.controllerDatasetLayers.utilityNetworkLayerId;t.networkId=r;const d=yield Ne(b,r);if(d){t.queryelem=d,t.queryelem&&t.queryelem.dataElement&&void 0!==t.queryelem.dataElement.schemaGeneration&&(t.unVersion=t.queryelem.dataElement.schemaGeneration),t.lkp={},t.queryelem.dataElement.domainNetworks||(t.queryelem.dataElement.domainNetworks=[]);for(const h of t.queryelem.dataElement.domainNetworks){for(const l of h.edgeSources?h.edgeSources:[]){const S={layerId:l.layerId,sourceId:l.sourceId,className:t.layerNameLkp[l.layerId]?t.layerNameLkp[l.layerId]:null};S.className&&(t.lkp[S.className]=S)}for(const l of h.junctionSources?h.junctionSources:[]){const S={layerId:l.layerId,sourceId:l.sourceId,className:t.layerNameLkp[l.layerId]?t.layerNameLkp[l.layerId]:null};S.className&&(t.lkp[S.className]=S)}}if(t.queryelem.dataElement.terminalConfigurations)for(const h of t.queryelem.dataElement.terminalConfigurations)for(const l of h.terminals)t.terminals.push({terminalId:l.terminalId,terminalName:l.terminalName});const i=yield je(b+"/"+r);if(i.systemLayers&&null!=i.systemLayers.associationsTableId){const h=[];t.unVersion>=4&&(h.push("STATUS"),h.push("PERCENTALONG"));let l=yield le(b+"/"+i.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...h],!1,null,null);return yield l.load(),t.unVersion>=4&&(l=l.filter(I.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",l.getFieldsIndex())),yield l.load()),{lkp:t.lkp,associations:l,unVersion:t.unVersion,terminals:t.terminals}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})).apply(this,arguments)}function ke(b,e,t){return fe.apply(this,arguments)}function fe(){return(fe=(0,F.Z)(function*(b,e,t,n=null,r=null,d=!0,i=null,h=null){let l=b.serviceUrl();if(!l)return null;l="/"===l.charAt(l.length-1)?l+e.relatedTableId.toString():l+"/"+e.relatedTableId.toString();const S=yield le(l,n,r,d,i,h);return new Oe({layer:b,relatedLayer:S,relationship:e,objectId:t,spatialReference:n,outFields:r,includeGeometry:d,lrucache:i,interceptor:h})})).apply(this,arguments)}A.Z.registerAction(),N.registerAction(),T.Z.registerAction(),M.Z.registerAction(),O.Z.registerAction();class Ue extends R.Z{constructor(e,t=null,n=null,r=null){super(),this._map=e,this._overridespref=t,this.lrucache=n,this.interceptor=r,this._instantLayers=[]}_makeAndAddFeatureSet(e,t=!0,n=null){const r=re(e,this._overridespref,null===n?["*"]:n,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}featureSetByName(e,t=!0,n=null){var r=this;return(0,F.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetByName(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const d=JSON.stringify(n);for(let h=0;h<r._instantLayers.length;h++){const l=r._instantLayers[h];if(l.opitem.title===e&&l.includeGeometry===t&&l.outFields===d)return r._instantLayers[h].featureset}const i=r._map.allLayers.find(h=>h instanceof k.default&&h.title===e);if(i)return r._makeAndAddFeatureSet(i,t,n);if(r._map.tables){const h=r._map.tables.find(l=>!!(l.title&&l.title===e||l.title&&l.title===e));if(h){if(h instanceof k.default)return r._makeAndAddFeatureSet(h,t,n);if(!h._materializedTable){const l=h.outFields?h:ge(ne({},h),{outFields:["*"]});h._materializedTable=new k.default(l)}return yield h._materializedTable.load(),r._makeAndAddFeatureSet(h._materializedTable,t,n)}}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,F.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetById(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const d=JSON.stringify(n);for(let h=0;h<r._instantLayers.length;h++){const l=r._instantLayers[h];if(l.opitem.id===e&&l.includeGeometry===t&&l.outFields===d)return r._instantLayers[h].featureset}const i=r._map.allLayers.find(h=>h instanceof k.default&&h.id===e);if(i)return r._makeAndAddFeatureSet(i,t,n);if(r._map.tables){const h=r._map.tables.find(l=>l.id===e);if(h){if(h instanceof k.default)return r._makeAndAddFeatureSet(h,t,n);if(!h._materializedTable){const l=ge(ne({},h),{outFields:["*"]});h._materializedTable=new k.default(l)}return yield h._materializedTable.load(),r._makeAndAddFeatureSet(h._materializedTable,t,n)}}return null})()}}class _e extends R.Z{constructor(e,t=null,n=null,r=null){super(),this._url=e,this._overridespref=t,this.lrucache=n,this.interceptor=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,t=!0,n=null){const r=re(e,this._overridespref,null===n?["*"]:n,t,this.lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}_loadMetaData(){var e=this;return(0,F.Z)(function*(){const t=yield Ie(e._url);return e.metadata=t,t})()}load(){return this._loadMetaData()}clone(){return new _e(this._url,this._overridespref,this.lrucache,this.interceptor)}featureSetByName(e,t=!0,n=null){var r=this;return(0,F.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const d=JSON.stringify(n);for(let l=0;l<r._instantLayers.length;l++){const S=r._instantLayers[l];if(S.opitem.title===e&&S.includeGeometry===t&&S.outFields===d)return r._instantLayers[l].featureset}const i=yield r._loadMetaData();let h=null;for(const l of i.layers?i.layers:[])l.name===e&&(h=l);if(!h)for(const l of i.tables?i.tables:[])l.name===e&&(h=l);if(h){const l=yield se(r._url+"/"+h.id,["*"]);return r._makeAndAddFeatureSet(l,t,n)}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,F.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const d=JSON.stringify(n);e=null!=e?e.toString():"";for(let l=0;l<r._instantLayers.length;l++){const S=r._instantLayers[l];if(S.opitem.id===e&&S.includeGeometry===t&&S.outFields===d)return r._instantLayers[l].featureset}const i=yield r._loadMetaData();let h=null;for(const l of i.layers?i.layers:[])null!=l.id&&l.id.toString()===e&&(h=l);if(!h)for(const l of i.tables?i.tables:[])null!=l.id&&l.id.toString()===e&&(h=l);if(h){const l=yield se(r._url+"/"+h.id,["*"]);return r._makeAndAddFeatureSet(l,t,n)}return null})()}}function Me(b,e,t=null,n=null){return new Ue(b,e,t,n)}function We(b,e,t=null,n=null){return new _e(b,e,t,n)}function Ge(b,e){return null===b?e:new Ae.Z({url:b.field("url")})}function Ke(b,e,t){return pe.apply(this,arguments)}function pe(){return(pe=(0,F.Z)(function*(b,e,t){if(!Q.id.findCredential(b.restUrl))return null;if("loaded"===b.loadStatus&&""===e&&b.user&&b.user.sourceJSON&&!1===t)return b.user.sourceJSON;if(""===e){const r=yield(0,W.default)(b.restUrl+"/community/self",{responseType:"json",query:ne({f:"json"},!1===t?{}:{returnUserLicenseTypeExtensions:!0})});if(r.data){const d=r.data;if(d&&d.username)return d}return null}const n=yield(0,W.default)(b.restUrl+"/community/users/"+e,{responseType:"json",query:{f:"json"}});if(n.data){const r=n.data;return r.error?null:r}return null})).apply(this,arguments)}function Qe(b,e,t,n,r){if(null===b)return null;if(b instanceof k.default){switch(e){case"datasource":return re(b,r,b.outFields,!0,t,n).getDataSourceFeatureSet();case"parent":case"root":return re(b,r,b.outFields,!0,t,n)}return null}if(b instanceof P.Z)switch(e){case"datasource":return b.getDataSourceFeatureSet();case"parent":return b;case"root":return b.getRootFeatureSet()}return null}function Ve(b,e,t,n,r,d,i){return ye.apply(this,arguments)}function ye(){return(ye=(0,F.Z)(function*(b,e,t,n,r,d,i,h=null){if(V.Z.applicationCache){const S=V.Z.applicationCache.getLayerInfo(b+":"+d.url);if(S){const y=yield S;return re(new k.default({url:(0,D.US)(y.url)+"/"+e,outFields:["*"]}),t,n,r,i,h)}}const l=new Ze.default({id:b,portal:d}).load();V.Z.applicationCache&&V.Z.applicationCache.setLayerInfo(b+":"+d.url,l);try{const S=yield l;return re(new k.default({url:(0,D.US)(S.url)+"/"+e,outFields:["*"]}),t,n,r,i,h)}catch(S){throw V.Z.applicationCache&&V.Z.applicationCache.clearLayerInfo(b+":"+d.url),S}})).apply(this,arguments)}},52724:(X,K,g)=>{g.d(K,{$X:()=>m,QP:()=>p,TO:()=>D,Xx:()=>E,yN:()=>f});var F=g(15861),Q=g(88879),W=g(27187),R=g(49086),A=g(91510),j=g(77132),C=g(83947),v=g(10410),T=g(65234);class P{constructor(o){this.field=o,this.sqlRewritable=!1}postInitialization(o,s){}}class m extends P{constructor(o){super(o),this.sqlRewritable=!0}extractValue(o){return o.attributes[this.field.name]}rewriteSql(o){return{rewritten:this.sqlRewritable,where:o}}}class p extends P{constructor(o,s,a){super((0,j.JW)(o)),this.originalField=o,this.sqlRewritable=!0,this.field.name=s,this.field.alias=a}rewriteSql(o,s){return{rewritten:this.sqlRewritable,where:(0,C.bB)(o,this.field.name,this.originalField.name,s.getFieldsIndex())}}extractValue(o){return o.attributes[this.originalField.name]}}let D=(()=>{class I extends P{constructor(s,a,u){super(s),this.codefield=a,this.lkp=u,this.reverseLkp={};for(const _ in u)this.reverseLkp[u[_]]=_;this.sqlRewritable=!0}rewriteSql(s,a){const u=this.evaluateNodeToWhereClause(s.parseTree,j.Bj.Standardised,this.field.name,this.codefield instanceof v.WhereClause?(0,C.zR)(this.codefield,j.Bj.Standardised):this.codefield,s.parameters);return u.includes(I.BADNESS)?{rewritten:!1,where:s}:{rewritten:this.sqlRewritable,where:v.WhereClause.create(u,a._parent.getFieldsIndex())}}evaluateNodeToWhereClause(s,a,u=null,_=null,c){let w,N,M,O;switch(s.type){case"interval":return(0,C.TE)(this.evaluateNodeToWhereClause(s.value,a,u,_,c),s.qualifier,s.op);case"case-expression":{let x=" CASE ";"simple"===s.format&&(x+=this.evaluateNodeToWhereClause(s.operand,a,u,I.BADNESS,c));for(let U=0;U<s.clauses.length;U++)x+=" WHEN "+this.evaluateNodeToWhereClause(s.clauses[U].operand,a,u,I.BADNESS,c)+" THEN "+this.evaluateNodeToWhereClause(s.clauses[U].value,a,u,I.BADNESS,c);return null!==s.else&&(x+=" ELSE "+this.evaluateNodeToWhereClause(s.else,a,u,I.BADNESS,c)),x+=" END ",x}case"parameter":{const x=c[s.value.toLowerCase()];if("string"==typeof x)return"'"+c[s.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(x instanceof Date)return(0,C.oX)(x,a);if(x instanceof Array){const U=[];for(let k=0;k<x.length;k++)"string"==typeof x[k]?U.push("'"+x[k].toString().replace(/'/g,"''")+"'"):x[k]instanceof Date?U.push((0,C.oX)(x[k],a)):U.push(x[k].toString());return U}return x.toString()}case"expression-list":N=[];for(const x of s.value)N.push(this.evaluateNodeToWhereClause(x,a,u,_,c));return N;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(s.expr,a,u,I.BADNESS,c)+" ) ";case"binary-expression":switch(s.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" AND "+this.evaluateNodeToWhereClause(s.right,a,u,_,c)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" OR "+this.evaluateNodeToWhereClause(s.right,a,u,_,c)+") ";case"IS":if("null"!==s.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" IS NULL )";case"ISNOT":if("null"!==s.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" IS NOT NULL )";case"IN":if(w=[],"expression-list"===s.right.type){if("column-reference"===s.left.type&&s.left.column.toUpperCase()===this.field.name.toUpperCase()){const x=[];let U=!0;for(const k of s.right.value){if("string"!==k.type){U=!1;break}if(void 0===this.lkp[k.value]){U=!1;break}x.push(this.lkp[k.value].toString())}if(U)return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" IN ("+x.join(",")+")) "}return w=this.evaluateNodeToWhereClause(s.right,a,u,_,c)," ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" IN ("+w.join(",")+")) "}return O=this.evaluateNodeToWhereClause(s.right,a,u,_,c),O instanceof Array?" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" IN ("+O.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" IN ("+O+")) ";case"NOT IN":if(w=[],"expression-list"===s.right.type){if("column-reference"===s.left.type&&s.left.column.toUpperCase()===this.field.name.toUpperCase()){const x=[];let U=!0;for(const k of s.right.value){if("string"!==k.type){U=!1;break}if(void 0===this.lkp[k.value]){U=!1;break}x.push(this.lkp[k.value].toString())}if(U)return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" NOT IN ("+x.join(",")+")) "}return w=this.evaluateNodeToWhereClause(s.right,a,u,_,c)," ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" NOT IN ("+w.join(",")+")) "}return O=this.evaluateNodeToWhereClause(s.right,a,u,_,c),O instanceof Array?" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" NOT IN ("+O.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,c)+" NOT IN ("+O+")) ";case"BETWEEN":return M=this.evaluateNodeToWhereClause(s.right,a,u,I.BADNESS,c)," ("+this.evaluateNodeToWhereClause(s.left,a,u,I.BADNESS,c)+" BETWEEN "+M[0]+" AND "+M[1]+" ) ";case"NOTBETWEEN":return M=this.evaluateNodeToWhereClause(s.right,a,u,I.BADNESS,c)," ("+this.evaluateNodeToWhereClause(s.left,a,u,I.BADNESS,c)+" NOT BETWEEN "+M[0]+" AND "+M[1]+" ) ";case"LIKE":return""!==s.escape?" ("+this.evaluateNodeToWhereClause(s.left,a,u,I.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(s.right,a,u,I.BADNESS,c)+" ESCAPE '"+s.escape+"') ":" ("+this.evaluateNodeToWhereClause(s.left,a,u,I.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(s.right,a,u,I.BADNESS,c)+") ";case"NOT LIKE":return""!==s.escape?" ("+this.evaluateNodeToWhereClause(s.left,a,u,I.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(s.right,a,u,I.BADNESS,c)+" ESCAPE '"+s.escape+"') ":" ("+this.evaluateNodeToWhereClause(s.left,a,u,I.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(s.right,a,u,I.BADNESS,c)+") ";case"<>":case"=":if("column-reference"===s.left.type&&"string"===s.right.type){if(s.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[s.right.value.toString()])return" ("+_+" "+s.operator+" "+this.lkp[s.right.value.toString()].toString()+") "}else if("column-reference"===s.right.type&&"string"===s.left.type&&s.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[s.right.value.toString()].toString()+" "+s.operator+" "+_+") ";return" ("+this.evaluateNodeToWhereClause(s.left,a,u,I.BADNESS,c)+" "+s.operator+" "+this.evaluateNodeToWhereClause(s.right,a,u,I.BADNESS,c)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(s.left,a,u,I.BADNESS,c)+" "+s.operator+" "+this.evaluateNodeToWhereClause(s.right,a,u,I.BADNESS,c)+") "}case"null":return"null";case"boolean":return!0===s.value?"1":"0";case"string":return"'"+s.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,C.oX)(s.value,a);case"number":return s.value.toString();case"current-time":return(0,C.vR)("date"===s.mode,a);case"column-reference":return u&&u.toLowerCase()===s.column.toLowerCase()?"("+_+")":s.column;case"function":{const x=this.evaluateNodeToWhereClause(s.args,a,u,I.BADNESS,c);return(0,C.fz)(s.name,x,a)}}throw new Error("Unsupported sql syntax "+s.type)}extractValue(s){return this.codefield instanceof v.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(s)]:this.reverseLkp[s.attributes[this.codefield]]}}return I.BADNESS="_!!!_BAD_LKP_!!!!",I})();class f extends P{constructor(o,s){super(o),this.sql=s}rewriteSql(o,s){return{rewritten:!0,where:(0,C.bB)(o,this.field.name,(0,C.zR)(this.sql,j.Bj.Standardised),s.getFieldsIndex())}}extractValue(o){return this.sql.calculateValueCompiled(o)}}class E extends R.Z{constructor(o){super(o),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=o.extraFilter,this._parent=o.parentfeatureset,this._maxProcessing=30,this.adaptedFields=o.adaptedFields}static findField(o,s){for(const a of o)if(a.name.toLowerCase()===s.toString().toLowerCase())return a;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new T.Z({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=j.Qk.point,this.typeIdField="",this.types=null),this.fields=[];for(const o of this.adaptedFields)o.postInitialization(this,this._parent),this.fields.push(o.field)}_getSet(o){var s=this;return(0,F.Z)(function*(){if(null===s._wset){yield s._ensureLoaded();let a=null;return a=s._extraFilter?yield s._getFilteredSet("",null,null,null,o):yield s._parent._getSet(o),s._checkCancelled(o),s._wset=new A.Z(a._candidates.slice(0),a._known.slice(0),a._ordered,s._clonePageDefinition(a.pagesDefinition)),s._wset}return s._wset})()}_isInFeatureSet(o){return this._parent._isInFeatureSet(o)}_getFeatures(o,s,a,u){var _=this;return(0,F.Z)(function*(){const c=[];-1!==s&&void 0===_._featureCache[s]&&c.push(s);const w=_._maxQueryRate();if(!0===_._checkIfNeedToExpandKnownPage(o,w))return yield _._expandPagedSet(o,w,0,0,u),_._getFeatures(o,s,a,u);let N=0;for(let x=o._lastFetchedIndex;x<o._known.length&&(N++,N<=a&&(o._lastFetchedIndex+=1),!(void 0===_._featureCache[o._known[x]]&&(o._known[x]!==s&&c.push(o._known[x]),c.length>=w)));x++);if(0===c.length)return"success";o=new A.Z([],c,o._ordered,null);const M=Math.min(c.length,a);yield _._parent._getFeatures(o,-1,M,u),_._checkCancelled(u);const O=[];for(let x=0;x<M;x++){const U=_._parent._featureFromCache(c[x]);void 0!==U&&O.push({geometry:U.geometry,attributes:U.attributes,id:c[x]})}for(const x of O){const U=[];for(const k of _.adaptedFields)U[k.field.name]=k.extractValue(x);_._featureCache[x.id]=new Q.Z({attributes:U,geometry:(0,W.r1)(x.geometry)})}return"success"})()}_fetchAndRefineFeatures(){return(0,F.Z)(function*(){throw new Error("Fetch and Refine should not be called in this featureset")})()}_getFilteredSet(o,s,a,u,_){var c=this;return(0,F.Z)(function*(){let w=!1;const N=c._reformulateWithoutAdaptions(a);w=N.cannot,a=N.where;let M=!1;if(null!==u){M=!0;const U=[];for(const k of c.adaptedFields)if(!(k instanceof m)&&!0===u.scanForField(k.field.name)){if(!(k instanceof p)){u=null,M=!1;break}U.push({field:k.field.name,newfield:k.originalField.name})}u&&U.length>0&&(u=u.replaceFields(U))}null!==a?null!==c._extraFilter&&(a=(0,C.$e)(c._extraFilter,a)):a=c._extraFilter,yield c._ensureLoaded();const O=yield c._parent._getFilteredSet(o,s,a,u,_);let x;return c._checkCancelled(_),x=!0===w?new A.Z(O._candidates.slice(0).concat(O._known.slice(0)),[],!0===M&&O._ordered,c._clonePageDefinition(O.pagesDefinition)):new A.Z(O._candidates.slice(0),O._known.slice(0),!0===M&&O._ordered,c._clonePageDefinition(O.pagesDefinition)),x})()}_reformulateWithoutAdaptions(o){const s={cannot:!1,where:o};if(null!==o)for(const a of this.adaptedFields)if(!0===(0,C.hq)(o,a.field.name)){const u=a.rewriteSql(o,this);if(!0!==u.rewritten){s.cannot=!0,s.where=null;break}s.where=u.where}return s}_stat(o,s,a,u,_,c,w){var N=this;return(0,F.Z)(function*(){let M=!1,O=N._reformulateWithoutAdaptions(s);if(M=O.cannot,s=O.where,O=N._reformulateWithoutAdaptions(_),M=M||O.cannot,null!==(_=O.where)?null!==N._extraFilter&&(_=(0,C.$e)(N._extraFilter,_)):_=N._extraFilter,!0===M)return null===_&&""===a&&null===u?N._manualStat(o,s,c,w):{calculated:!1};const x=yield N._parent._stat(o,s,a,u,_,c,w);return!1===x.calculated?null===_&&""===a&&null===u?N._manualStat(o,s,c,w):{calculated:!1}:x})()}_canDoAggregates(o,s,a,u,_){var c=this;return(0,F.Z)(function*(){if(null===c._parent)return!1;for(let M=0;M<o.length;M++)for(const O of c.adaptedFields)if(o[M].toLowerCase()===O.field.name.toLowerCase()&&!(O instanceof m))return!1;const w=[];for(let M=0;M<s.length;M++){const O=s[M];if(null!==O.workingexpr){const x=c._reformulateWithoutAdaptions(O.workingexpr);if(x.cannot)return!1;const U=O.clone();U.workingexpr=x.where,w.push(U)}else w.push(O)}const N=c._reformulateWithoutAdaptions(_);return!N.cannot&&(null!==(_=N.where)?null!==c._extraFilter&&(_=(0,C.$e)(c._extraFilter,_)):_=c._extraFilter,c._parent._canDoAggregates(o,w,a,u,_))})()}_getAggregatePagesDataSourceDefinition(o,s,a,u,_,c,w){var N=this;return(0,F.Z)(function*(){if(null===N._parent)throw new Error("Should never be called");const M=[];for(let x=0;x<s.length;x++){const U=s[x];if(null!==U.workingexpr){const k=N._reformulateWithoutAdaptions(U.workingexpr);if(k.cannot)throw new Error("Should never be called");const te=U.clone();te.workingexpr=k.where,M.push(te)}else M.push(U)}const O=N._reformulateWithoutAdaptions(_);if(O.cannot)throw new Error("Should never be called");return null!==(_=O.where)?null!==N._extraFilter&&(_=(0,C.$e)(N._extraFilter,_)):_=N._extraFilter,N._parent._getAggregatePagesDataSourceDefinition(o,M,a,u,_,c,w)})()}}},53997:(X,K,g)=>{g.d(K,{Z:()=>T});var F=g(15861),Q=g(49086),W=g(91510),R=g(77132),A=g(83947),j=g(10699),C=g(10410),v=g(65234);class T extends Q.Z{constructor(m){super(m),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=m.parentfeatureset,m.whereclause instanceof C.WhereClause?(this._whereclause=m.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=m.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new v.Z({wkid:4326}),this.geometryType=R.Qk.point)}_getSet(m){var p=this;return(0,F.Z)(function*(){if(null===p._wset){yield p._ensureLoaded();const D=yield p._parent._getFilteredSet("",null,p._whereclause,null,m);return p._checkCancelled(m),p._wset=null!==p._whereClauseFunction?new W.Z(D._candidates.slice(0).concat(D._known.slice(0)),[],D._ordered,p._clonePageDefinition(D.pagesDefinition)):new W.Z(D._candidates.slice(0),D._known.slice(0),D._ordered,p._clonePageDefinition(D.pagesDefinition)),p._wset}return p._wset})()}_isInFeatureSet(m){let p=this._parent._isInFeatureSet(m);return p===R.dj.NotInFeatureSet?p:(p=this._idstates[m],void 0===p?R.dj.Unknown:p)}_getFeature(m,p,D){return this._parent._getFeature(m,p,D)}_getFeatures(m,p,D,f){return this._parent._getFeatures(m,p,D,f)}_featureFromCache(m){return this._parent._featureFromCache(m)}executeWhereClause(m){return this._whereclause.testFeature(m)}executeWhereClauseDeferred(m){var p=this;return(0,F.Z)(function*(){if(null!==p._whereClauseFunction){const D=p._whereClauseFunction(m);return(0,j.y8)(D),D}return p.executeWhereClause(m)})()}_fetchAndRefineFeatures(m,p,D){var f=this;return(0,F.Z)(function*(){const E=new W.Z([],m,!1,null),I=Math.min(p,m.length);if(yield f._parent._getFeatures(E,-1,I,D),f._checkCancelled(D),null==f._whereClauseFunction){for(let s=0;s<I;s++){const a=f._parent._featureFromCache(m[s]);f._idstates[m[s]]=!0===f.executeWhereClause(a)?R.dj.InFeatureSet:R.dj.NotInFeatureSet}return"success"}const o=[];for(let s=0;s<I;s++){const a=f._parent._featureFromCache(m[s]);o.push(yield f.executeWhereClauseDeferred(a))}for(let s=0;s<p;s++)f._idstates[m[s]]=!0===o[s]?R.dj.InFeatureSet:R.dj.NotInFeatureSet;return"success"})()}_getFilteredSet(m,p,D,f,E){var I=this;return(0,F.Z)(function*(){null!==I._whereClauseFunction||(null!==D?null!==I._whereclause&&(D=(0,A.$e)(I._whereclause,D)):D=I._whereclause),yield I._ensureLoaded();const o=yield I._parent._getFilteredSet(m,p,D,f,E);let s;return I._checkCancelled(E),s=null!==I._whereClauseFunction?new W.Z(o._candidates.slice(0).concat(o._known.slice(0)),[],o._ordered,I._clonePageDefinition(o.pagesDefinition)):new W.Z(o._candidates.slice(0),o._known.slice(0),o._ordered,I._clonePageDefinition(o.pagesDefinition)),s})()}_stat(m,p,D,f,E,I,o){var s=this;return(0,F.Z)(function*(){if(null!==s._whereClauseFunction)return null===E&&""===D&&null===f?s._manualStat(m,p,I,o):{calculated:!1};let a=s._whereclause;null!==E&&null!==s._whereclause&&(a=(0,A.$e)(s._whereclause,E));const u=yield s._parent._stat(m,p,D,f,a,I,o);return!1===u.calculated?null===E&&""===D&&null===f?s._manualStat(m,p,I,o):{calculated:!1}:u})()}_canDoAggregates(m,p,D,f,E){var I=this;return(0,F.Z)(function*(){return null===I._whereClauseFunction&&(null!==E?null!==I._whereclause&&(E=(0,A.$e)(I._whereclause,E)):E=I._whereclause,null!==I._parent&&I._parent._canDoAggregates(m,p,D,f,E))})()}_getAggregatePagesDataSourceDefinition(m,p,D,f,E,I,o){var s=this;return(0,F.Z)(function*(){if(null===s._parent)throw new Error("Should never be called");return null!==E?null!==s._whereclause&&(E=(0,A.$e)(s._whereclause,E)):E=s._whereclause,s._parent._getAggregatePagesDataSourceDefinition(m,p,D,f,E,I,o)})()}static registerAction(){Q.Z._featuresetFunctions.filter=function(m){if("function"==typeof m)return new T({parentfeatureset:this,whereclause:m});let p=null;return m instanceof C.WhereClause&&(p=m),new T({parentfeatureset:this,whereclause:p})}}}},95896:(X,K,g)=>{g.d(K,{Z:()=>j});var F=g(15861),Q=g(47562),W=g(49086),R=g(91510),A=g(57366);class j extends W.Z{constructor(v){super(v),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=v.orderbyclause,this._parent=v.parentfeatureset}_getSet(v){var T=this;return(0,F.Z)(function*(){if(null===T._wset){yield T._ensureLoaded();const P=yield T._getFilteredSet("",null,null,T._orderbyclause,v);return T._checkCancelled(v),T._wset=P,T._wset}return T._wset})()}manualOrderSet(v,T){var P=this;return(0,F.Z)(function*(){const m=yield P.getIdColumnDictionary(v,[],-1,T);P._orderbyclause.order(m);const p=new R.Z([],[],!0,null);for(let D=0;D<m.length;D++)p._known.push(m[D].id);return p})()}getIdColumnDictionary(v,T,P,m){var p=this;return(0,F.Z)(function*(){if(P<v._known.length-1){const D=p._maxQueryRate();if("GETPAGES"===v._known[P+1])return yield(0,Q.X)(p._parent._expandPagedSet(v,D,0,0,m)),p.getIdColumnDictionary(v,T,P,m);let f=P+1;const E=[];for(;f<v._known.length&&"GETPAGES"!==v._known[f];)E.push(v._known[f]),f++;P+=E.length;const I=yield(0,Q.X)(p._parent._getFeatureBatch(E,m));p._checkCancelled(m);for(const o of I)T.push({id:o.attributes[p.objectIdField],feature:o});return p.getIdColumnDictionary(v,T,P,m)}return v._candidates.length>0?(yield(0,Q.X)(p._refineSetBlock(v,p._maxProcessingRate(),m)),p._checkCancelled(m),p.getIdColumnDictionary(v,T,P,m)):T})()}_isInFeatureSet(v){return this._parent._isInFeatureSet(v)}_getFeatures(v,T,P,m){return this._parent._getFeatures(v,T,P,m)}_featureFromCache(v){if(void 0===this._featureCache[v]){const T=this._parent._featureFromCache(v);return void 0===T?void 0:null===T?null:(this._featureCache[v]=T,T)}return this._featureCache[v]}_fetchAndRefineFeatures(){return(0,F.Z)(function*(){throw new Error("Fetch and Refine should not be called in this featureset")})()}_getFilteredSet(v,T,P,m,p){var D=this;return(0,F.Z)(function*(){yield D._ensureLoaded();const f=yield D._parent._getFilteredSet(v,T,P,null===m?D._orderbyclause:m,p);D._checkCancelled(p);const E=new R.Z(f._candidates.slice(0),f._known.slice(0),f._ordered,D._clonePageDefinition(f.pagesDefinition));let I=!0;if(f._candidates.length>0&&(I=!1),!1===E._ordered){let o=yield D.manualOrderSet(E,p);return!1===I&&(null===T&&null===P||(o=new R.Z(o._candidates.slice(0).concat(o._known.slice(0)),[],o._ordered,D._clonePageDefinition(o.pagesDefinition)))),o}return E})()}static registerAction(){W.Z._featuresetFunctions.orderBy=function(v){return""===v?this:new j({parentfeatureset:this,orderbyclause:new A.Z(v)})}}}},79429:(X,K,g)=>{g.d(K,{Z:()=>A});var F=g(15861),Q=g(49086),W=g(91510),R=g(77132);class A extends Q.Z{constructor(C){super(C),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=C.topnum,this._parent=C.parentfeatureset}_getSet(C){var v=this;return(0,F.Z)(function*(){if(null===v._wset){yield v._ensureLoaded();const T=yield v._parent._getSet(C);return v._wset=new W.Z(T._candidates.slice(0),T._known.slice(0),!1,v._clonePageDefinition(T.pagesDefinition)),v._setKnownLength(v._wset)>v._topnum&&(v._wset._known=v._wset._known.slice(0,v._topnum)),v._setKnownLength(v._wset)>=v._topnum&&(v._wset._candidates=[]),v._wset}return v._wset})()}_setKnownLength(C){return C._known.length>0&&"GETPAGES"===C._known[C._known.length-1]?C._known.length-1:C._known.length}_isInFeatureSet(C){const v=this._parent._isInFeatureSet(C);if(v===R.dj.NotInFeatureSet)return v;const T=this._idstates[C];return T===R.dj.InFeatureSet||T===R.dj.NotInFeatureSet?T:v===R.dj.InFeatureSet&&void 0===T?this._countedin<this._topnum?(this._idstates[C]=R.dj.InFeatureSet,this._countedin++,R.dj.InFeatureSet):(this._idstates[C]=R.dj.NotInFeatureSet,R.dj.NotInFeatureSet):R.dj.Unknown}_expandPagedSet(C,v,T,P,m){var p=this;return(0,F.Z)(function*(){if(null===p._parent)throw new Error("Parent Paging not implemented");if(v>p._topnum&&(v=p._topnum),p._countedin>=p._topnum&&C.pagesDefinition.internal.set.length<=C.pagesDefinition.resultOffset){let f=C._known.length;return f>0&&"GETPAGES"===C._known[f-1]&&(C._known.length=f-1),f=C._candidates.length,f>0&&"GETPAGES"===C._candidates[f-1]&&(C._candidates.length=f-1),"success"}const D=yield p._parent._expandPagedSet(C,v,T,P,m);return p._setKnownLength(C)>p._topnum&&(C._known.length=p._topnum),p._setKnownLength(C)>=p._topnum&&(C._candidates.length=0),D})()}_getFeatures(C,v,T,P){var m=this;return(0,F.Z)(function*(){const p=[],D=m._maxQueryRate();if(!0===m._checkIfNeedToExpandKnownPage(C,D))return yield m._expandPagedSet(C,D,0,0,P),m._getFeatures(C,v,T,P);-1!==v&&void 0===m._featureCache[v]&&p.push(v);let f=0;for(let o=C._lastFetchedIndex;o<C._known.length&&(f++,f<=T&&(C._lastFetchedIndex+=1),!(void 0===m._featureCache[C._known[o]]&&(C._known[o]!==v&&p.push(C._known[o]),p.length>D)));o++);if(0===p.length)return"success";const E=new W.Z([],p,!1,null),I=Math.min(p.length,T);yield m._parent._getFeatures(E,-1,I,P);for(let o=0;o<I;o++){const s=m._parent._featureFromCache(p[o]);void 0!==s&&(m._featureCache[p[o]]=s)}return"success"})()}_getFilteredSet(C,v,T,P,m){var p=this;return(0,F.Z)(function*(){yield p._ensureLoaded();const D=yield p._getSet(m);return new W.Z(D._candidates.slice(0).concat(D._known.slice(0)),[],!1,p._clonePageDefinition(D.pagesDefinition))})()}_refineKnowns(C,v){let T=0,P=null;const m=[];for(let p=0;p<C._candidates.length;p++){const D=this._isInFeatureSet(C._candidates[p]);if(D===R.dj.InFeatureSet){if(C._known.push(C._candidates[p]),T+=1,null===P?P={start:p,end:p}:P.end===p-1?P.end=p:(m.push(P),P={start:p,end:p}),C._known.length>=this._topnum)break}else if(D===R.dj.NotInFeatureSet)null===P?P={start:p,end:p}:P.end===p-1?P.end=p:(m.push(P),P={start:p,end:p}),T+=1;else if(D===R.dj.Unknown)break;if(T>=v)break}null!==P&&m.push(P);for(let p=m.length-1;p>=0;p--)C._candidates.splice(m[p].start,m[p].end-m[p].start+1);this._setKnownLength(C)>this._topnum&&(C._known=C._known.slice(0,this._topnum)),this._setKnownLength(C)>=this._topnum&&(C._candidates=[])}_stat(){return(0,F.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,F.Z)(function*(){return!1})()}static registerAction(){Q.Z._featuresetFunctions.top=function(C){return new A({parentfeatureset:this,topnum:C})}}}},16776:(X,K,g)=>{g.d(K,{Z:()=>p});var F=g(15861),Q=g(88879),W=g(49086),R=g(91510),A=g(77132),j=g(83947),C=g(21674),v=g(32258),T=g(41638),P=g(36255),m=g(84952);class p extends W.Z{constructor(f){super(f),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,f.spatialReference&&(this.spatialReference=f.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=f.layer,this._wset=null,!0===f.isTable&&(this._forceIsTable=!0),void 0!==f.outFields&&(this._overrideFields=f.outFields),void 0!==f.includeGeometry&&(this._removeGeometry=!1===f.includeGeometry)}_maxQueryRate(){return A.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var f=this;return(0,F.Z)(function*(){return!0===f._layer.loaded?(f._initialiseFeatureSet(),f):(yield f._layer.load(),f._initialiseFeatureSet(),f)})()}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const f=[];for(const E of this.fields)if("oid"===E.type)f.push(E);else for(const I of this._layer.outFields)if(I.toLowerCase()===E.name.toLowerCase()){f.push(E);break}this.fields=f}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const f=[],E=[];for(const I of this.fields)if("oid"===I.type)f.push(I),E.push(I.name);else for(const o of this._overrideFields)if(o.toLowerCase()===I.name.toLowerCase()){f.push(I),E.push(I.name);break}this.fields=f,this._overrideFields=E}this.objectIdField=this._layer.objectIdField;for(const f of this.fields)"global-id"===f.type&&(this.globalIdField=f.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=A.Bj.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return A.dj.InFeatureSet}_candidateIdTransform(f){return f}_getSet(f){var E=this;return(0,F.Z)(function*(){if(null===E._wset){yield E._ensureLoaded();const I=yield E._getFilteredSet("",null,null,null,f);return E._wset=I,I}return E._wset})()}_changeFeature(f){const E={};for(const I of this.fields)E[I.name]=f.attributes[I.name];return new Q.Z({geometry:!0===this._removeGeometry?null:f.geometry,attributes:E})}_getFilteredSet(f,E,I,o,s){var a=this;return(0,F.Z)(function*(){let u="",_=!1;if(null!==o&&(u=o.constructClause(),_=!0),a.isTable()&&E&&null!==f&&""!==f)return new R.Z([],[],!0,null);const c=new m.Z;c.where=null===I?null===E?"1=1":"":(0,j.zR)(I,A.Bj.Standardised),c.spatialRelationship=a._makeRelationshipEnum(f),c.outSpatialReference=a.spatialReference,c.orderByFields=""!==u?u.split(","):null,c.geometry=null===E?null:E,c.returnGeometry=!0,c.relationParameter=a._makeRelationshipParam(f);const w=yield a._layer.queryFeatures(c);if(null===w)return new R.Z([],[],_,null);a._checkCancelled(s);const N=[];return w.features.forEach(M=>{const O=M.attributes[a._layer.objectIdField];N.push(O),a._featureCache[O]=a._changeFeature(M)}),new R.Z([],N,_,null)})()}_makeRelationshipEnum(f){if(f.includes("esriSpatialRelRelation"))return"relation";switch(f){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return f}_makeRelationshipParam(f){return f.includes("esriSpatialRelRelation")?f.split(":")[1]:""}_queryAllFeatures(){var f=this;return(0,F.Z)(function*(){if(f._wset)return f._wset;const E=new m.Z;if(E.where="1=1",yield f._ensureLoaded(),f._layer.source&&f._layer.source.items){const s=[];return f._layer.source.items.forEach(a=>{const u=a.attributes[f._layer.objectIdField];s.push(u),f._featureCache[u]=f._changeFeature(a)}),f._wset=new R.Z([],s,!1,null),f._wset}const I=yield f._layer.queryFeatures(E),o=[];return I.features.forEach(s=>{const a=s.attributes[f._layer.objectIdField];o.push(a),f._featureCache[a]=f._changeFeature(s)}),f._wset=new R.Z([],o,!1,null),f._wset})()}_getFeatures(f,E,I){var o=this;return(0,F.Z)(function*(){const s=[];-1!==E&&void 0===o._featureCache[E]&&s.push(E);for(let a=f._lastFetchedIndex;a<f._known.length&&(f._lastFetchedIndex+=1,!(void 0===o._featureCache[f._known[a]]&&(f._known[a]!==E&&s.push(f._known[a]),s.length>I)));a++);if(0===s.length)return"success";throw new Error("Unaccounted for Features. Not in Feature Collection")})()}_refineSetBlock(f){return(0,F.Z)(function*(){return f})()}_stat(){return(0,F.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,F.Z)(function*(){return!1})()}relationshipMetaData(){return[]}static _cloneAttr(f){const E={};for(const I in f)E[I]=f[I];return E}nativeCapabilities(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(f,E){let I=f.layerDefinition.objectIdField;const o=f.layerDefinition.typeIdField?f.layerDefinition.typeIdField:"",s=[];if(f.layerDefinition.types)for(const O of f.layerDefinition.types)s.push(T.Z.fromJSON(O));let a=f.layerDefinition.geometryType;void 0===a&&(a=f.featureSet.geometryType||"");let u=f.featureSet.features;const _=E.toJSON();if(""===I||void 0===I){let O=!1;for(const x of f.layerDefinition.fields)if("oid"===x.type||"esriFieldTypeOID"===x.type){I=x.name,O=!0;break}if(!1===O){let x="FID",U=!0,k=0;for(;U;){let $=!0;for(const me of f.layerDefinition.fields)if(me.name===x){$=!1;break}!0===$?U=!1:(k++,x="FID"+k.toString())}f.layerDefinition.fields.push({type:"esriFieldTypeOID",name:x,alias:x});const te=[];for(let $=0;$<u.length;$++)te.push({geometry:f.featureSet.features[$].geometry,attributes:f.featureSet.features[$].attributes?this._cloneAttr(f.featureSet.features[$].attributes):{}}),te[$].attributes[x]=$;u=te,I=x}}const c=[];for(const O of f.layerDefinition.fields)c.push(O instanceof P.Z?O:P.Z.fromJSON(O));let w=a;switch(w){case"esriGeometryPoint":w="point";break;case"esriGeometryPolyline":w="polyline";break;case"esriGeometryPolygon":w="polygon";break;case"esriGeometryExtent":w="extent";break;case"esriGeometryMultipoint":w="multipoint"}for(const O of u)O.geometry&&!(O.geometry instanceof C.Z)&&(O.geometry.type=w,void 0===O.geometry.spatialReference&&(O.geometry.spatialReference=_));const N={outFields:["*"],source:u,fields:c,types:s,typeIdField:o,objectIdField:I,spatialReference:E};N.geometryType=w||"point";const M=new v.default(N);return new p({layer:M,spatialReference:E,isTable:null===w||""===w})}queryAttachments(){return(0,F.Z)(function*(){return[]})()}getFeatureByObjectId(f){var E=this;return(0,F.Z)(function*(){const I=new m.Z;I.where=E.objectIdField+"="+f.toString();const o=yield E._layer.queryFeatures(I);return 1===o.features.length?o.features[0]:null})()}getOwningSystemUrl(){return(0,F.Z)(function*(){return""})()}getIdentityUser(){return(0,F.Z)(function*(){return""})()}}},57366:(X,K,g)=>{function F(W,R){return W===R?0:null===W?-1:null===R?1:W<R?-1:1}g.d(K,{Z:()=>Q});class Q{constructor(R){const A=R.split(",");this._fields=[],this._directions=[];for(let j=0;j<A.length;j++){const C=A[j].match(/\S+/g);this._fields.push(C[0]),2===C.length?"asc"===C[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let R="";for(let A=0;A<this._fields.length;A++)0!==A&&(R+=","),R+=this._fields[A],R+=1===this._directions[A]?" ASC":" DESC";return R}order(R){R.sort((A,j)=>{for(let C=0;C<this._fields.length;C++){const v=this.featureValue(A.feature,this._fields[C],C),T=this.featureValue(j.feature,this._fields[C],C);let P=0;if(P=1===this._directions[C]?F(v,T):-1*F(v,T),0!==P)return P}return 0})}scanForField(R){for(let A=0;A<this._fields.length;A++)if(this._fields[A].toLowerCase().trim()===R.toLowerCase().trim())return!0;return!1}replaceFields(R){let A="";for(let j=0;j<this._fields.length;j++){0!==j&&(A+=",");let C=this._fields[j];for(const v of R)if(C.toLowerCase()===v.field.toLowerCase()){C=v.newfield;break}A+=C,A+=1===this._directions[j]?" ASC":" DESC"}return new Q(A)}featureValue(R,A,j){const C=R.attributes[A];if(void 0!==C)return C;for(const v in R.attributes)if(A.toLowerCase()===v.toLowerCase())return this._fields[j]=v,R.attributes[v];return null}}},50011:(X,K,g)=>{g.d(K,{F:()=>I,M:()=>F});const F={Base64:0,Hex:1,String:2,Raw:3};function R(o,s){const a=(65535&o)+(65535&s);return(o>>16)+(s>>16)+(a>>16)<<16|65535&a}function P(o,s,a,u,_,c){return R(function T(o,s){return o<<s|o>>>32-s}(R(R(s,o),R(u,c)),_),a)}function m(o,s,a,u,_,c,w){return P(s&a|~s&u,o,s,_,c,w)}function p(o,s,a,u,_,c,w){return P(s&u|a&~u,o,s,_,c,w)}function D(o,s,a,u,_,c,w){return P(s^a^u,o,s,_,c,w)}function f(o,s,a,u,_,c,w){return P(a^(s|~u),o,s,_,c,w)}function I(o,s=F.Hex){const a=s||F.Base64,u=function E(o,s){o[s>>5]|=128<<s%32,o[14+(s+64>>>9<<4)]=s;let a=1732584193,u=-271733879,_=-1732584194,c=271733878;for(let w=0;w<o.length;w+=16){const N=a,M=u,O=_,x=c;a=m(a,u,_,c,o[w+0],7,-680876936),c=m(c,a,u,_,o[w+1],12,-389564586),_=m(_,c,a,u,o[w+2],17,606105819),u=m(u,_,c,a,o[w+3],22,-1044525330),a=m(a,u,_,c,o[w+4],7,-176418897),c=m(c,a,u,_,o[w+5],12,1200080426),_=m(_,c,a,u,o[w+6],17,-1473231341),u=m(u,_,c,a,o[w+7],22,-45705983),a=m(a,u,_,c,o[w+8],7,1770035416),c=m(c,a,u,_,o[w+9],12,-1958414417),_=m(_,c,a,u,o[w+10],17,-42063),u=m(u,_,c,a,o[w+11],22,-1990404162),a=m(a,u,_,c,o[w+12],7,1804603682),c=m(c,a,u,_,o[w+13],12,-40341101),_=m(_,c,a,u,o[w+14],17,-1502002290),u=m(u,_,c,a,o[w+15],22,1236535329),a=p(a,u,_,c,o[w+1],5,-165796510),c=p(c,a,u,_,o[w+6],9,-1069501632),_=p(_,c,a,u,o[w+11],14,643717713),u=p(u,_,c,a,o[w+0],20,-373897302),a=p(a,u,_,c,o[w+5],5,-701558691),c=p(c,a,u,_,o[w+10],9,38016083),_=p(_,c,a,u,o[w+15],14,-660478335),u=p(u,_,c,a,o[w+4],20,-405537848),a=p(a,u,_,c,o[w+9],5,568446438),c=p(c,a,u,_,o[w+14],9,-1019803690),_=p(_,c,a,u,o[w+3],14,-187363961),u=p(u,_,c,a,o[w+8],20,1163531501),a=p(a,u,_,c,o[w+13],5,-1444681467),c=p(c,a,u,_,o[w+2],9,-51403784),_=p(_,c,a,u,o[w+7],14,1735328473),u=p(u,_,c,a,o[w+12],20,-1926607734),a=D(a,u,_,c,o[w+5],4,-378558),c=D(c,a,u,_,o[w+8],11,-2022574463),_=D(_,c,a,u,o[w+11],16,1839030562),u=D(u,_,c,a,o[w+14],23,-35309556),a=D(a,u,_,c,o[w+1],4,-1530992060),c=D(c,a,u,_,o[w+4],11,1272893353),_=D(_,c,a,u,o[w+7],16,-155497632),u=D(u,_,c,a,o[w+10],23,-1094730640),a=D(a,u,_,c,o[w+13],4,681279174),c=D(c,a,u,_,o[w+0],11,-358537222),_=D(_,c,a,u,o[w+3],16,-722521979),u=D(u,_,c,a,o[w+6],23,76029189),a=D(a,u,_,c,o[w+9],4,-640364487),c=D(c,a,u,_,o[w+12],11,-421815835),_=D(_,c,a,u,o[w+15],16,530742520),u=D(u,_,c,a,o[w+2],23,-995338651),a=f(a,u,_,c,o[w+0],6,-198630844),c=f(c,a,u,_,o[w+7],10,1126891415),_=f(_,c,a,u,o[w+14],15,-1416354905),u=f(u,_,c,a,o[w+5],21,-57434055),a=f(a,u,_,c,o[w+12],6,1700485571),c=f(c,a,u,_,o[w+3],10,-1894986606),_=f(_,c,a,u,o[w+10],15,-1051523),u=f(u,_,c,a,o[w+1],21,-2054922799),a=f(a,u,_,c,o[w+8],6,1873313359),c=f(c,a,u,_,o[w+15],10,-30611744),_=f(_,c,a,u,o[w+6],15,-1560198380),u=f(u,_,c,a,o[w+13],21,1309151649),a=f(a,u,_,c,o[w+4],6,-145523070),c=f(c,a,u,_,o[w+11],10,-1120210379),_=f(_,c,a,u,o[w+2],15,718787259),u=f(u,_,c,a,o[w+9],21,-343485551),a=R(a,N),u=R(u,M),_=R(_,O),c=R(c,x)}return[a,u,_,c]}(function A(o){const s=[];for(let a=0,u=8*o.length;a<u;a+=8)s[a>>5]|=(255&o.charCodeAt(a/8))<<a%32;return s}(o),8*o.length);switch(a){case F.Raw:return u;case F.Hex:return function C(o){const s="0123456789abcdef",a=[];for(let u=0,_=4*o.length;u<_;u++)a.push(s.charAt(o[u>>2]>>u%4*8+4&15)+s.charAt(o[u>>2]>>u%4*8&15));return a.join("")}(u);case F.String:return function j(o){const s=[];for(let a=0,u=32*o.length;a<u;a+=8)s.push(String.fromCharCode(o[a>>5]>>>a%32&255));return s.join("")}(u);case F.Base64:return function v(o){const u=[];for(let _=0,c=4*o.length;_<c;_+=3){const w=(o[_>>2]>>_%4*8&255)<<16|(o[_+1>>2]>>(_+1)%4*8&255)<<8|o[_+2>>2]>>(_+2)%4*8&255;for(let N=0;N<4;N++)u.push(8*_+6*N>32*o.length?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(w>>6*(3-N)&63))}return u.join("")}(u)}}},90463:(X,K,g)=>{g.d(K,{P:()=>A});var F=g(15861),Q=g(2618),W=g(20477),R=g(84952);function A(C,v,T){return j.apply(this,arguments)}function j(){return(j=(0,F.Z)(function*(C,v,T){const P=(0,Q.en)(C);return(0,W.executeQueryForCount)(P,R.Z.from(v),ne({},T)).then(m=>m.data.count)})).apply(this,arguments)}},24865:(X,K,g)=>{g.d(K,{G:()=>A});var F=g(15861),Q=g(2618),W=g(20477),R=g(84952);function A(C,v,T){return j.apply(this,arguments)}function j(){return(j=(0,F.Z)(function*(C,v,T){const P=(0,Q.en)(C);return(0,W.executeQueryForIds)(P,R.Z.from(v),ne({},T)).then(m=>m.data.objectIds)})).apply(this,arguments)}}}]);