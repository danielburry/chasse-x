"use strict";var Ba=Object.defineProperty,Aa=Object.defineProperties,Ca=Object.getOwnPropertyDescriptors,Qi=Object.getOwnPropertySymbols,Sa=Object.prototype.hasOwnProperty,Ma=Object.prototype.propertyIsEnumerable,Ji=(ce,H,b)=>H in ce?Ba(ce,H,{enumerable:!0,configurable:!0,writable:!0,value:b}):ce[H]=b,se=(ce,H)=>{for(var b in H||(H={}))Sa.call(H,b)&&Ji(ce,b,H[b]);if(Qi)for(var b of Qi(H))Ma.call(H,b)&&Ji(ce,b,H[b]);return ce},ze=(ce,H)=>Aa(ce,Ca(H));(self.webpackChunkchasse_pwa_front=self.webpackChunkchasse_pwa_front||[]).push([[4916],{919:(ce,H,b)=>{var M,G,ht,xe,y,T;b.d(H,{Fr:()=>y,_K:()=>xe,al:()=>G}),(T=M||(M={}))[T.UNKNOWN=0]="UNKNOWN",T[T.FILL_VERTEX=1]="FILL_VERTEX",T[T.FILL_DD_VERTEX=2]="FILL_DD_VERTEX",T[T.FILL_INDEX=3]="FILL_INDEX",T[T.OUTLINE_VERTEX=4]="OUTLINE_VERTEX",T[T.OUTLINE_DD_VERTEX=5]="OUTLINE_DD_VERTEX",T[T.OUTLINE_INDEX=6]="OUTLINE_INDEX",T[T.LINE_VERTEX=7]="LINE_VERTEX",T[T.LINE_DD_VERTEX=8]="LINE_DD_VERTEX",T[T.LINE_INDEX=9]="LINE_INDEX",T[T.ICON_VERTEX=10]="ICON_VERTEX",T[T.ICON_DD_VERTEX=11]="ICON_DD_VERTEX",T[T.ICON_INDEX=12]="ICON_INDEX",T[T.TEXT_VERTEX=13]="TEXT_VERTEX",T[T.TEXT_DD_VERTEX=14]="TEXT_DD_VERTEX",T[T.TEXT_INDEX=15]="TEXT_INDEX",T[T.CIRCLE_VERTEX=16]="CIRCLE_VERTEX",T[T.CIRCLE_INDEX=17]="CIRCLE_INDEX",function(T){T[T.FILL=1]="FILL",T[T.LINE=2]="LINE",T[T.SYMBOL=3]="SYMBOL",T[T.CIRCLE=4]="CIRCLE"}(G||(G={})),function(T){T[T.BACKGROUND=0]="BACKGROUND",T[T.OPAQUE=1]="OPAQUE",T[T.TRANSLUCENT=2]="TRANSLUCENT",T[T.SYMBOLS=3]="SYMBOLS",T[T.HITTEST=4]="HITTEST"}(ht||(ht={})),function(T){T[T.BACKGROUND=0]="BACKGROUND",T[T.FILL=1]="FILL",T[T.OUTLINE=2]="OUTLINE",T[T.LINE=3]="LINE",T[T.ICON=4]="ICON",T[T.CIRCLE=5]="CIRCLE",T[T.TEXT=6]="TEXT",T[T.TILEINFO=7]="TILEINFO"}(xe||(xe={})),function(T){T[T.PAINTER_CHANGED=0]="PAINTER_CHANGED",T[T.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",T[T.LAYER_CHANGED=2]="LAYER_CHANGED",T[T.LAYER_REMOVED=3]="LAYER_REMOVED",T[T.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(y||(y={}))},54916:(ce,H,b)=>{b.r(H),b.d(H,{GraphicContainer:()=>la.Z,GraphicsView2D:()=>oa.Z,LabelManager:()=>aa,MagnifierView2D:()=>wa,MapViewNavigation:()=>va,Stage:()=>zn});var M=b(15861),G=b(26584),ht=b(17770),xe=b(8314),y=b(62208),T=b(32917),er=b(50618),Tt=b(49966),tr=b(57052),Ht=b(1011),I=b(39406),_e=b(51434),q=b(919);const ir={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = fract(v_accumulatedDistance / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float relativeTexX = fract((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * (v_lineHalfWidth + u_antialiasing / 2.0);\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (SDF)\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#if defined (PATTERN)\nv_widthRatio = width / v_patternSize.y;\n#else\nv_widthRatio = width / sdfPatternHalfWidth / 2.0;\n#endif\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}},nr=new(b(7423).B)(function sr(n){let e=ir;return n.split("/").forEach(t=>{e&&(e=e[t])}),e});function Q(n){return nr.resolveIncludes(n)}var ye=b(80322);const Zt=n=>(0,ye.K)({ID:n.id,PATTERN:n.pattern}),ar={shaders:n=>({vertexShader:Zt(n)+Q("background/background.vert"),fragmentShader:Zt(n)+Q("background/background.frag")})},jt=n=>(0,ye.K)({ID:n.id}),or={shaders:n=>({vertexShader:jt(n)+Q("circle/circle.vert"),fragmentShader:jt(n)+Q("circle/circle.frag")})},Yt=n=>(0,ye.K)({ID:n.id,PATTERN:n.pattern}),lr={shaders:n=>({vertexShader:Yt(n)+Q("fill/fill.vert"),fragmentShader:Yt(n)+Q("fill/fill.frag")})},Kt=n=>(0,ye.K)({ID:n.id}),hr={shaders:n=>({vertexShader:Kt(n)+Q("outline/outline.vert"),fragmentShader:Kt(n)+Q("outline/outline.frag")})},$t=n=>(0,ye.K)({ID:n.id,SDF:n.sdf}),ur={shaders:n=>({vertexShader:$t(n)+Q("icon/icon.vert"),fragmentShader:$t(n)+Q("icon/icon.frag")})},qt=n=>(0,ye.K)({ID:n.id,PATTERN:n.pattern,SDF:n.sdf}),cr={shaders:n=>({vertexShader:qt(n)+Q("line/line.vert"),fragmentShader:qt(n)+Q("line/line.frag")})},Qt=n=>(0,ye.K)({ID:n.id}),dr={shaders:n=>({vertexShader:Qt(n)+Q("text/text.vert"),fragmentShader:Qt(n)+Q("text/text.frag")})};class fr{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getMaterialProgram(e,t,i){const r=t.key<<3|this._getMaterialOptionsValue(t.type,i);if(this._programByKey.has(r))return this._programByKey.get(r);const a=this._getProgramTemplate(t.type),{shaders:o}=a,{vertexShader:l,fragmentShader:c}=o(i),u=t.getShaderHeader(),f=t.getShaderMain(),d=l.replace("#pragma header",u).replace("#pragma main",f),m=e.programCache.acquire(d,c,t.getAttributeLocations());return this._programByKey.set(r,m),m}_getMaterialOptionsValue(e,t){switch(e){case q._K.BACKGROUND:case q._K.FILL:return(t.pattern?1:0)<<1|(t.id?1:0);case q._K.OUTLINE:return t.id?1:0;case q._K.LINE:return(t.sdf?1:0)<<2|(t.pattern?1:0)<<1|(t.id?1:0);case q._K.ICON:return(t.sdf?1:0)<<1|(t.id?1:0);case q._K.CIRCLE:case q._K.TEXT:return t.id?1:0;default:return 0}}_getProgramTemplate(e){switch(e){case q._K.BACKGROUND:return ar;case q._K.CIRCLE:return or;case q._K.FILL:return lr;case q._K.ICON:return ur;case q._K.LINE:return cr;case q._K.OUTLINE:return hr;case q._K.TEXT:return dr;default:return null}}}var xt=b(93292),J=b(37977);const Jt={shaders:{vertexShader:(0,J.w)("bitBlit/bitBlit.vert"),fragmentShader:(0,J.w)("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};var Ce=b(83994),h=b(67969),Ze=b(94299),Se=b(49353);class ei{constructor(){this._initialized=!1}dispose(){this._program=(0,y.O3)(this._program),this._vertexArrayObject=(0,y.O3)(this._vertexArrayObject)}render(e,t,i,r){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA,h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(i),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",r),e.drawArrays(h.MX.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}_initialize(e){if(this._initialized)return!0;const t=(0,Ze.H)(e,Jt);if(!t)return!1;const i=new Int8Array(16);i[0]=-1,i[1]=-1,i[2]=0,i[3]=0,i[4]=1,i[5]=-1,i[6]=1,i[7]=0,i[8]=-1,i[9]=1,i[10]=0,i[11]=1,i[12]=1,i[13]=1,i[14]=1,i[15]=1;const a=new Se.U(e,Jt.attributes,xt.As,{geometry:Ce.f.createVertex(e,h.l1.STATIC_DRAW,i)});return this._program=t,this._vertexArrayObject=a,this._initialized=!0,!0}}const _r=n=>{let e="";e+=n[0].toUpperCase();for(let t=1;t<n.length;t++){const i=n[t];i===i.toUpperCase()?(e+="_",e+=i):e+=i.toUpperCase()}return e},ti=(n,e,t,i)=>{const r=n+n.substring(n.lastIndexOf("/")),a=e+e.substring(e.lastIndexOf("/")),o=(n=>{const e={};for(const t in n)e[_r(t)]=n[t];return(0,ye.K)(e)})(i);return{attributes:t,shaders:{vertexShader:o+(0,J.w)(`${r}.vert`),fragmentShader:o+(0,J.w)(`${a}.frag`)}}},ii=n=>n===I.jx.HITTEST||n===I.jx.LABEL_ALPHA;class br{constructor(e){this._rctx=e,this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getProgram(e,t=[],i=[]){const r=e.vsPath+"."+e.fsPath+JSON.stringify(t)+i.join(".");if(this._programByKey.has(r))return this._programByKey.get(r);const a=i.reduce((m,g)=>ze(se({},m),{[g]:this._rctx.driverTest[g]}),{}),o=se(se({},t.map(m=>"string"==typeof m?{name:m,value:!0}:m).reduce((m,g)=>ze(se({},m),{[g.name]:g.value}),{})),a),{vsPath:l,fsPath:c,attributes:u}=e,f=ti(l,c,u,o),d=this._rctx.programCache.acquire(f.shaders.vertexShader,f.shaders.fragmentShader,f.attributes);if(!d)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(r,d),d}getMaterialProgram(e,t,i,r,a,o=["ignoresSamplerPrecision"]){const l=(({rendererInfo:n,drawPhase:e},t,i,r)=>`${t.getVariationHash()}-${r.join(".")}-${(n=>(ii(n)?1:0)|(n===I.jx.HIGHLIGHT?2:0))(e)}-${n.getVariationHash()}-${(0,y.pC)(i)&&i.join(".")}`)(e,t,a,o);if(this._programByKey.has(l))return this._programByKey.get(l);const c=((n,e,t,i)=>{const r=i.reduce((o,l)=>ze(se({},o),{[l]:n.context.driverTest[l]}),{}),a=se(ze(se(se({},e.getVariation()),n.rendererInfo.getVariation()),{highlight:n.drawPhase===I.jx.HIGHLIGHT,id:ii(n.drawPhase)}),r);if((0,y.pC)(t))for(const o of t)a[o]=!0;return a})(e,t,a,o),u=ti(i,i,r,c),f=this._rctx.programCache.acquire(u.shaders.vertexShader,u.shaders.fragmentShader,u.attributes);if(!f)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(l,f),f}}var Er=b(59318),je=b(84792),Tr=b(986),Ye=b(63290),Y=b(10699),me=b(23841),Me=b(67831),xr=b(9545),yr=b(32837),P=b(39351),wr=b(21411),le=b(84439);class ut{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new le.Z(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new le.Z;let i=null,r=-1;for(let a=0;a<this._free.length;++a){const o=this._free[a];e<=o.width&&t<=o.height&&(null===i||o.y<=i.y&&o.x<=i.x)&&(i=o,r=a)}return null===i?new le.Z:(this._free.splice(r,1),i.width<i.height?(i.width>e&&this._free.push(new le.Z(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new le.Z(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new le.Z(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new le.Z(i.x,i.y+t,e,i.height-t))),new le.Z(i.x,i.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){const i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}var K=b(55086);const Fr=n=>Math.floor(n/256);class Sr{constructor(e,t,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=i,this._binPack=new ut(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const e=[117,149,181,207,207,181,149,117],t=[];for(let r=0;r<e.length;r++){const a=e[r];for(let o=0;o<11;o++)t.push(a)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(t)};this._recordGlyph(i)}getGlyphItems(e,t,i){var r=this;return(0,M.Z)(function*(){const a=r._getGlyphCache(e);return yield r._fetchRanges(e,t,i),t.map(o=>r._getMosaicItem(a,e,o))})()}bind(e,t,i,r){const a=this._getTexture(e,i);a.setSamplingMode(t),this._dirties[i]&&(a.setData(this._glyphData[i]),this._dirties[i]=!1),e.bindTexture(a,r)}_getGlyphCache(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}_getTexture(e,t){return this._textures[t]||(this._textures[t]=new K.x(e,{pixelFormat:h.VI.ALPHA,dataType:h.Br.UNSIGNED_BYTE,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[t]}_invalidate(){this._dirties[this._currentPage]=!0}_fetchRanges(e,t,i){var r=this;return(0,M.Z)(function*(){const a=function Br(n){const e=new Set;for(const t of n)e.add(Fr(t));return e}(t),o=[];a.forEach(l=>{o.push(r._fetchRange(e,l,i))}),yield Promise.all(o)})()}_fetchRange(e,t,i){var r=this;return(0,M.Z)(function*(){return t>256?null:function Ar(n,e,t){return n.has(e)||n.set(e,t().then(()=>{n.delete(e)}).catch(i=>{n.delete(e),(0,Y.H9)(i)})),n.get(e)}(r._rangePromises,e+t,()=>r._glyphSource.getRange(e,t,i))})()}_getMosaicItem(e,t,i){if(!e[i]){const r=this._glyphSource.getGlyph(t,i);if(!r||!r.metrics)return n=i,{rect:new le.Z(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:n,sdf:!0};const a=this._recordGlyph(r);e[i]={rect:a,page:this._currentPage,metrics:r.metrics,code:i,sdf:!0},this._invalidate()}var n;return e[i]}_recordGlyph(e){const t=e.metrics;let i;if(0===t.width)i=new le.Z(0,0,0,0);else{const a=t.width+6,o=t.height+6;i=this._binPack.allocate(a,o),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new ut(this.width-4,this.height-4),i=this._binPack.allocate(a,o));const l=this._glyphData[this._currentPage],c=e.bitmap;let u,f;if(c)for(let d=0;d<o;d++){u=a*d,f=this.width*(i.y+d)+i.x;for(let m=0;m<a;m++)l[f+m]=c[u+m]}(0,xe.Z)("esri-glyph-debug")&&this._showDebugPage(l)}return i}_showDebugPage(e){const t=document.createElement("canvas"),i=t.getContext("2d"),r=new ImageData(this.width,this.height),a=r.data;t.width=this.width,t.height=this.height,t.style.border="1px solid black";for(let o=0;o<e.length;++o)a[4*o+0]=e[o],a[4*o+1]=0,a[4*o+2]=0,a[4*o+3]=255;i.putImageData(r,0,0),document.body.appendChild(t)}}var Mr=b(24192);class Or{constructor(e){for(this._metrics=[],this._bitmaps=[];e.next();)switch(e.tag()){case 1:{const t=e.getMessage();for(;t.next();)switch(t.tag()){case 3:{const i=t.getMessage();let r,a,o,l,c,u,f;for(;i.next();)switch(i.tag()){case 1:r=i.getUInt32();break;case 2:a=i.getBytes();break;case 3:o=i.getUInt32();break;case 4:l=i.getUInt32();break;case 5:c=i.getSInt32();break;case 6:u=i.getSInt32();break;case 7:f=i.getUInt32();break;default:i.skip()}i.release(),r&&(this._metrics[r]={width:o,height:l,left:c,top:u,advance:f},this._bitmaps[r]=a);break}default:t.skip()}t.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class Pr{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}class Dr{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t,i){const r=this._getFontStack(e);if(r.getRange(t))return Promise.resolve();const a=256*t,o=a+255,l=this._baseURL.replace("{fontstack}",e).replace("{range}",a+"-"+o);return(0,je.default)(l,se({responseType:"array-buffer"},i)).then(c=>{r.addRange(t,new Or(new Mr.Z(new Uint8Array(c.data),new DataView(c.data))))})}getGlyph(e,t){const i=this._getFontStack(e);if(!i)return;const r=Math.floor(t/256);if(r>256)return;const a=i.getRange(r);return a?{metrics:a.getMetrics(t),bitmap:a.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new Pr),t}}var ri=b(36161);const Ke=1e20;class Ir{constructor(e){this.size=e;const t=document.createElement("canvas");t.width=t.height=e,this._context=t.getContext("2d"),this._gridOuter=new Float64Array(e*e),this._gridInner=new Float64Array(e*e),this._f=new Float64Array(e),this._d=new Float64Array(e),this._z=new Float64Array(e+1),this._v=new Int16Array(e)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(e,t,i=31){this._initSVG();const r=this.createSVGString(e);return new Promise((a,o)=>{const l=new Image;l.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(r),l.onload=()=>{l.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(l,0,0,this.size,this.size);const u=this._context.getImageData(0,0,this.size,this.size),f=new Uint8Array(this.size*this.size*4);for(let d=0;d<this.size*this.size;d++){const m=u.data[4*d+3]/255;this._gridOuter[d]=1===m?0:0===m?Ke:Math.max(0,.5-m)**2,this._gridInner[d]=1===m?Ke:0===m?0:Math.max(0,m-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let d=0;d<this.size*this.size;d++)(0,ri.I)(.5-(this._gridOuter[d]-this._gridInner[d])/(2*i),f,4*d);a(f)};const c=t&&t.signal;c&&(0,Y.fu)(c,()=>o((0,Y.zE)()))})}_initSVG(){if(!this._svg){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}}createSVGString(e){this._initSVG();const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d",e),this._svg.appendChild(t);const i=t.getBBox(),r=i.width/i.height,a=this.size/2;let o,l,c,u;r>1?(l=o=a/i.width,c=this.size/4,u=a-a*(1/r)/2):(o=l=a/i.height,c=a-a*r/2,u=this.size/4),t.setAttribute("style",`transform: matrix(${o}, 0, 0, ${l}, ${-i.x*o+c}, ${-i.y*l+u})`);const m=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${this._svg.innerHTML}</svg>`;return this._svg.removeChild(t),m}_edt(e,t,i){const r=this._f,a=this._d,o=this._v,l=this._z;for(let c=0;c<t;c++){for(let u=0;u<i;u++)r[u]=e[u*t+c];this._edt1d(r,a,o,l,i);for(let u=0;u<i;u++)e[u*t+c]=a[u]}for(let c=0;c<i;c++){for(let u=0;u<t;u++)r[u]=e[c*t+u];this._edt1d(r,a,o,l,t);for(let u=0;u<t;u++)e[c*t+u]=Math.sqrt(a[u])}}_edt1d(e,t,i,r,a){i[0]=0,r[0]=-Ke,r[1]=+Ke;for(let o=1,l=0;o<a;o++){let c=(e[o]+o*o-(e[i[l]]+i[l]*i[l]))/(2*o-2*i[l]);for(;c<=r[l];)l--,c=(e[o]+o*o-(e[i[l]]+i[l]*i[l]))/(2*o-2*i[l]);l++,i[l]=o,r[l]=c,r[l+1]=+Ke}for(let o=0,l=0;o<a;o++){for(;r[l+1]<o;)l++;t[o]=(o-i[l])*(o-i[l])+e[i[l]]}}}var si=b(43289);function Oe(n){return n&&"static"===n.type}class yt{constructor(e,t,i=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||t<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=t,i>0&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new ut(this._pageWidth,this._pageHeight);const r=Math.floor(this._pageWidth),a=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(r*a)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}getHeight(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}getPageTexture(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}has(e){return this._mosaicRects.has(e)}get itemCount(){return this._mosaicRects.size}getSpriteItem(e){return this._mosaicRects.get(e)}addSpriteItem(e,t,i,r,a,o){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);let l,c,u;if(Oe(i)?[l,c,u]=this._allocateImage(t[0],t[1]):(l=new le.Z(0,0,t[0],t[1]),c=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:i,size:[t[0]+2*P.fL,t[1]+2*P.fL],dirty:!0,texture:void 0})),l.width<=0||l.height<=0)return null;const f={rect:l,width:t[0],height:t[1],sdf:a,simplePattern:o,pixelRatio:1,page:c};return this._mosaicRects.set(e,f),Oe(i)&&this._copy({rect:l,spriteSize:t,spriteData:i.data,page:c,pageSize:u,repeat:r,sdf:a}),f}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const e=this._spriteCopyQueue.pop();e&&this._copy(e)}getSpriteItems(e){const t={};for(const i of e)t[i]=this.getSpriteItem(i);return t}getMosaicItemPosition(e){const t=this.getSpriteItem(e),i=t&&t.rect;if(!i)return null;i.width=t.width,i.height=t.height;const o=P.fL,l=this._mosaicPages[t.page];return{size:[t.width,t.height],tl:[(i.x+o)/l[0],(i.y+o)/l[1]],br:[(i.x+o+t.width)/l[0],(i.y+o+t.height)/l[1]],page:t.page}}bind(e,t,i=0,r=0){const a=this._mosaicPages[i],o=a.mosaicsData;let l=a.texture;l||(l=function Ur(n,e,t){return Oe(e)?new K.x(n,{pixelFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,width:t[0],height:t[1]},new Uint8Array(e.data.buffer)):new K.x(n,{pixelFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,samplingMode:h.cw.LINEAR,wrapMode:h.e8.CLAMP_TO_EDGE,width:t[0],height:t[1]},null)}(e,o,a.size),a.texture=l),l.setSamplingMode(t),Oe(o)?(e.bindTexture(l,r),a.dirty&&(l.setData(new Uint8Array(o.data.buffer)),l.generateMipmap())):o.data.bindFrame(e,l,r),a.dirty=!1}static _copyBits(e,t,i,r,a,o,l,c,u,f,d){let m=r*t+i,g=c*o+l;if(d){g-=o;for(let p=-1;p<=f;p++,m=((p+f)%f+r)*t+i,g+=o)for(let _=-1;_<=u;_++)a[g+_]=e[m+(_+u)%u]}else for(let p=0;p<f;p++){for(let _=0;_<u;_++)a[g+_]=e[m+_];m+=t,g+=o}}_copy(e){if(e.page>=this._mosaicPages.length)return;const t=this._mosaicPages[e.page],i=t.mosaicsData;if(!Oe(t.mosaicsData))throw new G.Z("mapview-invalid-resource","unsuitable data type!");const r=e.spriteData,a=i.data;a&&r||console.error("Source or target images are uninitialized!"),yt._copyBits(r,e.spriteSize[0],0,0,a,e.pageSize[0],e.rect.x+P.fL,e.rect.y+P.fL,e.spriteSize[0],e.spriteSize[1],e.repeat),t.dirty=!0}_allocateImage(e,t){e+=2*P.fL,t+=2*P.fL;const i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){const a=2**Math.ceil((0,si.k3)(e)),o=2**Math.ceil((0,si.k3)(t)),l=new le.Z(0,0,e,t);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*o)},size:[a,o],dirty:!0,texture:void 0}),[l,this._mosaicPages.length-1,[a,o]]}const r=this._binPack.allocate(e,t);if(r.width<=0){const a=this._mosaicPages[this._currentPage];return!a.dirty&&Oe(a.mosaicsData)&&(a.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new ut(this._pageWidth,this._pageHeight),this._allocateImage(e,t)}return[r,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const e of this._mosaicPages){const t=e.texture;t&&t.dispose();const i=e.mosaicsData;Oe(i)||i.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}}var k=b(64288),Lr=b(1719),ee=b(27422),be=b(7547),ni=b(3959);function ai(n){return(0,ee.HA)(n.frameDurations.reduce((e,t)=>e+t,0))}function oi(n,e){const{width:t,height:i,selectFrame:r}=n,a=n.frameDurations.slice(),o=a.pop();return a.push((0,ee.HA)(o+e)),{frameDurations:a,selectFrame:r,width:t,height:i}}class Vr{constructor(e,t,i){this._animation=e,this._repeatType=i,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let r=0;for(;t>r;)r+=this.timeToFrame,this.nextFrame();this._animation.selectFrame(this._currentFrame)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case be.of.None:this._currentFrame-=this._direction;break;case be.of.Loop:this._currentFrame=0;break;case be.of.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(-1===this._currentFrame)switch(this._repeatType){case be.of.None:this._currentFrame-=this._direction;break;case be.of.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case be.of.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame],this._animation.selectFrame(this._currentFrame)}}class li{constructor(e){this._requestRender=e,this._frameData=null}destroy(){this._playHandle.remove()}bindFrame(e,t,i){e.bindTexture(t,i),(0,y.Wi)(this._frameData)||(t.updateData(0,P.fL,P.fL,this._frameData.width,this._frameData.height,this._frameData),this._frameData=null)}_load(e,t,i,r){var a=this;return(0,M.Z)(function*(){try{const o=c=>{a._frameData=c,a._requestRender.requestRender()},l=yield a._loadAnimation(e,o,r);a.frameCount=l.frameDurations.length,a.width=l.width,a.height=l.height,a._playHandle=function Xr(n,e,t){const i=null==e.playAnimation||e.playAnimation,r=function kr(n,e,t){let i,{repeatType:r}=e;if(null==r&&(r=be.of.Loop),!0===e.reverseAnimation&&(n=function Nr(n){const{width:e,height:t}=n;return{frameDurations:n.frameDurations.reverse(),selectFrame:i=>{n.selectFrame(n.frameDurations.length-1-i)},width:e,height:t}}(n)),null!=e.duration&&(n=function zr(n,e){const{width:t,height:i,selectFrame:r}=n,a=e/ai(n);return{frameDurations:n.frameDurations.map(o=>(0,ee.HA)(o*a)),selectFrame:r,width:t,height:i}}(n,(0,ee.HA)(1e3*e.duration))),null!=e.repeatDelay){const a=1e3*e.repeatDelay;r===be.of.Loop?n=oi(n,(0,ee.HA)(a)):r===be.of.Oscillate&&(n=function Gr(n,e){const{width:t,height:i,selectFrame:r}=n,a=n.frameDurations.slice(),o=a.shift();return a.unshift((0,ee.HA)(o+e)),{frameDurations:a,selectFrame:r,width:t,height:i}}(oi(n,(0,ee.HA)(a/2)),(0,ee.HA)(a/2)))}if(null!=e.startTimeOffset)i=(0,ee.HA)(1e3*e.startTimeOffset);else if(null!=e.randomizeStartTime){const a=(0,ni.$)(t),o=82749913,c=(0,ni.f)(a,null!=e.randomizeStartSeed?e.randomizeStartSeed:o);i=(0,ee.HA)(c*ai(n))}else i=(0,ee.HA)(0);return new Vr(n,i,r)}(n,e,t);let a,o=r.timeToFrame;return function l(){a=i&&setTimeout(()=>{r.nextFrame(),o=r.timeToFrame,l()},o)}(),{remove:()=>{i&&clearTimeout(a)}}}(l,t,i)}catch(o){if(!(0,Y.D_)(o))return new G.Z("invalid-resource","Could not parse animated resource.")}})()}}var ui={exports:{}};ui.exports=function(n){var e={};function t(i){if(e[i])return e[i].exports;var r=e[i]={exports:{},id:i,loaded:!1};return n[i].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}return t.m=n,t.c=e,t.p="",t(0)}([function(n,e,t){Object.defineProperty(e,"__esModule",{value:!0}),e.isNotPNG=function c(v){return v===o},e.isNotAPNG=function u(v){return v===l},e.default=function d(v){var w=new Uint8Array(v);if(Array.prototype.some.call(f,function(V,W){return V!==w[W]}))return o;var x=!1;if(m(w,function(V){return!(x="acTL"===V)}),!x)return l;var A=[],R=[],S=null,B=null,U=0,X=new r.APNG;if(m(w,function(V,W,L,Ne){var oe=new DataView(W.buffer);switch(V){case"IHDR":S=W.subarray(L+8,L+8+Ne),X.width=oe.getUint32(L+8),X.height=oe.getUint32(L+12);break;case"acTL":X.numPlays=oe.getUint32(L+8+4);break;case"fcTL":B&&(X.frames.push(B),U++),(B=new r.Frame).width=oe.getUint32(L+8+4),B.height=oe.getUint32(L+8+8),B.left=oe.getUint32(L+8+12),B.top=oe.getUint32(L+8+16);var ve=oe.getUint16(L+8+20),lt=oe.getUint16(L+8+22);0===lt&&(lt=100),B.delay=1e3*ve/lt,B.delay<=10&&(B.delay=100),X.playTime+=B.delay,B.disposeOp=oe.getUint8(L+8+24),B.blendOp=oe.getUint8(L+8+25),B.dataParts=[],0===U&&2===B.disposeOp&&(B.disposeOp=1);break;case"fdAT":B&&B.dataParts.push(W.subarray(L+8+4,L+8+Ne));break;case"IDAT":B&&B.dataParts.push(W.subarray(L+8,L+8+Ne));break;case"IEND":R.push(_(W,L,12+Ne));break;default:A.push(_(W,L,12+Ne))}}),B&&X.frames.push(B),0==X.frames.length)return l;var he=new Blob(A),ue=new Blob(R);return X.frames.forEach(function(V){var W=[];W.push(f),S.set(F(V.width),0),S.set(F(V.height),4),W.push(E("IHDR",S)),W.push(he),V.dataParts.forEach(function(L){return W.push(E("IDAT",L))}),W.push(ue),V.imageData=new Blob(W,{type:"image/png"}),delete V.dataParts,W=null}),X};var i=function a(v){return v&&v.__esModule?v:{default:v}}(t(1)),r=t(2),o=new Error("Not a PNG"),l=new Error("Not an animated PNG"),f=new Uint8Array([137,80,78,71,13,10,26,10]);function m(v,w){var x=new DataView(v.buffer),A=8,R=void 0,S=void 0,B=void 0;do{S=x.getUint32(A),B=w(R=g(v,A+4,4),v,A,S),A+=12+S}while(!1!==B&&"IEND"!=R&&A<v.length)}function g(v,w,x){var A=Array.prototype.slice.call(v.subarray(w,w+x));return String.fromCharCode.apply(String,A)}function _(v,w,x){var A=new Uint8Array(x);return A.set(v.subarray(w,w+x)),A}var E=function(v,w){var x=v.length+w.length,A=new Uint8Array(x+8),R=new DataView(A.buffer);R.setUint32(0,w.length),A.set(function p(v){for(var w=new Uint8Array(v.length),x=0;x<v.length;x++)w[x]=v.charCodeAt(x);return w}(v),4),A.set(w,8);var S=(0,i.default)(A,4,x);return R.setUint32(x+4,S),A},F=function(v){return new Uint8Array([v>>>24&255,v>>>16&255,v>>>8&255,255&v])}},function(n,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(o){for(var l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,c=-1,u=l,f=l+(arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.length-l);u<f;u++)c=c>>>8^t[255&(c^o[u])];return-1^c};for(var t=new Uint32Array(256),i=0;i<256;i++){for(var r=i,a=0;a<8;a++)r=0!=(1&r)?3988292384^r>>>1:r>>>1;t[i]=r}},function(n,e,t){Object.defineProperty(e,"__esModule",{value:!0}),e.Frame=e.APNG=void 0;var i=function(){function l(c,u){for(var f=0;f<u.length;f++){var d=u[f];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(c,d.key,d)}}return function(c,u,f){return u&&l(c.prototype,u),f&&l(c,f),c}}(),r=function a(l){return l&&l.__esModule?l:{default:l}}(t(3));function o(l,c){if(!(l instanceof c))throw new TypeError("Cannot call a class as a function")}e.APNG=function(){function l(){o(this,l),this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[]}return i(l,[{key:"createImages",value:function(){return Promise.all(this.frames.map(function(c){return c.createImage()}))}},{key:"getPlayer",value:function(c){var u=this,f=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.createImages().then(function(){return new r.default(u,c,f)})}}]),l}(),e.Frame=function(){function l(){o(this,l),this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.imageData=null,this.imageElement=null}return i(l,[{key:"createImage",value:function(){var c=this;return this.imageElement?Promise.resolve():new Promise(function(u,f){var d=URL.createObjectURL(c.imageData);c.imageElement=document.createElement("img"),c.imageElement.onload=function(){URL.revokeObjectURL(d),u()},c.imageElement.onerror=function(){URL.revokeObjectURL(d),c.imageElement=null,f(new Error("Image creation error"))},c.imageElement.src=d})}}]),l}()},function(n,e,t){Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function u(f,d){for(var m=0;m<d.length;m++){var g=d[m];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(f,g.key,g)}}return function(f,d,m){return d&&u(f.prototype,d),m&&u(f,m),f}}(),c=function(u){function f(d,m,g){!function a(u,f){if(!(u instanceof f))throw new TypeError("Cannot call a class as a function")}(this,f);var p=function o(u,f){if(!u)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!f||"object"!=typeof f&&"function"!=typeof f?u:f}(this,(f.__proto__||Object.getPrototypeOf(f)).call(this));return p.playbackRate=1,p._currentFrameNumber=0,p._ended=!1,p._paused=!0,p._numPlays=0,p._apng=d,p.context=m,p.stop(),g&&p.play(),p}return function l(u,f){if("function"!=typeof f&&null!==f)throw new TypeError("Super expression must either be null or a function, not "+typeof f);u.prototype=Object.create(f&&f.prototype,{constructor:{value:u,enumerable:!1,writable:!0,configurable:!0}}),f&&(Object.setPrototypeOf?Object.setPrototypeOf(u,f):u.__proto__=f)}(f,u),i(f,[{key:"renderNextFrame",value:function(){this._currentFrameNumber=(this._currentFrameNumber+1)%this._apng.frames.length,this._currentFrameNumber===this._apng.frames.length-1&&(this._numPlays++,0!==this._apng.numPlays&&this._numPlays>=this._apng.numPlays&&(this._ended=!0,this._paused=!0)),this._prevFrame&&1==this._prevFrame.disposeOp?this.context.clearRect(this._prevFrame.left,this._prevFrame.top,this._prevFrame.width,this._prevFrame.height):this._prevFrame&&2==this._prevFrame.disposeOp&&this.context.putImageData(this._prevFrameData,this._prevFrame.left,this._prevFrame.top);var d=this.currentFrame;this._prevFrame=d,this._prevFrameData=null,2==d.disposeOp&&(this._prevFrameData=this.context.getImageData(d.left,d.top,d.width,d.height)),0==d.blendOp&&this.context.clearRect(d.left,d.top,d.width,d.height),this.context.drawImage(d.imageElement,d.left,d.top),this.emit("frame",this._currentFrameNumber),this._ended&&this.emit("end")}},{key:"play",value:function(){var d=this;this.emit("play"),this._ended&&this.stop(),this._paused=!1;var m=performance.now()+this.currentFrame.delay/this.playbackRate;requestAnimationFrame(function p(_){if(!d._ended&&!d._paused){if(_>=m){for(;_-m>=d._apng.playTime/d.playbackRate;)m+=d._apng.playTime/d.playbackRate,d._numPlays++;do{d.renderNextFrame(),m+=d.currentFrame.delay/d.playbackRate}while(!d._ended&&_>m)}requestAnimationFrame(p)}})}},{key:"pause",value:function(){this._paused||(this.emit("pause"),this._paused=!0)}},{key:"stop",value:function(){this.emit("stop"),this._numPlays=0,this._ended=!1,this._paused=!0,this._currentFrameNumber=-1,this.context.clearRect(0,0,this._apng.width,this._apng.height),this.renderNextFrame()}},{key:"currentFrameNumber",get:function(){return this._currentFrameNumber}},{key:"currentFrame",get:function(){return this._apng.frames[this._currentFrameNumber]}},{key:"paused",get:function(){return this._paused}},{key:"ended",get:function(){return this._ended}}]),f}(function r(u){return u&&u.__esModule?u:{default:u}}(t(4)).default);e.default=c},function(n,e){function t(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(l){return"function"==typeof l}function a(l){return"object"==typeof l&&null!==l}function o(l){return void 0===l}n.exports=t,t.EventEmitter=t,t.prototype._events=void 0,t.prototype._maxListeners=void 0,t.defaultMaxListeners=10,t.prototype.setMaxListeners=function(l){if(!function r(l){return"number"==typeof l}(l)||l<0||isNaN(l))throw TypeError("n must be a positive number");return this._maxListeners=l,this},t.prototype.emit=function(l){var c,u,f,d,m,g;if(this._events||(this._events={}),"error"===l&&(!this._events.error||a(this._events.error)&&!this._events.error.length)){if((c=arguments[1])instanceof Error)throw c;var p=new Error('Uncaught, unspecified "error" event. ('+c+")");throw p.context=c,p}if(o(u=this._events[l]))return!1;if(i(u))switch(arguments.length){case 1:u.call(this);break;case 2:u.call(this,arguments[1]);break;case 3:u.call(this,arguments[1],arguments[2]);break;default:d=Array.prototype.slice.call(arguments,1),u.apply(this,d)}else if(a(u))for(d=Array.prototype.slice.call(arguments,1),f=(g=u.slice()).length,m=0;m<f;m++)g[m].apply(this,d);return!0},t.prototype.on=t.prototype.addListener=function(l,c){var u;if(!i(c))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",l,i(c.listener)?c.listener:c),this._events[l]?a(this._events[l])?this._events[l].push(c):this._events[l]=[this._events[l],c]:this._events[l]=c,a(this._events[l])&&!this._events[l].warned&&(u=o(this._maxListeners)?t.defaultMaxListeners:this._maxListeners)&&u>0&&this._events[l].length>u&&(this._events[l].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[l].length),"function"==typeof console.trace&&console.trace()),this},t.prototype.once=function(l,c){if(!i(c))throw TypeError("listener must be a function");var u=!1;function f(){this.removeListener(l,f),u||(u=!0,c.apply(this,arguments))}return f.listener=c,this.on(l,f),this},t.prototype.removeListener=function(l,c){var u,f,d,m;if(!i(c))throw TypeError("listener must be a function");if(!this._events||!this._events[l])return this;if(d=(u=this._events[l]).length,f=-1,u===c||i(u.listener)&&u.listener===c)delete this._events[l],this._events.removeListener&&this.emit("removeListener",l,c);else if(a(u)){for(m=d;m-- >0;)if(u[m]===c||u[m].listener&&u[m].listener===c){f=m;break}if(f<0)return this;1===u.length?(u.length=0,delete this._events[l]):u.splice(f,1),this._events.removeListener&&this.emit("removeListener",l,c)}return this},t.prototype.removeAllListeners=function(l){var c,u;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[l]&&delete this._events[l],this;if(0===arguments.length){for(c in this._events)"removeListener"!==c&&this.removeAllListeners(c);return this.removeAllListeners("removeListener"),this._events={},this}if(i(u=this._events[l]))this.removeListener(l,u);else if(u)for(;u.length;)this.removeListener(l,u[u.length-1]);return delete this._events[l],this},t.prototype.listeners=function(l){return this._events&&this._events[l]?i(this._events[l])?[this._events[l]]:this._events[l].slice():[]},t.prototype.listenerCount=function(l){if(this._events){var c=this._events[l];if(i(c))return 1;if(c)return c.length}return 0},t.listenerCount=function(l,c){return l.listenerCount(c)}}]);const Wr=(0,Lr.g)(ui.exports);class wt extends li{static create(e,t,i,r,a){return(0,M.Z)(function*(){const o=new wt(r);try{yield o._load(e,t,i,a)}catch(l){if(!(0,Y.D_)(l))return new G.Z("invalid-resource",`Could not load PNG: ${l.message}`)}return o})()}_loadAnimation(e,t,i){return(0,M.Z)(function*(){return function Hr(n,e,t){return Rt.apply(this,arguments)}(e,t,i)})()}}function Rt(){return(Rt=(0,M.Z)(function*(n,e,t){const i=Wr(n);if(i instanceof Error)throw i;yield i.createImages(),(0,Y.k_)(t);const{frames:r,width:a,height:o}=i,l=document.createElement("canvas");l.width=a,l.height=o;const c=l.getContext("2d"),u=[],f=[];for(const d of r){f.push((0,ee.HA)(d.delay));const m=d.imageElement;c.globalCompositeOperation=0===d.blendOp?"copy":"source-over";const g=2===d.disposeOp&&c.getImageData(d.left,d.top,d.width,d.height);c.drawImage(m,d.left,d.top);const p=c.getImageData(0,0,a,o);u.push(p),0===d.disposeOp||(1===d.disposeOp?c.clearRect(d.left,d.top,d.width,d.height):2===d.disposeOp&&c.putImageData(g,d.left,d.top))}return{frameDurations:f,selectFrame:d=>{e(u[d])},width:a,height:o}})).apply(this,arguments)}const Zr=[137,80,78,71,13,10,26,10];function ci(n){const e=new Uint8Array(n);return!Zr.some((t,i)=>t!==e[i])}var Yr=b(57932),Pe={},di={},Ee={};Object.defineProperty(Ee,"__esModule",{value:!0}),Ee.loop=Ee.conditional=Ee.parse=void 0,Ee.parse=function n(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i;if(Array.isArray(t))t.forEach(function(o){return n(e,o,i,r)});else if("function"==typeof t)t(e,i,r,n);else{var a=Object.keys(t)[0];Array.isArray(t[a])?(r[a]={},n(e,t[a],i,r[a])):r[a]=t[a](e,i,r,n)}return i},Ee.conditional=function(n,e){return function(t,i,r,a){e(t,i,r)&&a(t,n,i,r)}},Ee.loop=function(n,e){return function(t,i,r,a){for(var o=[],l=t.pos;e(t,i,r);){var c={};if(a(t,n,i,c),t.pos===l)break;l=t.pos,o.push(c)}return o}};var N={};Object.defineProperty(N,"__esModule",{value:!0}),N.readBits=N.readArray=N.readUnsigned=N.readString=N.peekBytes=N.readBytes=N.peekByte=N.readByte=N.buildStream=void 0,N.buildStream=function(n){return{data:n,pos:0}};N.readByte=function(){return function(n){return n.data[n.pos++]}},N.peekByte=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(e){return e.data[e.pos+n]}};var ct=function(n){return function(e){return e.data.subarray(e.pos,e.pos+=n)}};N.readBytes=ct,N.peekBytes=function(n){return function(e){return e.data.subarray(e.pos,e.pos+n)}},N.readString=function(n){return function(e){return Array.from(ct(n)(e)).map(function(t){return String.fromCharCode(t)}).join("")}},N.readUnsigned=function(n){return function(e){var t=ct(2)(e);return n?(t[1]<<8)+t[0]:(t[0]<<8)+t[1]}},N.readArray=function(n,e){return function(t,i,r){for(var a="function"==typeof e?e(t,i,r):e,o=ct(n),l=new Array(a),c=0;c<a;c++)l[c]=o(t);return l}},N.readBits=function(n){return function(e){for(var t=function(n){return n.data[n.pos++]}(e),i=new Array(8),r=0;r<8;r++)i[7-r]=!!(t&1<<r);return Object.keys(n).reduce(function(a,o){var l=n[o];return a[o]=l.length?function(n,e,t){for(var i=0,r=0;r<t;r++)i+=n[e+r]&&Math.pow(2,t-r-1);return i}(i,l.index,l.length):i[l.index],a},{})}},function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var e=Ee,t=N,i={blocks:function(f){for(var m=[],g=f.data.length,p=0,_=(0,t.readByte)()(f);0!==_&&_;_=(0,t.readByte)()(f)){if(f.pos+_>=g){var E=g-f.pos;m.push((0,t.readBytes)(E)(f)),p+=E;break}m.push((0,t.readBytes)(_)(f)),p+=_}for(var F=new Uint8Array(p),v=0,w=0;w<m.length;w++)F.set(m[w],v),v+=m[w].length;return F}},r=(0,e.conditional)({gce:[{codes:(0,t.readBytes)(2)},{byteSize:(0,t.readByte)()},{extras:(0,t.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,t.readUnsigned)(!0)},{transparentColorIndex:(0,t.readByte)()},{terminator:(0,t.readByte)()}]},function(f){var d=(0,t.peekBytes)(2)(f);return 33===d[0]&&249===d[1]}),a=(0,e.conditional)({image:[{code:(0,t.readByte)()},{descriptor:[{left:(0,t.readUnsigned)(!0)},{top:(0,t.readUnsigned)(!0)},{width:(0,t.readUnsigned)(!0)},{height:(0,t.readUnsigned)(!0)},{lct:(0,t.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,e.conditional)({lct:(0,t.readArray)(3,function(f,d,m){return Math.pow(2,m.descriptor.lct.size+1)})},function(f,d,m){return m.descriptor.lct.exists}),{data:[{minCodeSize:(0,t.readByte)()},i]}]},function(f){return 44===(0,t.peekByte)()(f)}),o=(0,e.conditional)({text:[{codes:(0,t.readBytes)(2)},{blockSize:(0,t.readByte)()},{preData:function(f,d,m){return(0,t.readBytes)(m.text.blockSize)(f)}},i]},function(f){var d=(0,t.peekBytes)(2)(f);return 33===d[0]&&1===d[1]}),l=(0,e.conditional)({application:[{codes:(0,t.readBytes)(2)},{blockSize:(0,t.readByte)()},{id:function(f,d,m){return(0,t.readString)(m.blockSize)(f)}},i]},function(f){var d=(0,t.peekBytes)(2)(f);return 33===d[0]&&255===d[1]}),c=(0,e.conditional)({comment:[{codes:(0,t.readBytes)(2)},i]},function(f){var d=(0,t.peekBytes)(2)(f);return 33===d[0]&&254===d[1]}),u=[{header:[{signature:(0,t.readString)(3)},{version:(0,t.readString)(3)}]},{lsd:[{width:(0,t.readUnsigned)(!0)},{height:(0,t.readUnsigned)(!0)},{gct:(0,t.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,t.readByte)()},{pixelAspectRatio:(0,t.readByte)()}]},(0,e.conditional)({gct:(0,t.readArray)(3,function(f,d){return Math.pow(2,d.lsd.gct.size+1)})},function(f,d){return d.lsd.gct.exists}),{frames:(0,e.loop)([r,l,c,a,o],function(f){var d=(0,t.peekByte)()(f);return 33===d||44===d})}];n.default=u}(di);var dt={};Object.defineProperty(dt,"__esModule",{value:!0}),dt.deinterlace=void 0,dt.deinterlace=function(n,e){for(var t=new Array(n.length),i=n.length/e,a=[0,4,2,1],o=[8,8,4,2],l=0,c=0;c<4;c++)for(var u=a[c];u<i;u+=o[c])f=u,void 0,m=n.slice((d=l)*e,(d+1)*e),t.splice.apply(t,[f*e,e].concat(m)),l++;var f,d,m;return t};var ft={};Object.defineProperty(ft,"__esModule",{value:!0}),ft.lzw=void 0,ft.lzw=function(n,e,t){var i,r,a,o,l,c,u,f,d,m,g,p,_,E,F,v,w=4096,A=t,R=new Array(t),S=new Array(w),B=new Array(w),U=new Array(w+1);for(l=1+(r=1<<(m=n)),i=r+2,u=-1,a=(1<<(o=m+1))-1,f=0;f<r;f++)S[f]=0,B[f]=f;for(g=p=_=E=F=v=0,d=0;d<A;){if(0===E){if(p<o){g+=e[v]<<p,p+=8,v++;continue}if(f=g&a,g>>=o,p-=o,f>i||f==l)break;if(f==r){a=(1<<(o=m+1))-1,i=r+2,u=-1;continue}if(-1==u){U[E++]=B[f],u=f,_=f;continue}for(c=f,f==i&&(U[E++]=_,f=u);f>r;)U[E++]=B[f],f=S[f];U[E++]=_=255&B[f],i<w&&(S[i]=u,B[i]=_,0==(++i&a)&&i<w&&(o++,a+=i)),u=c}E--,R[F++]=U[E],d++}for(d=F;d<A;d++)R[d]=0;return R},Object.defineProperty(Pe,"__esModule",{value:!0});var _i=Pe.decompressFrames=Pe.decompressFrame=mi=Pe.parseGIF=void 0,ls=function fs(n){return n&&n.__esModule?n:{default:n}}(di),hs=Ee,us=N,cs=dt,ds=ft,mi=Pe.parseGIF=function(n){var e=new Uint8Array(n);return(0,hs.parse)((0,us.buildStream)(e),ls.default)},pi=function(n,e,t){if(n.image){var i=n.image,a=(0,ds.lzw)(i.data.minCodeSize,i.data.blocks,i.descriptor.width*i.descriptor.height);i.descriptor.lct.interlaced&&(a=(0,cs.deinterlace)(a,i.descriptor.width));var o={pixels:a,dims:{top:n.image.descriptor.top,left:n.image.descriptor.left,width:n.image.descriptor.width,height:n.image.descriptor.height}};return o.colorTable=i.descriptor.lct&&i.descriptor.lct.exists?i.lct:e,n.gce&&(o.delay=10*(n.gce.delay||10),o.disposalType=n.gce.extras.disposal,n.gce.extras.transparentColorGiven&&(o.transparentIndex=n.gce.transparentColorIndex)),t&&(o.patch=function(n){for(var e=n.pixels.length,t=new Uint8ClampedArray(4*e),i=0;i<e;i++){var r=4*i,a=n.pixels[i],o=n.colorTable[a]||[0,0,0];t[r]=o[0],t[r+1]=o[1],t[r+2]=o[2],t[r+3]=a!==n.transparentIndex?255:0}return t}(o)),o}console.warn("gif frame does not have associated image.")};Pe.decompressFrame=pi,_i=Pe.decompressFrames=function(n,e){return n.frames.filter(function(t){return t.image}).map(function(t){return pi(t,n.gct,e)})};class Ft extends li{static create(e,t,i,r,a){return(0,M.Z)(function*(){const o=new Ft(r);try{yield o._load(e,t,i,a)}catch(l){if(!(0,Y.D_)(l))return new G.Z("invalid-resource",`Could not load GIF: ${l.message}`)}return o})()}_loadAnimation(e,t,i){return(0,M.Z)(function*(){return function gs(n,e,t){return Bt.apply(this,arguments)}(e,t)})()}}function Bt(){return(Bt=(0,M.Z)(function*(n,e,t){const i=mi(n),r=_i(i,!0),{width:a,height:o}=i.lsd,l=document.createElement("canvas");l.width=a,l.height=o;const c=l.getContext("2d"),u=[],f=[];for(const d of r){f.push((0,ee.HA)(d.delay));const m=new ImageData(d.patch,d.dims.width,d.dims.height),g=(0,Yr.E0)(m),p=3===d.disposalType&&c.getImageData(d.dims.left,d.dims.top,d.dims.width,d.dims.height);c.drawImage(g,d.dims.left,d.dims.top);const _=c.getImageData(0,0,a,o);u.push(_),1===d.disposalType||(2===d.disposalType?c.clearRect(d.dims.left,d.dims.top,d.dims.width,d.dims.height):3===d.disposalType&&c.putImageData(p,d.dims.left,d.dims.top))}return{frameDurations:f,selectFrame:d=>{e(u[d])},width:a,height:o}})).apply(this,arguments)}const vs=[71,73,70];function gi(n){const e=new Uint8Array(n);return!vs.some((t,i)=>t!==e[i])}var At=b(84450),Ts=b(71251);const vi=(0,xr.c)(),bi="arial-unicode-ms-regular",Ei=Ye.Z.getLogger("esri.views.2d.engine.webgl.TextureManager");function St(){return(St=(0,M.Z)(function*(n,e){const t=(0,k.Gr)(n);let i;const r=";base64,";if(t.includes(r)){const a=t.indexOf(r)+r.length,o=t.substring(a),l=atob(o),c=new Uint8Array(l.length);for(let u=0;u<l.length;u++)c[u]=l.charCodeAt(u);i=c.buffer}else try{const{data:a}=yield(0,je.default)(t,se({responseType:"array-buffer"},e));i=a}catch(a){if(!(0,Y.D_)(a))return new G.Z("mapview-invalid-resource",`Could not fetch requested resource at ${t}`)}return i})).apply(this,arguments)}function Ti(n,e){const t=Math.round((0,me.F2)(e)*window.devicePixelRatio);return Math.min(n,t*(t>=128?2:4))}const Mt=(n,e,t)=>Ei.error(new G.Z(n,e,t));class Ot{constructor(e,t,i){this.mosaicType=e,this.page=t,this.sdf=i}static fromMosaic(e,t){return new Ot(e,t.page,t.sdf)}}class ys{constructor(e,t){var i;this._requestRender=e,this.resourceManager=t,this._invalidFontsMap=new Map,this._sdfConverter=new Ir(126),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Ts.e({concurrency:10,process:(i=(0,M.Z)(function*(r,a){(0,Y.k_)(a);try{return yield(0,je.default)(r,{responseType:"image",signal:a})}catch(o){throw(0,Y.D_)(o)?o:new G.Z("mapview-invalid-resource",`Could not fetch requested resource at ${r}`,o)}}),function(a,o){return i.apply(this,arguments)})}),this._spriteMosaic=new yt(2048,2048,500),this._glyphSource=new Dr(`${Er.Z.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new Sr(1024,1024,this._glyphSource),this._rasterizer=new yr.Z(t)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}rasterizeItem(e,t,i,r){var a=this;return(0,M.Z)(function*(){if((0,y.Wi)(e))return Mt("mapview-null-resource","Unable to rasterize null resource"),null;switch(e.type){case"text":case"esriTS":{const o=yield a._rasterizeText(e,i,r);return o.forEach(l=>a._setTextureBinding(I.Un.GLYPH,l)),{glyphMosaicItems:o}}default:{if((0,k.Ll)(e))return Mt("mapview-invalid-type",`MapView does not support symbol type: ${e.type}`,e),null;const o=yield a._rasterizeSpriteSymbol(e,t,r);return(0,At.ok)(o)&&o&&a._setTextureBinding(I.Un.SPRITE,o),{spriteMosaicItem:o}}}})()}bindTextures(e,t,i,r=!1){if(0===i.textureBinding)return;const a=this._bindingInfos[i.textureBinding-1],o=a.page,l=r?h.cw.LINEAR_MIPMAP_LINEAR:h.cw.LINEAR;switch(a.mosaicType){case I.Un.SPRITE:{const c=this.sprites.getWidth(o),u=this.sprites.getHeight(o),f=(0,Me.a)(vi,c,u);return this._spriteMosaic.bind(e,l,o,P.D3),t.setUniform1i("u_texture",P.D3),void t.setUniform2fv("u_mosaicSize",f)}case I.Un.GLYPH:{const f=(0,Me.a)(vi,this.glyphs.width,this.glyphs.height);return this._glyphMosaic.bind(e,l,o,P.Al),t.setUniform1i("u_texture",P.Al),void t.setUniform2fv("u_mosaicSize",f)}default:Ei.error("mapview-texture-manager",`Cannot handle unknown type ${a.mosaicType}`)}}_hashMosaic(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}_setTextureBinding(e,t){const i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){const r=Ot.fromMosaic(e,t);this._hashToBindingIndex.set(i,this._bindingInfos.length+1),this._bindingInfos.push(r)}t.textureBinding=this._hashToBindingIndex.get(i)}_rasterizeText(e,t,i){var r=this;return(0,M.Z)(function*(){let a,o;if("cim"in e)a=e.fontName,o=e.text;else{const u=e;a=(0,wr.Yc)(u.font),o=u.text}const l=r._invalidFontsMap.has(a),c=t||(0,k.Jq)((0,Tr.E)(o)[0]);try{return yield r._glyphMosaic.getGlyphItems(l?bi:a,c,i)}catch(u){return Mt("mapview-invalid-resource",`Couldn't find font ${a}. Falling back to Arial Unicode MS Regular`),r._invalidFontsMap.set(a,!0),r._glyphMosaic.getGlyphItems(bi,c,i)}})()}_rasterizeSpriteSymbol(e,t,i){var r=this;return(0,M.Z)(function*(){if((0,k.Gg)(e))return null;const a=function Es(n){switch(n.type){case"esriSMS":return`${n.style}.${n.path}`;case"esriSLS":return`${n.style}.${n.cap}`;case"esriSFS":return`${n.style}`;case"esriPFS":case"esriPMS":return n.imageData?`${n.imageData}${n.width}${n.height}`:`${n.url}${n.width}${n.height}`;default:return"mosaicHash"in n?n.mosaicHash:JSON.stringify(n)}}(e);if(r._spriteMosaic.has(a))return r._spriteMosaic.getSpriteItem(a);if((0,k.sG)(e)||(0,k.HX)(e)&&!(0,k.yP)(e))return r._handleAsyncResource(a,e,i);const l=r._rasterizer.rasterizeJSONResource(e,1);if(l){const{size:c,image:u,sdf:f,simplePattern:d}=l;return r._addItemToMosaic(a,c,{type:"static",data:u},(0,k.js)(e),f,d)}return new G.Z("TextureManager","unrecognized or null rasterized image")})()}_handleAsyncResource(e,t,i){var r=this;return(0,M.Z)(function*(){if(r._ongoingRasterizations.has(e))return r._ongoingRasterizations.get(e);let a;a=(0,k.sG)(t)?r._handleSVG(t,e,i):r._handleImage(t,e,i),r._ongoingRasterizations.set(e,a);try{yield a,r._ongoingRasterizations.delete(e)}catch(o){r._ongoingRasterizations.delete(e)}return a})()}_handleSVG(e,t,i){var r=this;return(0,M.Z)(function*(){const o=yield r._sdfConverter.draw(e.path,i);return r._addItemToMosaic(t,[126,126],{type:"static",data:new Uint32Array(o.buffer)},!1,!0,!0)})()}_handleGIFOrPNG(e,t,i){var r=this;return(0,M.Z)(function*(){const a=yield function xs(n,e){return St.apply(this,arguments)}(e,i);if((0,At.ok)(a)){const o=gi(a),l=ci(a);if(!o&&!l)return new G.Z("mapview-invalid-resource","Image data is neither GIF nor PNG!");let c;try{const d=e.animatedSymbolProperties||{},m=e.objectId;o&&function bs(n){if(!gi(n))return!1;const e=new DataView(n),t=e.getUint8(10);let i=13+(128&t?3*2**(1+(7&t)):0),r=0,a=!1;for(;!a;){switch(e.getUint8(i++)){case 33:if(!o())return!1;break;case 44:l();break;case 59:a=!0;break;default:return!1}if(r>1)return!0}function o(){switch(e.getUint8(i++)){case 249:!function c(){i++,i+=4,m()}();break;case 1:!function u(){r++,i++,i+=12,m()}();break;case 254:!function f(){m()}();break;case 255:!function d(){i++,i+=8,i+=3,m()}();break;default:return!1}return!0}function l(){r++,i+=8;const g=e.getUint8(i++);i+=128&g?3*2**(1+(7&g)):0,i++,m()}function m(){let g;for(;g=e.getUint8(i++);)i+=g}return!1}(a)?c=yield Ft.create(a,d,m,r._requestRender,i):l&&function jr(n){if(!ci(n))return!1;const e=new DataView(n),t=new Uint8Array(n);let i,r=8;do{const a=e.getUint32(r);if(i=String.fromCharCode.apply(String,Array.prototype.slice.call(t.subarray(r+4,r+8))),"acTL"===i)return!0;r+=12+a}while("IEND"!==i&&r<t.length);return!1}(a)&&(c=yield wt.create(a,d,m,r._requestRender,i))}catch(d){if(!(0,Y.D_)(d))return new G.Z("mapview-invalid-resource","Could not fetch requested resource!")}if(c&&(0,At.ok)(c))return r._addItemToMosaic(t,[c.width,c.height],{type:"animated",data:c},(0,k.js)(e),!1,!1);const u=new Blob([a],{type:o?"image/gif":"image/png"}),f=yield r._imageFromBlob(u);if(f&&f instanceof HTMLImageElement){let d=f.width,m=f.height;"esriPMS"===e.type&&(d=Math.round(Ti(f.width,(0,k.Ub)(e))),m=Math.round(f.height*(d/f.width)));const g="cim"in e?e.cim.colorSubstitutions:void 0,{size:p,sdf:_,image:E}=r._rasterizer.rasterizeImageResource(d,m,f,g);return r._addItemToMosaic(t,p,{type:"static",data:E},(0,k.js)(e),_,!1)}}return new G.Z("mapview-invalid-resource","Could not handle resource!")})()}_handleImage(e,t,i){var r=this;return(0,M.Z)(function*(){var o;if((0,k.DQ)(e)||(0,k.iw)(e))return r._handleGIFOrPNG(e,t,i);const a=(0,k.Gr)(e);try{let l;const c=r.resourceManager.getResource(a);if((0,y.pC)(c))l=c;else{const{data:_}=yield r._imageRequestQueue.push(a,se({},i));l=_}if((0,k.TB)(a))if("width"in e&&"height"in e)l.width=(0,me.F2)(e.width),l.height=(0,me.F2)(e.height);else if("cim"in e){const _=e.cim;l.width=(0,me.F2)(null!=(o=_.width)?o:_.scaleX*_.size),l.height=(0,me.F2)(_.size)}if(!l.width||!l.height)return null;let u=l.width,f=l.height;"esriPMS"===e.type&&(u=Math.round(Ti(l.width,(0,k.Ub)(e))),f=Math.round(l.height*(u/l.width)));const d="cim"in e?e.cim.colorSubstitutions:void 0,{size:m,sdf:g,image:p}=r._rasterizer.rasterizeImageResource(u,f,l,d);return r._addItemToMosaic(t,m,{type:"static",data:p},(0,k.js)(e),g,!1)}catch(l){if(!(0,Y.D_)(l))return new G.Z("mapview-invalid-resource",`Could not fetch requested resource at ${a}. ${l.message}`)}})()}_imageFromBlob(e){var t=this;return(0,M.Z)(function*(){const i=window.URL.createObjectURL(e);try{const{data:r}=yield t._imageRequestQueue.push(i);return window.URL.revokeObjectURL(i),r}catch(r){if(window.URL.revokeObjectURL(i),!(0,Y.D_)(r))return new G.Z("mapview-invalid-resource",`Could not fetch requested resource at ${i}`);throw r}})()}_addItemToMosaic(e,t,i,r,a,o){return this._spriteMosaic.addSpriteItem(e,t,i,r,a,o)}}var ws=b(39863),$e=b(30217),Ge=b(99770),De=b(84161),we=b(28093),Ie=b(50392);const Rs={shaders:{vertexShader:(0,J.w)("stencil/stencil.vert"),fragmentShader:(0,J.w)("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])},Fs=(0,Ge.f)(-.5,-.5);class Bs{constructor(){this._centerNdc=(0,we.c)(),this._pxToNdc=(0,we.c)(),this._worldDimensionsPx=(0,we.c)(),this._mat3=(0,Tt.c)(),this._initialized=!1}dispose(){this._program=(0,y.O3)(this._program),this._quad=(0,y.O3)(this._quad)}render(e,t){const{context:i}=e;return!!this._updateGeometry(e,t)&&(this._initialized||this._initialize(i),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setColorMask(!1,!1,!1,!1),i.setBlendingEnabled(!1),i.setStencilOp(h.xS.KEEP,h.xS.KEEP,h.xS.REPLACE),i.setStencilFunction(h.wb.ALWAYS,1,255),i.setStencilTestEnabled(!0),i.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind(),!0)}_initialize(e){if(this._initialized)return;const t=(0,Ze.H)(e,Rs);t&&(this._program=t,this._quad=new Ie.Z(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(e,t){const{state:i,pixelRatio:r}=e,{size:a,rotation:o}=i,l=Math.round(a[0]*r),c=Math.round(a[1]*r);if(!i.spatialReference.isWrappable)return!1;const u=(0,ws.t)(o),f=Math.abs(Math.cos(u)),d=Math.abs(Math.sin(u)),m=Math.round(l*f+c*d),g=Math.round(i.worldScreenWidth);if(m<=g)return!1;const E=(t.left-t.right)*r/l,F=(t.bottom-t.top)*r/c;(0,De.s)(this._worldDimensionsPx,g*r,l*d+c*f,1),(0,De.s)(this._pxToNdc,2/l,-2/c,1),(0,De.s)(this._centerNdc,E,F,1);const v=this._mat3;return(0,$e.h)(v,this._centerNdc),(0,$e.d)(v,v,this._pxToNdc),0!==o&&(0,$e.r)(v,v,u),(0,$e.d)(v,v,this._worldDimensionsPx),(0,$e.c)(v,v,Fs),!0}}class qe{constructor(){this.name=this.constructor.name}createOptions(e,t){return null}}class As extends qe{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,t){if(!t.size)return;const{context:i,renderingOptions:r}=e;this._quad||(this._quad=new Ie.Z(i,[0,0,1,0,0,1,1,1]));const a=i.getBoundFramebufferObject(),{x:o,y:l,width:c,height:u}=i.getViewport();t.bindTextures(i);const f=t.getBlock(P.xl);if((0,y.Wi)(f))return;const d=f.getFBO(i),m=f.getFBO(i,1);i.setViewport(0,0,t.size,t.size),this._computeDelta(e,m,r.labelsAnimationTime),this._updateAnimationState(e,m,d),i.bindFramebuffer(a),i.setViewport(o,l,c,u)}_computeDelta(e,t,i){const{context:r,painter:a,displayLevel:o}=e,l=a.materialManager.getProgram(this._desc,["delta"]);r.bindFramebuffer(t),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),r.useProgram(l),l.setUniform1i("u_maskTexture",P.iJ),l.setUniform1i("u_sourceTexture",P.nM),l.setUniform1f("u_timeDelta",e.deltaTime),l.setUniform1f("u_animationTime",i),l.setUniform1f("u_zoomLevel",Math.round(10*o)),this._quad.draw()}_updateAnimationState(e,t,i){const{context:r,painter:a}=e,o=a.materialManager.getProgram(this._desc,["update"]);r.bindTexture(t.colorTexture,1),r.useProgram(o),o.setUniform1i("u_sourceTexture",1),r.bindFramebuffer(i),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const xi=n=>`#define ${(n=>n.replace("-","_").toUpperCase())(n)}\n`;function yi(n){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:xi(n)+(0,J.w)("blend/blend.vert"),fragmentShader:xi(n)+(0,J.w)("blend/blend.frag")}}}const wi=Ye.Z.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class Ss{constructor(){this._size=[0,0]}dispose(e){this._backBufferTexture=(0,y.O3)(this._backBufferTexture),this._quad=(0,y.O3)(this._quad)}draw(e,t,i,r,a){const{context:o,drawPhase:l}=e;if(this._setupShader(o),r&&"normal"!==r&&l!==I.jx.LABEL)return void this._drawBlended(e,t,i,r,a);const c=yi("normal"),u=o.programCache.acquire(c.shaders.vertexShader,c.shaders.fragmentShader,c.attributes);if(!u)return void wi.error(new G.Z("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));o.useProgram(u),t.setSamplingMode(i),o.bindTexture(t,0),u.setUniform1i("u_layerTexture",0),u.setUniform1f("u_opacity",a),o.setBlendingEnabled(!0),o.setBlendFunction(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA);const f=this._quad;f.draw(),f.unbind(),u.dispose()}_drawBlended(e,t,i,r,a){const{context:o,state:l,pixelRatio:c,inFadeTransition:u}=e,{size:f}=l,d=o.getBoundFramebufferObject();let m,g;if((0,y.pC)(d)){const v=d.descriptor;m=v.width,g=v.height}else m=Math.round(c*f[0]),g=Math.round(c*f[1]);this._createOrResizeTexture(e,m,g);const p=this._backBufferTexture;d.copyToTexture(0,0,m,g,0,0,p),o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),o.setBlendingEnabled(!0),o.setDepthTestEnabled(!1),o.setDepthWriteEnabled(!1);const _=yi(r),E=o.programCache.acquire(_.shaders.vertexShader,_.shaders.fragmentShader,_.attributes);if(!E)return void wi.error(new G.Z("mapview-BlendEffect",`Error creating shader program for blend mode ${r}`));o.useProgram(E),p.setSamplingMode(i),o.bindTexture(p,0),E.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(i),o.bindTexture(t,1),E.setUniform1i("u_layerTexture",1),E.setUniform1f("u_opacity",a),E.setUniform1f("u_inFadeOpacity",u?1:0),o.setBlendFunction(h.zi.ONE,h.zi.ZERO);const F=this._quad;F.draw(),F.unbind(),E.dispose(),o.setBlendFunction(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA)}_setupShader(e){this._quad||(this._quad=new Ie.Z(e,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(e,t,i){const{context:r}=e;null!==this._backBufferTexture&&t===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,i):this._backBufferTexture=new K.x(r,{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR,flipped:!1,width:t,height:i}),this._size[0]=t,this._size[1]=i)}}class Ri extends qe{constructor(e){super(),this.name=this.constructor.name,this.defines=[e]}dispose(){}bind({context:e,painter:t}){this._prev=e.getBoundFramebufferObject();const{width:i,height:r}=e.getViewport(),a=t.getFbos(i,r).effect0;e.bindFramebuffer(a),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw(e,t){const{context:i,painter:r}=e,a=r.getPostProcessingEffects(t),o=i.getBoundFramebufferObject();for(const{postProcessingEffect:l,effect:c}of a)l.draw(e,o,c);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),r.blitTexture(i,o.colorTexture,h.cw.NEAREST),i.setStencilTestEnabled(!0)}}const Ms=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],Os=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Dt=Ye.Z.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient"),Ds=[0,0,0,0];class Is{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:0,outlineWidth:1.3,innerHaloWidth:.4,outerHaloWidth:.4},this.shadeTexChanged=!0,this.texelData=new Uint8Array(1024),this.minMaxDistance=[0,0]}setHighlightOptions(e){const t=this._convertedHighlightOptions;!function Ps(n,e){e.fillColor[0]=n.color.r/255,e.fillColor[1]=n.color.g/255,e.fillColor[2]=n.color.b/255,e.fillColor[3]=n.color.a,n.haloColor?(e.outlineColor[0]=n.haloColor.r/255,e.outlineColor[1]=n.haloColor.g/255,e.outlineColor[2]=n.haloColor.b/255,e.outlineColor[3]=n.haloColor.a):(e.outlineColor[0]=e.fillColor[0],e.outlineColor[1]=e.fillColor[1],e.outlineColor[2]=e.fillColor[2],e.outlineColor[3]=e.fillColor[3]),e.fillColor[3]*=n.fillOpacity,e.outlineColor[3]*=n.haloOpacity,e.fillColor[0]*=e.fillColor[3],e.fillColor[1]*=e.fillColor[3],e.fillColor[2]*=e.fillColor[3],e.outlineColor[0]*=e.outlineColor[3],e.outlineColor[1]*=e.outlineColor[3],e.outlineColor[2]*=e.outlineColor[3],e.outlineWidth=1.3,e.outerHaloWidth=.4,e.innerHaloWidth=.4,e.outlinePosition=0}(e,t);const i=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,r=t.outlinePosition-t.outlineWidth/2,a=t.outlinePosition+t.outlineWidth/2,o=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,l=1*Math.sqrt(Math.PI/2),c=Math.abs(i)>l?Math.round(10*(Math.abs(i)-l))/10:0,u=Math.abs(o)>l?Math.round(10*(Math.abs(o)-l))/10:0;let f;c&&!u?Dt.error("The outer rim of the highlight is "+c+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!c&&u?Dt.error("The inner rim of the highlight is "+u+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):c&&u&&Dt.error("The highlight is "+Math.max(c,u)+"px away from the edge of the feature; consider reducing some width values.");const d=[void 0,void 0,void 0,void 0];function m(p,_,E){d[0]=(1-E)*p[0]+E*_[0],d[1]=(1-E)*p[1]+E*_[1],d[2]=(1-E)*p[2]+E*_[2],d[3]=(1-E)*p[3]+E*_[3]}const{texelData:g}=this;for(let p=0;p<256;++p)f=i+p/255*(o-i),f<i?(d[4*p+0]=0,d[4*p+1]=0,d[4*p+2]=0,d[4*p+3]=0):f<r?m(Ds,t.outlineColor,(f-i)/(r-i)):f<a?[d[0],d[1],d[2],d[3]]=t.outlineColor:f<o?m(t.outlineColor,t.fillColor,(f-a)/(o-a)):[d[4*p+0],d[4*p+1],d[4*p+2],d[4*p+3]]=t.fillColor,g[4*p+0]=255*d[0],g[4*p+1]=255*d[1],g[4*p+2]=255*d[2],g[4*p+3]=255*d[3];this.minMaxDistance[0]=i,this.minMaxDistance[1]=o,this.shadeTexChanged=!0}applyHighlightOptions(e,t){this.shadeTex||(this.shadeTex=new K.x(e,{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,width:256,height:1,samplingMode:h.cw.LINEAR})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,256,1,this.texelData),this.shadeTexChanged=!1),e.bindTexture(this.shadeTex,P.Jw),t.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}destroy(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}const Us={shaders:{vertexShader:(0,J.w)("highlight/textured.vert"),fragmentShader:(0,J.w)("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},Ls={shaders:{vertexShader:(0,J.w)("highlight/textured.vert"),fragmentShader:(0,J.w)("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])};var Je=b(40852);class Ns{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(e,t){e.bindTexture(t,P.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Ms),e.bindVAO(this._resources.quadVAO),e.drawArrays(h.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}finalBlur(e,t){e.bindTexture(t,P.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Os),e.bindVAO(this._resources.quadVAO),e.drawArrays(h.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}renderHighlight(e,t,i){e.bindTexture(t,P.QU),e.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA),e.drawArrays(h.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}_initialize(e,t,i){this._width=t,this._height=i;const r=Ce.f.createVertex(e,h.l1.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),a=new Se.U(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new Je.G("a_position",2,h.g.BYTE,0,4),new Je.G("a_texcoord",2,h.g.UNSIGNED_BYTE,2,4)]},{geometry:r}),o=(0,Ze.H)(e,Us),l=(0,Ze.H)(e,Ls);e.useProgram(o),o.setUniform1i("u_texture",P.QU),o.setUniform1i("u_shade",P.Jw),o.setUniform1f("u_sigma",1),e.useProgram(l),l.setUniform1i("u_texture",P.QU),l.setUniform1f("u_sigma",1),this._resources={quadGeometry:r,quadVAO:a,highlightProgram:o,blurProgram:l}}setup(e,t,i){this._resources?(this._width=t,this._height=i):this._initialize(e,t,i)}}var Z=b(85775);function Fi(n,e,t){const i=new K.x(n,{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,width:e,height:t,samplingMode:h.cw.LINEAR});return[i,new Z.X(n,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.STENCIL_RENDER_BUFFER},i)]}class zs{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(e,t,i){this._width=t,this._height=i;const[r,a]=Fi(e,t,i),[o,l]=Fi(e,t,i);this._resources={sharedBlur1Tex:r,sharedBlur1Fbo:a,sharedBlur2Tex:o,sharedBlur2Fbo:l}}setup(e,t,i){!this._resources||this._width===t&&this._height===i||this.dispose(),this._resources||this._initialize(e,t,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Tex}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Tex}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}class Gs extends qe{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new Ns,this._hlGradient=new Is,this._width=void 0,this._height=void 0,this._hlSurfaces=new zs,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new ei}dispose(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}bind(e){const{context:t,painter:i}=e,{width:r,height:a}=t.getViewport(),o=i.getFbos(r,a).effect0;this.setup(e,r,a),t.bindFramebuffer(o),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:e},t,i){this._width=t,this._height=i;const r=t%4,a=i%4;i+=a<2?-a:4-a,this._adjustedWidth=t+=r<2?-r:4-r,this._adjustedHeight=i,this._boundFBO=e.getBoundFramebufferObject();const o=Math.round(1*t),l=Math.round(1*i);this._hlRenderer.setup(e,o,l),this._hlSurfaces.setup(e,o,l)}draw({context:e}){const t=e.getBoundFramebufferObject();e.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setStencilTestEnabled(!1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(e,t.colorTexture,h.cw.NEAREST,1),e.setStencilTestEnabled(!1),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!0),e.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(e,this._hlSurfaces.sharedBlur1Tex),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(e,this._hlSurfaces.sharedBlur2Tex),e.bindFramebuffer(this._boundFBO),e.setBlendingEnabled(!0),e.setColorMask(!0,!0,!0,!0),e.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(e,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}setHighlightOptions(e){this._hlGradient.setHighlightOptions(e)}}class Vs extends qe{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){(0,y.pC)(this._fbo)&&this._fbo.dispose()}createOptions({pixelRatio:e},t,i=P.dn){if(!t.length)return null;const r=t.shift(),a=r.point.x,o=r.point.y;return this._outstanding=r,{type:"hittest",distance:i*e,position:[a,o]}}bind(e){const{context:t,attributeView:i}=e;if(!i.size)return;const r=i.getBlock(P.pU);if((0,y.Wi)(r))return;const a=r.getFBO(t);t.setViewport(0,0,i.size,i.size),t.bindFramebuffer(a),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT)}unbind(e){}draw(e){const{context:t,attributeView:i}=e,r=i.getBlock(P.pU);if((0,y.Wi)(this._outstanding))return;const a=this._outstanding.resolver;if((0,y.Wi)(r))return a.resolve([]),void(this._outstanding=null);const o=r.getFBO(t),l=new Uint8Array(o.width*o.height*4);o.readPixels(0,0,o.width,o.height,h.VI.RGBA,h.Br.UNSIGNED_BYTE,l);const c=[];for(let u=0;u<l.length;u+=4){const d=l[u+3];l[u]&&c.push({id:u/4,directHits:d})}this._outstanding=null,c.sort((u,f)=>f.directHits===u.directHits?f.id-u.id:f.directHits-u.directHits),a.resolve(c.map(u=>u.id))}}class ks extends qe{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0}dispose(){(0,y.pC)(this._fbo)&&this._fbo.dispose()}bind({context:e,painter:t}){const{width:i,height:r}=e.getViewport();this._boundFBO=e.getBoundFramebufferObject();const a=t.getFbos(i,r).effect0;e.bindFramebuffer(a),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind({context:e}){e.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw({context:e,state:t,pixelRatio:i},r,a=2*P.dn){const o=e.getBoundFramebufferObject(),l=t.size[1]*i,c=Math.round(a*i),u=c/2,f=c/2;this._ensureBuffer(c),r.forEach((d,m)=>{const g=new Map,p=Math.floor(m.x*i-c/2),_=Math.floor(l-m.y*i-c/2);o.readPixels(p,_,c,c,h.VI.RGBA,h.Br.UNSIGNED_BYTE,this._buf);for(let F=0;F<this._buf32.length;F++){const v=this._buf32[F];if(4294967295!==v&&0!==v){const w=F%c,x=c-Math.floor(F/c),A=(u-w)*(u-w)+(f-x)*(f-x),R=g.has(v)?g.get(v):4294967295;g.set(v,Math.min(A,R))}}const E=Array.from(g).sort((F,v)=>F[1]-v[1]).map(F=>F[0]);d.resolve(E),r.delete(m)})}_ensureBuffer(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}const Xs=[1,0],Ws=[0,1],Hs=[1,.8,.6,.4,.2],Zs=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class js{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad&&(this._quad.dispose(),this._quad=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}draw(e,t,i){const{width:r,height:a}=t,{context:o,painter:l}=e,{materialManager:c}=l,u=o.gl,f=this._programDesc,{strength:d,radius:m,threshold:g}=i;this._quad||(this._quad=new Ie.Z(o,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,r,a),o.setStencilTestEnabled(!1),o.setBlendingEnabled(!0),o.setBlendFunction(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA),o.setStencilWriteMask(0);const p=this._quad;p.bind(),o.bindFramebuffer(this._intensityFBO);const _=c.getProgram(f.luminosityHighPass);o.useProgram(_),o.bindTexture(t.colorTexture,0),_.setUniform1i("u_texture",0),_.setUniform3fv("u_defaultColor",[0,0,0]),_.setUniform1f("u_defaultOpacity",0),_.setUniform1f("u_luminosityThreshold",g),_.setUniform1f("u_smoothWidth",.01);const E=[Math.round(r/2),Math.round(a/2)];o.setViewport(0,0,E[0],E[1]),o.setClearColor(0,0,0,0),o.clear(u.COLOR_BUFFER_BIT),p.draw(),o.setBlendingEnabled(!1);let F=this._intensityFBO.colorTexture;for(let x=0;x<this._nMips;x++){const A=c.getProgram(f.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[x]}]);o.useProgram(A),o.bindTexture(F,x+1),A.setUniform1i("u_colorTexture",x+1),A.setUniform2fv("u_texSize",E),A.setUniform2fv("u_direction",Xs),o.setViewport(0,0,E[0],E[1]);const R=this._mipsFBOs[x];o.bindFramebuffer(R.horizontal),p.draw(),F=R.horizontal.colorTexture,o.bindFramebuffer(R.vertical),o.bindTexture(F,x+1),A.setUniform2fv("u_direction",Ws),p.draw(),F=R.vertical.colorTexture,E[0]=Math.round(E[0]/2),E[1]=Math.round(E[1]/2)}o.setViewport(0,0,r,a);const v=c.getProgram(f.composite,[{name:"nummips",value:5}]);o.bindFramebuffer(this._compositeFBO),o.useProgram(v),v.setUniform1f("u_bloomStrength",d),v.setUniform1f("u_bloomRadius",m),v.setUniform1fv("u_bloomFactors",Hs),v.setUniform3fv("u_bloomTintColors",Zs),o.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),v.setUniform1i("u_blurTexture1",1),o.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),v.setUniform1i("u_blurTexture2",2),o.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),v.setUniform1i("u_blurTexture3",3),o.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),v.setUniform1i("u_blurTexture4",4),o.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),v.setUniform1i("u_blurTexture5",5),p.draw(),o.bindFramebuffer(t),o.setBlendingEnabled(!0);const w=c.getProgram(f.blit);o.useProgram(w),o.bindTexture(this._compositeFBO.colorTexture,6),w.setUniform1i("u_texture",6),o.setBlendFunction(h.zi.ONE,h.zi.ONE),p.draw(),p.unbind(),o.setBlendFunction(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA),o.setStencilTestEnabled(!0)}_createOrResizeResources(e,t,i){const{context:r}=e;if(this._compositeFBO&&this._size[0]===t&&this._size[1]===i)return;this._size[0]=t,this._size[1]=i;const a=[Math.round(t/2),Math.round(i/2)];this._compositeFBO?this._compositeFBO.resize(t,i):this._compositeFBO=new Z.X(r,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE,width:t,height:i}),this._intensityFBO?this._intensityFBO.resize(a[0],a[1]):this._intensityFBO=new Z.X(r,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE,width:a[0],height:a[1]},{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR,flipped:!1,width:a[0],height:a[1]});for(let o=0;o<this._nMips;o++)this._mipsFBOs[o]?(this._mipsFBOs[o].horizontal.resize(a[0],a[1]),this._mipsFBOs[o].vertical.resize(a[0],a[1])):this._mipsFBOs[o]={horizontal:new Z.X(r,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE,width:a[0],height:a[1]},{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR,flipped:!1,width:a[0],height:a[1]}),vertical:new Z.X(r,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE,width:a[0],height:a[1]},{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR,flipped:!1,width:a[0],height:a[1]})},a[0]=Math.round(a[0]/2),a[1]=Math.round(a[1]/2)}}const Ys=[1,0],Ks=[0,1];class $s{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(e,t,i){const{context:r}=e,{type:a,radius:o}=i;if(0===o)return;this._createOrResizeResources(e),this._quad||(this._quad=new Ie.Z(r,[-1,-1,1,-1,-1,1,1,1]));const l=this._quad;l.bind(),"blur"===a?this._gaussianBlur(e,t,o):this._radialBlur(e,t),l.unbind()}_gaussianBlur(e,t,i){const{context:r,state:a,painter:o,pixelRatio:l}=e,{size:c}=a,{materialManager:u}=o,f=this._programDesc,d=this._quad,m=[Math.round(l*c[0]),Math.round(l*c[1])],g=this._blurFBO,p=u.getProgram(f.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);r.useProgram(p),r.setBlendingEnabled(!1),r.bindFramebuffer(g),r.bindTexture(t.colorTexture,4),p.setUniform1i("u_colorTexture",4),p.setUniform2fv("u_texSize",m),p.setUniform2fv("u_direction",Ys),p.setUniform1f("u_sigma",i),d.draw(),r.bindFramebuffer(t),r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.bindTexture(g.colorTexture,5),p.setUniform1i("u_colorTexture",5),p.setUniform2fv("u_direction",Ks),d.draw(),r.setBlendingEnabled(!0),r.setBlendFunction(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA),r.setStencilTestEnabled(!0)}_radialBlur(e,t){const{context:i,painter:r}=e,{materialManager:a}=r,o=this._programDesc,l=this._quad,c=this._blurFBO;i.bindFramebuffer(c);const u=a.getProgram(o.radialBlur);i.useProgram(u),i.setBlendingEnabled(!1),i.bindTexture(t.colorTexture,4),u.setUniform1i("u_colorTexture",4),l.draw(),i.bindFramebuffer(t),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);const f=a.getProgram(o.blit);i.useProgram(f),i.bindTexture(c.colorTexture,5),f.setUniform1i("u_texture",5),i.setBlendFunction(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA),l.draw()}_createOrResizeResources(e){const{context:t,state:i,pixelRatio:r}=e,{size:a}=i,o=Math.round(r*a[0]),l=Math.round(r*a[1]);this._blurFBO&&this._size[0]===o&&this._size[1]===l||(this._size[0]=o,this._size[1]=l,this._blurFBO?this._blurFBO.resize(o,l):this._blurFBO=new Z.X(t,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE,width:o,height:l},{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR,flipped:!1,width:o,height:l}))}}class qs{constructor(){this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(e,t,i){const{width:r,height:a}=t;this._createOrResizeResources(e,r,a);const{context:o,painter:l}=e,{materialManager:c}=l,u=this._programDesc,f=this._quad,d=i.colorMatrix;f.bind();const m=this._layerFBOTexture;o.bindFramebuffer(t),t.copyToTexture(0,0,r,a,0,0,m),o.setBlendingEnabled(!1),o.setStencilTestEnabled(!1);const g=c.getProgram(u);o.useProgram(g),o.bindTexture(m,2),g.setUniformMatrix4fv("u_coefficients",d),g.setUniform1i("u_colorTexture",2),f.draw(),o.setBlendingEnabled(!0),o.setBlendFunction(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA),o.setStencilTestEnabled(!0),f.unbind()}_createOrResizeResources(e,t,i){const{context:r}=e;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new K.x(r,{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR,flipped:!1,width:t,height:i}),this._quad||(this._quad=new Ie.Z(r,[-1,-1,1,-1,-1,1,1,1])))}}const Qs=[1,0],Js=[0,1];class en{constructor(){this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null),this._horizontalBlurFBO&&(this._horizontalBlurFBO.dispose(),this._horizontalBlurFBO=null),this._verticalBlurFBO&&(this._verticalBlurFBO.dispose(),this._verticalBlurFBO=null)}draw(e,t,i){const{context:r,state:a,painter:o}=e,{materialManager:l}=o,c=this._programDesc,u=t.width,f=t.height,d=[Math.round(u/2),Math.round(f/2)],{blurRadius:m,offsetX:g,offsetY:p,color:_}=i,E=[(0,me.F2)(g/2),(0,me.F2)(p/2)];this._createOrResizeResources(e,u,f,d);const F=this._horizontalBlurFBO,v=this._verticalBlurFBO;r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1);const w=this._layerFBOTexture;t.copyToTexture(0,0,u,f,0,0,w),this._quad||(this._quad=new Ie.Z(r,[-1,-1,1,-1,-1,1,1,1])),r.setViewport(0,0,d[0],d[1]);const x=this._quad;x.bind(),r.setBlendingEnabled(!1);const A=l.getProgram(c.blur,[{name:"radius",value:Math.ceil(m)}]);r.useProgram(A),r.bindFramebuffer(F),r.bindTexture(t.colorTexture,4),A.setUniform1i("u_colorTexture",4),A.setUniform2fv("u_texSize",d),A.setUniform2fv("u_direction",Qs),A.setUniform1f("u_sigma",m),x.draw(),r.bindFramebuffer(v),r.bindTexture(F.colorTexture,5),A.setUniform1i("u_colorTexture",5),A.setUniform2fv("u_direction",Js),x.draw(),r.bindFramebuffer(t),r.setViewport(0,0,u,f);const R=l.getProgram(c.composite);r.useProgram(R),r.bindTexture(v.colorTexture,2),R.setUniform1i("u_blurTexture",2),r.bindTexture(w,3),R.setUniform1i("u_layerFBOTexture",3),R.setUniform4fv("u_shadowColor",[_[3]*(_[0]/255),_[3]*(_[1]/255),_[3]*(_[2]/255),_[3]]),R.setUniformMatrix3fv("u_displayViewMat3",a.displayMat3),R.setUniform2fv("u_shadowOffset",E),x.draw(),r.setBlendingEnabled(!0),r.setStencilTestEnabled(!0),r.setBlendFunction(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA),x.unbind()}_createOrResizeResources(e,t,i,r){const{context:a}=e;this._horizontalBlurFBO&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(r[0],r[1]):this._horizontalBlurFBO=new Z.X(a,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE,width:r[0],height:r[1]},{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR,flipped:!1,width:r[0],height:r[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(r[0],r[1]):this._verticalBlurFBO=new Z.X(a,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE,width:r[0],height:r[1]},{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR,flipped:!1,width:r[0],height:r[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new K.x(a,{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR,flipped:!1,width:t,height:i}))}}class tn{constructor(){this._size=[0,0]}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(e,t,i){const{width:r,height:a}=t;this._createOrResizeResources(e,r,a);const{context:o,painter:l}=e,{amount:c}=i,u=o.gl,f=this._layerFBOTexture;o.bindFramebuffer(t),t.copyToTexture(0,0,r,a,0,0,f),o.setBlendingEnabled(!0),o.setStencilTestEnabled(!1),o.setDepthTestEnabled(!1),o.setClearColor(0,0,0,0),o.clear(u.COLOR_BUFFER_BIT),l.blitTexture(o,f,h.cw.NEAREST,c)}_createOrResizeResources(e,t,i){const{context:r}=e;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new K.x(r,{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.NEAREST,flipped:!1,width:t,height:i}))}}function rn(n){switch(n){case"bloom":case"blur":case"opacity":case"drop-shadow":return n;default:return"colorize"}}const sn={colorize:()=>new qs,blur:()=>new $s,bloom:()=>new js,opacity:()=>new tn,"drop-shadow":()=>new en};class nn{constructor(){this._effectMap=new Map}dispose(){this._effectMap.forEach(e=>e.dispose()),this._effectMap.clear()}getPostProcessingEffects(e){if(!e||0===e.length)return[];const t=[];for(const i of e){const r=rn(i.type);let a=this._effectMap.get(r);a||(a=sn[r](),this._effectMap.set(r,a)),t.push({postProcessingEffect:a,effect:i})}return t}}var an=b(85931);class on{constructor(e,t){var i;this.brushes=e,this.name=t.name,this.drawPhase=t.drawPhase||I.jx.MAP,this._targetFn=t.target,this.effects=t.effects||[],this.enableDefaultDraw=null!=(i=t.enableDefaultDraw)?i:()=>!0}render(e){const{context:t,profiler:i}=e,r=this._targetFn(),a=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),a){this.enableDefaultDraw()&&this._doRender(e,r),i.recordPassEnd();for(const o of this.effects){if(!o.enable())continue;const l=o.apply;i.recordPassStart(this.name+"."+l.name),i.recordBrushStart(l.name);const c=o.args&&o.args(),{x:u,y:f,width:d,height:m}=t.getViewport(),g=t.getBoundFramebufferObject();l.bind(e,c);const p=l.createOptions(e,c),_=e.passOptions;e.passOptions=p,this._doRender(e,r,l.defines),e.passOptions=_,l.draw(e,c),l.unbind(e,c),t.bindFramebuffer(g),t.setViewport(u,f,d,m),i.recordBrushEnd(),i.recordPassEnd()}}}_doRender(e,t,i){if(!(0,y.Wi)(t))if((0,an.zG)(t)){for(const r of t)if(r.visible)for(const a of this.brushes)e.profiler.recordBrushStart(a.name),a.prepareState(e,r,i),a.draw(e,r,i),e.profiler.recordBrushEnd()}else for(const r of this.brushes)e.profiler.recordBrushStart(r.name),r.prepareState(e,t,i),r.draw(e,t,i),e.profiler.recordBrushEnd()}}var ln=b(49266);class un{constructor(e,t,i){this.context=e,this._blitRenderer=new ei,this._worldExtentClipRenderer=new Bs,this._isClippedToWorldExtent=!1,this._brushCache=new Map,this._vtlMaterialManager=new fr,this._blendEffect=new Ss,this._fboPool=[],this.effects={highlight:new Gs,hittest:new Vs,hittestVTL:new ks,integrate:new As,insideEffect:new Ri("inside"),outsideEffect:new Ri("outside")},this.materialManager=new br(e),this.textureManager=new ys(t,i),this._effectsManager=new nn}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getRenderTarget(){return this._renderTarget}setRenderTarget(e){this._renderTarget=e}getFbos(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(const o in this._fbos)this._fbos[o].resize(e,t);return this._fbos}const i={target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,samplingMode:h.cw.NEAREST,wrapMode:h.e8.CLAMP_TO_EDGE,width:e,height:t},r={colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.DEPTH_STENCIL_RENDER_BUFFER},a=new ln.r(this.context,{width:e,height:t,internalFormat:h.Tg.DEPTH_STENCIL});this._stencilBuf=a,this._fbos={output:new Z.X(this.context,r,i,a),blend:new Z.X(this.context,r,i,a),effect0:new Z.X(this.context,r,i,a)}}return this._fbos}acquireFbo(e,t){let i;i=this._fboPool.length>0?this._fboPool.pop():new Z.X(this.context,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.DEPTH_STENCIL_RENDER_BUFFER},{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,samplingMode:h.cw.NEAREST,wrapMode:h.e8.CLAMP_TO_EDGE,width:e,height:t},this._stencilBuf);const r=i.descriptor;return r.width===e&&r.height===t||i.resize(e,t),i}releaseFbo(e){this._fboPool.push(e)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderLayers(e,t=null){const{width:i,height:r}=e.getViewport();this._prevFBO=e.getBoundFramebufferObject();const a=this.getFbos(i,r);if(e.bindFramebuffer(a.output),e.setColorMask(!0,!0,!0,!0),(0,y.pC)(t)){const{r:o,g:l,b:c,a:u}=t.color;e.setClearColor(u*o/255,u*l/255,u*c/255,u)}else e.setClearColor(0,0,0,0);e.setDepthWriteEnabled(!0),e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}beforeRenderLayer(e,t,i){const{context:r,blendMode:a,effects:o,requireFBO:l,drawPhase:c}=e;if(l||Bi(c,a,o,i))r.bindFramebuffer(this._fbos.blend),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.setDepthWriteEnabled(!0),r.setClearDepth(1),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),r.setDepthWriteEnabled(!1);else{const u=this._getOutputFBO();r.bindFramebuffer(u)}r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setStencilTestEnabled(!0),r.setClearStencil(t),r.setStencilWriteMask(255),r.clear(r.gl.STENCIL_BUFFER_BIT)}compositeLayer(e,t){const{context:i,blendMode:r,effects:a,requireFBO:o,drawPhase:l}=e;if(o||Bi(l,r,a,t)){(0,y.pC)(a)&&a.length>0&&l===I.jx.MAP&&this._applyEffects(e,a);const c=this._getOutputFBO();i.bindFramebuffer(c),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA,h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA),i.setColorMask(!0,!0,!0,!0);const u=(0,y.Wi)(r)||l===I.jx.HIGHLIGHT?"normal":r;this._blendEffect.draw(e,this._fbos.blend.colorTexture,h.cw.NEAREST,u,t)}}renderLayers(e){if(e.bindFramebuffer(this._prevFBO),!this._fbos)return;const t=this._getOutputFBO();e.setDepthTestEnabled(!1),e.setStencilWriteMask(0),this._isClippedToWorldExtent?(e.setStencilTestEnabled(!0),e.setStencilFunction(h.wb.EQUAL,1,255)):e.setStencilTestEnabled(!1),this.blitTexture(e,t.colorTexture,h.cw.NEAREST)}prepareDisplay(e,t,i){const{context:r}=e;if(r.bindFramebuffer(this._prevFBO),r.setColorMask(!0,!0,!0,!0),(0,y.pC)(t)){const{r:a,g:o,b:l,a:c}=t.color;r.setClearColor(c*a/255,c*o/255,c*l/255,c)}else r.setClearColor(0,0,0,0);r.setStencilWriteMask(255),r.setClearStencil(0),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.STENCIL_BUFFER_BIT),this._isClippedToWorldExtent=this._worldExtentClipRenderer.render(e,i)}dispose(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer=(0,y.O3)(this._blitRenderer),this._worldExtentClipRenderer=(0,y.O3)(this._worldExtentClipRenderer),this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();for(const e of this._fboPool)e.dispose();if(this._fboPool.length=0,this.effects)for(const e in this.effects)this.effects[e]&&this.effects[e].dispose();this._effectsManager.dispose(),this._vtlMaterialManager=(0,y.O3)(this._vtlMaterialManager),this._prevFBO=null}getBrush(e,t){const i=function hn(n,e){switch(n){case I.LW.LINE:return _e.U.line;case I.LW.TEXT:return _e.U.text;case I.LW.LABEL:return _e.U.label;case I.LW.FILL:return e===I.mD.DOT_DENSITY?_e.U.dotDensity:_e.U.fill;case I.LW.MARKER:switch(e){case I.mD.HEATMAP:return _e.U.heatmap;case I.mD.PIE_CHART:return _e.U.pieChart;default:return _e.U.marker}}}(e,t);let r=this._brushCache.get(i);return void 0===r&&(r=new i,this._brushCache.set(i,r)),this._brushCache.get(i)}renderObject(e,t,i,r){const a=_e.U[i];if(!a)return null;let o=this._brushCache.get(a);void 0===o&&(o=new a,this._brushCache.set(a,o)),o.prepareState(e,t,r),o.draw(e,t,r)}renderObjects(e,t,i,r){const a=_e.U[i];if(!a)return null;let o=this._brushCache.get(a);void 0===o&&(o=new a,this._brushCache.set(a,o)),o.drawMany(e,t,r)}registerRenderPass(e){const t=e.brushes.map(i=>(this._brushCache.has(i)||this._brushCache.set(i,new i),this._brushCache.get(i)));return new on(t,e)}setHighlightOptions(e){this.effects.highlight.setHighlightOptions(e)}blitTexture(e,t,i,r=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA,h.zi.ONE,h.zi.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,i,r)}getPostProcessingEffects(e){return this._effectsManager.getPostProcessingEffects(e)}_getOutputFBO(){return null!=this._renderTarget?this._renderTarget:this._fbos.output}_applyEffects(e,t){const{context:i}=e,r=this._effectsManager.getPostProcessingEffects(t);for(const{postProcessingEffect:a,effect:o}of r)i.bindFramebuffer(this._fbos.blend),a.draw(e,this._fbos.blend,o)}}function Bi(n,e,t,i){return n!==I.jx.HIGHLIGHT&&(1!==i||(0,y.pC)(e)&&"normal"!==e||(0,y.pC)(t)&&t.length>0)}var cn=b(65389),dn=b(61885),$=b(38210);class Ai{constructor(e,t,i,r,a,o,l,c){this.createQuery=e,this.resultAvailable=t,this.getResult=i,this.disjoint=r,this.beginTimeElapsed=a,this.endTimeElapsed=o,this.createTimestamp=l,this.timestampBits=c}}function Ci(n,e){if(e.disjointTimerQuery)return null;let t=n.getExtension("EXT_disjoint_timer_query_webgl2");return t&&(0,$.Z)(n)?new Ai(()=>n.createQuery(),i=>n.getQueryParameter(i,n.QUERY_RESULT_AVAILABLE),i=>n.getQueryParameter(i,n.QUERY_RESULT),()=>n.getParameter(t.GPU_DISJOINT_EXT),i=>n.beginQuery(t.TIME_ELAPSED_EXT,i),()=>n.endQuery(t.TIME_ELAPSED_EXT),i=>t.queryCounterEXT(i,t.TIMESTAMP_EXT),()=>n.getQuery(t.TIMESTAMP_EXT,t.QUERY_COUNTER_BITS_EXT)):(t=n.getExtension("EXT_disjoint_timer_query"),t?new Ai(()=>t.createQueryEXT(),i=>t.getQueryObjectEXT(i,t.QUERY_RESULT_AVAILABLE_EXT),i=>t.getQueryObjectEXT(i,t.QUERY_RESULT_EXT),()=>n.getParameter(t.GPU_DISJOINT_EXT),i=>t.beginQueryEXT(t.TIME_ELAPSED_EXT,i),()=>t.endQueryEXT(t.TIME_ELAPSED_EXT),i=>t.queryCounterEXT(i,t.TIMESTAMP_EXT),()=>t.getQueryEXT(t.TIMESTAMP_EXT,t.QUERY_COUNTER_BITS_EXT)):null)}const de=(0,xe.Z)("esri-2d-profiler");class fn{constructor(e,t){if(this._events=new dn.Z,this._entries=new Map,this._timings=new cn.Z(10),!de)return;this._ext=Ci(e.gl,{}),this._debugOutput=t;const i=e.gl;if(this.enableCommandLogging)for(const r in i)if("function"==typeof i[r]){const a=i[r],o=r.includes("draw");i[r]=(...l)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:r,args:l,isDrawCommand:o}),this._currentSummary&&(this._currentSummary.commands++,o&&this._currentSummary.drawCommands++),a.apply(i,l))}}get enableCommandLogging(){return!("object"==typeof de&&de.disableCommands)}recordContainerStart(e){de&&(this._currentContainer=e)}recordContainerEnd(){de&&(this._currentContainer=null)}recordPassStart(e){de&&(this._currentPass=e,this._initSummary())}recordPassEnd(){de&&(this._currentPass=null,this._emitSummary())}recordBrushStart(e){de&&(this._currentBrush=e)}recordBrushEnd(){de&&(this._currentBrush=null)}recordStart(e){if(de&&(0,y.pC)(this._ext)){if(this._entries.has(e)){const i=this._entries.get(e),r=this._ext.resultAvailable(i.query),a=this._ext.disjoint();if(r&&!a){const o=this._ext.getResult(i.query)/1e6;let l=0;if((0,y.pC)(this._timings.enqueue(o))){const f=this._timings.entries,d=f.length;let m=0;for(const g of f)m+=g;l=m/d}const c=o.toFixed(2),u=l?l.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${e}, ${c} ms (${u} last 10 avg)\n${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${e}, ${c} ms (${u} last 10 avg)`),this._debugOutput.innerHTML=`${c} (${u})`}for(const o of i.handles)o.remove();this._entries.delete(e)}const t={name:e,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(t.handles.push(this._events.on("command",i=>{t.commandsLen++,t.commands.push(i),i.isDrawCommand&&t.drawCommands++})),t.handles.push(this._events.on("summary",i=>{t.summaries.push(i)}))),this._ext.beginTimeElapsed(t.query),this._entries.set(e,t)}}recordEnd(e){de&&(0,y.pC)(this._ext)&&this._entries.has(e)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}var _n=b(33412),Si=b(18605),et=b(57596),Fe=b(81653);class Mi{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:h.zi.ONE,dstRGB:h.zi.ZERO,srcAlpha:h.zi.ONE,dstAlpha:h.zi.ZERO},this.blendEquation={mode:h.db.ADD,modeAlpha:h.db.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=h.LR.BACK,this.frontFace=h.Wf.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=h.wb.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:h.LR.FRONT_AND_BACK,func:h.wb.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:h.LR.FRONT_AND_BACK,fail:h.xS.KEEP,zFail:h.xS.KEEP,zPass:h.xS.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.uniformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array}}class mn{constructor(e){this._allocations=new Map,e?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(e){this._allocations.set(e,(new Error).stack)}remove(e){this._allocations.delete(e)}print(){if(this._allocations.size>0){console.log(`${this._allocations.size} live object allocations:`);const e=new Map;this._allocations.forEach(t=>{var i;e.set(t,(null!=(i=e.get(t))?i:0)+1)}),e.forEach((t,i)=>{const r=i.split("\n");r.shift(),r.shift(),console.log(`${t}: ${r.shift()}`),r.forEach(a=>console.log("   ",a))})}}}class gn{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new mn(false);this._current.length<h._g.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(e,t){const i=++this._current[e];this._max[e]=Math.max(i,this._max[e]),this._allocations.add(t)}decrement(e,t){--this._current[e],this._allocations.remove(t)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((e,t)=>e+t,0)}printResourceCount(){if(this.total>0){console.log("Live objects:");for(let e=0;e<h._g.COUNT;++e){const t=this._current[e];t>0&&console.log(`${h._g[e]}: ${t}`)}}this._allocations.print()}}var vn=b(33e3),Oi=b(2078),Pi=b(26906),Di=b(2757);function Ii(n,e){const t=new Z.X(n,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE},{target:h.No.TEXTURE_2D,wrapMode:h.e8.CLAMP_TO_EDGE,pixelFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,samplingMode:h.cw.NEAREST,width:1,height:1}),r=Ce.f.createVertex(n,h.l1.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),a=new Se.U(n,new Map([["position",0]]),{geometry:[new Je.G("position",2,h.g.UNSIGNED_SHORT,0,4)]},{geometry:r}),o=(0,we.f)(5633261.287538229,2626832.878767164,1434988.0495278358),l=(0,we.f)(5633271.46742708,2626873.6381334523,1434963.231608387),c=function i(F,v){const A=n.programCache.acquire(`\n\n  precision highp float;\n\n  attribute vec2 position;\n\n  uniform vec3 u_highA;\n  uniform vec3 u_lowA;\n  uniform vec3 u_highB;\n  uniform vec3 u_lowB;\n\n  varying vec4 v_color;\n\n  ${e?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}\n\n  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION\n\n  vec3 dpPlusFrc(vec3 a, vec3 b) {\n    return mix(a, a + b, vec3(notEqual(b, vec3(0))));\n  }\n\n  vec3 dpMinusFrc(vec3 a, vec3 b) {\n    return mix(vec3(0), a - b, vec3(notEqual(a, b)));\n  }\n\n  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {\n    vec3 t1 = dpPlusFrc(hiA, hiB);\n    vec3 e = dpMinusFrc(t1, hiA);\n    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;\n    return t1 + t2;\n  }\n\n  #else\n\n  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {\n    vec3 t1 = hiA + hiB;\n    vec3 e = t1 - hiA;\n    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;\n    return t1 + t2;\n  }\n\n  #endif\n\n  const float MAX_RGBA_FLOAT =\n    255.0 / 256.0 +\n    255.0 / 256.0 / 256.0 +\n    255.0 / 256.0 / 256.0 / 256.0 +\n    255.0 / 256.0 / 256.0 / 256.0 / 256.0;\n\n  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);\n\n  vec4 float2rgba(const float value) {\n    // Make sure value is in the domain we can represent\n    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);\n\n    // Decompose value in 32bit fixed point parts represented as\n    // uint8 rgba components. Decomposition uses the fractional part after multiplying\n    // by a power of 256 (this removes the bits that are represented in the previous\n    // component) and then converts the fractional part to 8bits.\n    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);\n\n    // Convert uint8 values (from 0 to 255) to floating point representation for\n    // the shader\n    const float toU8AsFloat = 1.0 / 255.0;\n\n    return fixedPointU8 * toU8AsFloat;\n  }\n\n  void main() {\n    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);\n\n    v_color = float2rgba(val.z / 25.0);\n\n    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);\n  }\n  `,"\n  precision highp float;\n\n  varying vec4 v_color;\n\n  void main() {\n    gl_FragColor = v_color;\n  }\n  ",new Map([["position",0]])),R=new Float32Array(6);(0,Di.LF)(F,R,3);const S=new Float32Array(6);return(0,Di.LF)(v,S,3),n.useProgram(A),A.setUniform3f("u_highA",R[0],R[2],R[4]),A.setUniform3f("u_lowA",R[1],R[3],R[5]),A.setUniform3f("u_highB",S[0],S[2],S[4]),A.setUniform3f("u_lowB",S[1],S[3],S[5]),A}(o,l),u=n.getBoundFramebufferObject(),{x:f,y:d,width:m,height:g}=n.getViewport();n.bindFramebuffer(t),n.setViewport(0,0,1,1),n.bindVAO(a),n.drawArrays(h.MX.TRIANGLE_STRIP,0,4);const p=new Uint8Array(4);t.readPixels(0,0,1,1,h.VI.RGBA,h.Br.UNSIGNED_BYTE,p),c.dispose(),a.dispose(!1),r.dispose(),t.dispose(),n.setViewport(f,d,m,g),n.bindFramebuffer(u);const _=(o[2]-l[2])/25,E=(0,ri.v)(p);return Math.abs(_-E)}var Ui,Ni,bn=b(88569),zi={exports:{}};Ui=zi,void 0!==(Ni=function(){var t={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},i=null,r=null;function a(_){if(null==i)for(var E in i={},r={},_)"number"==typeof _[E]&&(i[_[E]]=E,r[E]=_[E])}function o(){if(null==i)throw"WebGLDebugUtils.init(ctx) not called"}function c(_){o();var E=i[_];return void 0!==E?"gl."+E:"/*UNKNOWN WebGL ENUM*/ 0x"+_.toString(16)}function u(_,E,F,v){var w;if(void 0!==(w=t[_])&&void 0!==(w=w[E])&&w[F]){if("object"==typeof w[F]&&void 0!==w[F].enumBitwiseOr){for(var x=w[F].enumBitwiseOr,A=0,R=[],S=0;S<x.length;++S){var B=r[x[S]];0!=(v&B)&&(A|=B,R.push(c(B)))}return A===v?R.join(" | "):c(v)}return c(v)}return null===v?"null":void 0===v?"undefined":v.toString()}function d(_,E,F){_.__defineGetter__(F,function(){return E[F]}),_.__defineSetter__(F,function(v){E[F]=v})}function g(_){var E=_.getParameter(_.MAX_VERTEX_ATTRIBS),F=_.createBuffer();_.bindBuffer(_.ARRAY_BUFFER,F);for(var v=0;v<E;++v)_.disableVertexAttribArray(v),_.vertexAttribPointer(v,4,_.FLOAT,!1,0,0),_.vertexAttrib1f(v,0);_.deleteBuffer(F);var w=_.getParameter(_.MAX_TEXTURE_IMAGE_UNITS);for(v=0;v<w;++v)_.activeTexture(_.TEXTURE0+v),_.bindTexture(_.TEXTURE_CUBE_MAP,null),_.bindTexture(_.TEXTURE_2D,null);for(_.activeTexture(_.TEXTURE0),_.useProgram(null),_.bindBuffer(_.ARRAY_BUFFER,null),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),_.bindFramebuffer(_.FRAMEBUFFER,null),_.bindRenderbuffer(_.RENDERBUFFER,null),_.disable(_.BLEND),_.disable(_.CULL_FACE),_.disable(_.DEPTH_TEST),_.disable(_.DITHER),_.disable(_.SCISSOR_TEST),_.blendColor(0,0,0,0),_.blendEquation(_.FUNC_ADD),_.blendFunc(_.ONE,_.ZERO),_.clearColor(0,0,0,0),_.clearDepth(1),_.clearStencil(-1),_.colorMask(!0,!0,!0,!0),_.cullFace(_.BACK),_.depthFunc(_.LESS),_.depthMask(!0),_.depthRange(0,1),_.frontFace(_.CCW),_.hint(_.GENERATE_MIPMAP_HINT,_.DONT_CARE),_.lineWidth(1),_.pixelStorei(_.PACK_ALIGNMENT,4),_.pixelStorei(_.UNPACK_ALIGNMENT,4),_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!1),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_.UNPACK_COLORSPACE_CONVERSION_WEBGL&&_.pixelStorei(_.UNPACK_COLORSPACE_CONVERSION_WEBGL,_.BROWSER_DEFAULT_WEBGL),_.polygonOffset(0,0),_.sampleCoverage(1,!1),_.scissor(0,0,_.canvas.width,_.canvas.height),_.stencilFunc(_.ALWAYS,0,4294967295),_.stencilMask(4294967295),_.stencilOp(_.KEEP,_.KEEP,_.KEEP),_.viewport(0,0,_.canvas.width,_.canvas.height),_.clear(_.COLOR_BUFFER_BIT|_.DEPTH_BUFFER_BIT|_.STENCIL_BUFFER_BIT);_.getError(););}return{init:a,mightBeEnum:function l(_){return o(),void 0!==i[_]},glEnumToString:c,glFunctionArgToString:u,glFunctionArgsToString:function f(_,E){for(var F="",v=E.length,w=0;w<v;++w)F+=(0==w?"":", ")+u(_,v,w,E[w]);return F},makeDebugContext:function m(_,E,F,v){v=v||_,a(_),E=E||function(B,U,X){for(var he="",ue=X.length,V=0;V<ue;++V)he+=(0==V?"":", ")+u(U,ue,V,X[V]);!function(_){window.console&&window.console.error?window.console.error(_):function(_){window.console&&window.console.log&&window.console.log(_)}(_)}("WebGL error "+c(B)+" in "+U+"("+he+")")};var w={};function x(B,U){return function(){F&&F(U,arguments);var X=B[U].apply(B,arguments),he=v.getError();return 0!=he&&(w[he]=!0,E(he,U,arguments)),X}}var A={};for(var R in _)if("function"==typeof _[R])if("getExtension"!=R)A[R]=x(_,R);else{var S=x(_,R);A[R]=function(){return m(S.apply(_,arguments),E,F,v)}}else d(A,_,R);return A.getError=function(){for(var B in w)if(w.hasOwnProperty(B)&&w[B])return w[B]=!1,B;return _.NO_ERROR},A},makeLostContextSimulatingCanvas:function p(_){var E,F,v=[],w=[],x={},A=1,R=!1,S=[],B=0,U=0,X=!1,he=0,ue={};function V(C){return"function"==typeof C?C:function(O){C.handleEvent(O)}}_.getContext=(F=_.getContext,function(){var C=F.apply(_,arguments);if(C instanceof WebGLRenderingContext){if(C!=E){if(E)throw"got different context";x=Fa(E=C)}return x}return C});var W=function(C){v.push(V(C))},L=function(C){w.push(V(C))};function ve(){++U,R||B==U&&_.loseContext()}function lt(C,O){var ie=C[O];return function(){if(ve(),!R)return ie.apply(C,arguments)}}function Ki(C){return{statusMessage:C,preventDefault:function(){X=!0}}}return function Ne(C){var O=C.addEventListener;C.addEventListener=function(ie,re,Te){switch(ie){case"webglcontextlost":W(re);break;case"webglcontextrestored":L(re);break;default:O.apply(C,arguments)}}}(_),_.loseContext=function(){if(!R){for(R=!0,B=0,++A;E.getError(););(function oe(){for(var C=Object.keys(ue),O=0;O<C.length;++O)delete ue[C]})(),ue[E.CONTEXT_LOST_WEBGL]=!0;var C=Ki("context lost"),O=v.slice();setTimeout(function(){for(var ie=0;ie<O.length;++ie)O[ie](C);he>=0&&setTimeout(function(){_.restoreContext()},he)},0)}},_.restoreContext=function(){R&&w.length&&setTimeout(function(){if(!X)throw"can not restore. webglcontestlost listener did not call event.preventDefault";(function Ra(){for(var C=0;C<S.length;++C){var O=S[C];O instanceof WebGLBuffer?E.deleteBuffer(O):O instanceof WebGLFramebuffer?E.deleteFramebuffer(O):O instanceof WebGLProgram?E.deleteProgram(O):O instanceof WebGLRenderbuffer?E.deleteRenderbuffer(O):O instanceof WebGLShader?E.deleteShader(O):O instanceof WebGLTexture&&E.deleteTexture(O)}})(),g(E),R=!1,U=0,X=!1;for(var C=w.slice(),O=Ki("context restored"),ie=0;ie<C.length;++ie)C[ie](O)},0)},_.loseContextInNCalls=function(C){if(R)throw"You can not ask a lost contet to be lost";B=U+C},_.getNumCalls=function(){return U},_.setRestoreTimeout=function(C){he=C},_;function Fa(C){for(var O in C)"function"==typeof C[O]?x[O]=lt(C,O):d(x,C,O);x.getError=function(){if(ve(),!R)for(;j=E.getError();)ue[j]=!0;for(var j in ue)if(ue[j])return delete ue[j],j;return x.NO_ERROR};for(var ie=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],re=0;re<ie.length;++re){var Te=ie[re];x[Te]=function(j){return function(){if(ve(),R)return null;var Wt=j.apply(C,arguments);return Wt.__webglDebugContextLostId__=A,S.push(Wt),Wt}}(C[Te])}var $i=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(re=0;re<$i.length;++re)x[Te=$i[re]]=function(j){return function(){return ve(),R?null:j.apply(C,arguments)}}(x[Te]);var j,qi=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(re=0;re<qi.length;++re)x[Te=qi[re]]=function(j){return function(){return ve(),!R&&j.apply(C,arguments)}}(x[Te]);return x.checkFramebufferStatus=(j=x.checkFramebufferStatus,function(){return ve(),R?x.FRAMEBUFFER_UNSUPPORTED:j.apply(C,arguments)}),x.getAttribLocation=function(j){return function(){return ve(),R?-1:j.apply(C,arguments)}}(x.getAttribLocation),x.getVertexAttribOffset=function(j){return function(){return ve(),R?0:j.apply(C,arguments)}}(x.getVertexAttribOffset),x.isContextLost=function(){return R},x}},resetToInitialState:g}}())&&(Ui.exports=Ni);const Tn=Ye.Z.getLogger("esri.views.WebGLDriverTest");function Ut(){return(Ut=(0,M.Z)(function*(n){const e=new Image;if(e.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",e.width=5,e.height=5,yield e.decode(),!n.gl)return!0;const t=new Z.X(n,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE},{target:h.No.TEXTURE_2D,wrapMode:h.e8.CLAMP_TO_EDGE,pixelFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,samplingMode:h.cw.NEAREST,width:1,height:1}),i=Ce.f.createVertex(n,h.l1.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),r=new Se.U(n,new Map([["a_pos",0]]),xt.cD,{geometry:i}),l=n.programCache.acquire("\n  precision highp float;\n\n  attribute vec2 a_pos;\n  varying vec2 v_uv;\n\n  void main() {\n    v_uv = a_pos;\n    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n  }\n  ","\n  precision highp float;\n\n  varying vec2 v_uv;\n  uniform sampler2D u_texture;\n\n  void main() {\n    gl_FragColor = texture2D(u_texture, v_uv);\n  }\n  ",new Map([["a_pos",0]]));n.useProgram(l);const c=new K.x(n,{dataType:h.Br.UNSIGNED_BYTE,pixelFormat:h.VI.RGBA,preMultiplyAlpha:!1,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR},e);n.bindTexture(c,0),l.setUniform1i("u_texture",0);const u=n.getBoundFramebufferObject(),{x:f,y:d,width:m,height:g}=n.getViewport();n.bindFramebuffer(t),n.setViewport(0,0,1,1),n.setClearColor(0,0,0,0),n.setBlendingEnabled(!1),n.clearSafe(h.lk.COLOR_BUFFER_BIT),n.bindVAO(r),n.drawArrays(h.MX.TRIANGLE_STRIP,0,4);const p=new Uint8Array(4);return t.readPixels(0,0,1,1,h.VI.RGBA,h.Br.UNSIGNED_BYTE,p),l.dispose(),r.dispose(!1),i.dispose(),t.dispose(),c.dispose(),n.setViewport(f,d,m,g),n.bindFramebuffer(u),e.src="",255===p[0]})).apply(this,arguments)}class wn{constructor(e){this.context=e,this._floatBufferBlendWorking=function En(n){var p,_,E,F,v;if(!n.gl)return!1;if(n.type===et.zO.WEBGL1)return!(!(null==(p=n.capabilities.textureFloat)?void 0:p.textureFloat)||!(null==(_=n.capabilities.colorBufferFloat)?void 0:_.textureFloat));if(!((null==(E=n.capabilities.textureFloat)?void 0:E.textureFloat)&&(null==(F=n.capabilities.colorBufferFloat)?void 0:F.textureFloat)&&(null==(v=n.capabilities.colorBufferFloat)?void 0:v.floatBlend)))return!1;const e=new Z.X(n,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE},{target:h.No.TEXTURE_2D,wrapMode:h.e8.CLAMP_TO_EDGE,pixelFormat:h.VI.RGBA,dataType:h.Br.FLOAT,internalFormat:h.lP.RGBA32F,samplingMode:h.cw.NEAREST,width:1,height:1}),t=Ce.f.createVertex(n,h.l1.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),i=new Se.U(n,new Map([["a_pos",0]]),{geometry:[new Je.G("a_pos",2,h.g.UNSIGNED_SHORT,0,4)]},{geometry:t}),o=n.programCache.acquire("\n  precision highp float;\n  attribute vec2 a_pos;\n\n  void main() {\n    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n  }\n  ","\n   precision highp float;\n\n   void main() {\n    gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);\n   }\n  ",new Map([["a_pos",0]]));n.useProgram(o);const l=n.getBoundFramebufferObject(),{x:c,y:u,width:f,height:d}=n.getViewport();n.bindFramebuffer(e),n.setViewport(0,0,1,1),n.bindVAO(i),n.drawArrays(h.MX.TRIANGLE_STRIP,0,4);const m=(0,Oi.sm)({blending:bn.IB});n.setPipelineState(m),n.drawArrays(h.MX.TRIANGLE_STRIP,0,4),zi.exports.init(n);const g=n.gl.getError();return n.setViewport(c,u,f,d),n.bindFramebuffer(l),o.dispose(),i.dispose(!1),t.dispose(),e.dispose(),1282!==g||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}(e),function yn(n){return Ut.apply(this,arguments)}(e).then(t=>this._svgAlwaysPremultipliesAlpha=!t)}get floatBufferBlendWorking(){if((0,y.Wi)(this._floatBufferBlendWorking))throw new Error("floatBufferBlendWorking test not yet available");return this._floatBufferBlendWorking}get svgAlwaysPremultipliesAlpha(){if((0,y.Wi)(this._svgAlwaysPremultipliesAlpha))throw new Error("svgAlwaysPremultipliesAlpha test not yet available");return this._svgAlwaysPremultipliesAlpha}get doublePrecisionRequiresObfuscation(){if((0,y.Wi)(this._doublePrecisionRequiresObfuscation)){const e=Ii(this.context,!1),t=Ii(this.context,!0);this._doublePrecisionRequiresObfuscation=0!==e&&(0===t||e/t>5)}return this._doublePrecisionRequiresObfuscation}get ignoresSamplerPrecision(){return(0,y.Wi)(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=function xn(n){const e=new Z.X(n,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.NONE},{target:h.No.TEXTURE_2D,wrapMode:h.e8.CLAMP_TO_EDGE,pixelFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,samplingMode:h.cw.NEAREST,width:1,height:1}),r=new Uint8Array(4),a=Ce.f.createVertex(n,h.l1.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),o=new Se.U(n,new Map([["a_position",0]]),{geometry:[new Je.G("a_position",2,h.g.SHORT,0,4)]},{geometry:a}),l=n.programCache.acquire("\nprecision highp float;\nattribute vec2 a_pos;\nuniform highp sampler2D u_texture;\nvarying vec4 v_color;\n\nfloat getBit(in float bitset, in int bitIndex) {\n  float offset = pow(2.0, float(bitIndex));\n  return mod(floor(bitset / offset), 2.0);\n}\n\nvoid main() {\n  vec4 value = texture2D(u_texture, vec2(0.0));\n  float bit = getBit(value.x * 255.0, 1);\n\n  v_color = bit * vec4(1.0);\n  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n}\n","\nprecision highp float;\nvarying vec4 v_color;\n\nvoid main() {\n  gl_FragColor = v_color;\n}\n",new Map([["a_pos",0]]));n.useProgram(l);const c=new K.x(n,{target:h.No.TEXTURE_2D,wrapMode:h.e8.CLAMP_TO_EDGE,pixelFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,samplingMode:h.cw.NEAREST,width:1,height:1},new Uint8Array([2,255,0,0]));l.setUniform1i("u_texture",0),n.bindTexture(c,0);const u=n.getBoundFramebufferObject();n.bindFramebuffer(e),n.useProgram(l);const{x:f,y:d,width:m,height:g}=n.getViewport();n.setViewport(0,0,1,1),n.bindVAO(o),n.drawArrays(h.MX.TRIANGLE_STRIP,0,4),n.setViewport(f,d,m,g),e.readPixels(0,0,1,1,h.VI.RGBA,h.Br.UNSIGNED_BYTE,r),l.dispose(),o.dispose(!1),a.dispose(),e.dispose();const p=255!==r[0]||255!==r[1]||255!==r[2]||255!==r[3];return p&&Tn.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${r[0]}.${r[1]}.${r[2]}.${r[3]}]`),n.bindFramebuffer(u),p}(this.context)),this._ignoresSamplerPrecision}}function tt(n,e,t,i,r){if(i&&(0,$.Z)(n))return!0;if(e[t])return!1;for(const a of r)if(n.getExtension(a))return!0;return!1}class Un{constructor(e,t){this.gl=e,this._depthTexture=null,this._standardDerivatives=null,this._shaderTextureLOD=null,this._fragDepth=null,this._textureFloatLinear=null,this._disabledExtensions=t.disabledExtensions||{},this._debugWebGLExtensions=t.debugWebGLExtensions||{}}get drawBuffers(){return this._drawBuffers||(this._drawBuffers=function Rn(n,e){if(e.disjointTimerQuery)return null;if((0,$.Z)(n))return{drawBuffers:n.drawBuffers.bind(n),MAX_DRAW_BUFFERS:n.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:n.MAX_COLOR_ATTACHMENTS};if(e.drawBuffers)return null;const t=n.getExtension("WEBGL_draw_buffers");return t?{drawBuffers:t.drawBuffersWEBGL.bind(t),MAX_DRAW_BUFFERS:t.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:t.MAX_COLOR_ATTACHMENTS_WEBGL}:null}(this.gl,this._disabledExtensions)),this._drawBuffers}get instancing(){return this._instancing||(this._instancing=function Fn(n){if((0,$.Z)(n))return{drawArraysInstanced:n.drawArraysInstanced.bind(n),drawElementsInstanced:n.drawElementsInstanced.bind(n),vertexAttribDivisor:n.vertexAttribDivisor.bind(n)};const e=n.getExtension("ANGLE_instanced_arrays");return e?{drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e),vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e)}:null}(this.gl)),this._instancing}get vao(){return this._vertexArrayObject||(this._vertexArrayObject=function In(n,e){if((0,$.Z)(n))return{createVertexArray:n.createVertexArray.bind(n),deleteVertexArray:n.deleteVertexArray.bind(n),bindVertexArray:n.bindVertexArray.bind(n)};if(e.vao)return null;const t=n.getExtension("OES_vertex_array_object")||n.getExtension("MOZ_OES_vertex_array_object")||n.getExtension("WEBKIT_OES_vertex_array_object");return t?{createVertexArray:t.createVertexArrayOES.bind(t),deleteVertexArray:t.deleteVertexArrayOES.bind(t),bindVertexArray:t.bindVertexArrayOES.bind(t)}:null}(this.gl,this._disabledExtensions)),this._vertexArrayObject}get compressedTextureETC(){return this._compressedTextureETC||(this._compressedTextureETC=function Bn(n,e){if(e.compressedTextureETC)return null;const t=n.getExtension("WEBGL_compressed_texture_etc");return t?{COMPRESSED_R11_EAC:t.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:t.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:t.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:t.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:t.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:t.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:t.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}(this.gl,this._disabledExtensions)),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC||(this._compressedTextureS3TC=function An(n,e){if(e.compressedTextureS3TC)return null;const t=n.getExtension("WEBGL_compressed_texture_s3tc");return t?{COMPRESSED_RGB_S3TC_DXT1:t.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:t.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:t.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:t.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}(this.gl,this._disabledExtensions)),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic||(this._textureFilterAnisotropic=function Sn(n,e){if(e.textureFilterAnisotropic)return null;const t=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return t?{MAX_TEXTURE_MAX_ANISOTROPY:t.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:t.TEXTURE_MAX_ANISOTROPY_EXT}:null}(this.gl,this._disabledExtensions)),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery||(this._disjointTimerQuery=Ci(this.gl,this._disabledExtensions)),this._disjointTimerQuery}get textureFloat(){return this._textureFloat||(this._textureFloat=function Mn(n,e){if((0,$.Z)(n))return{textureFloat:!0,textureFloatLinear:!e.textureFloatLinear&&!!n.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!0,HALF_FLOAT:n.HALF_FLOAT,R16F:n.R16F,RG16F:n.RG16F,RGBA16F:n.RGBA16F,R32F:n.R32F,RG32F:n.RG32F,RGBA32F:n.RGBA32F,R11F_G11F_B10F:n.R11F_G11F_B10F,RGB16F:n.RGB16F};if(n instanceof WebGLRenderingContext){const t=!e.textureHalfFloat&&n.getExtension("OES_texture_half_float");return{textureFloat:!e.textureFloat&&!!n.getExtension("OES_texture_float"),textureFloatLinear:!e.textureFloatLinear&&!!n.getExtension("OES_texture_float_linear"),textureHalfFloat:!!t,textureHalfFloatLinear:!e.textureHalfFloatLinear&&!!n.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:t?t.HALF_FLOAT_OES:void 0}}return null}(this.gl,this._disabledExtensions)),this._textureFloat}get colorBufferFloat(){return this._colorBufferFloat||(this._colorBufferFloat=function On(n,e){if((0,$.Z)(n)){const t=!e.colorBufferHalfFloat&&n.getExtension("EXT_color_buffer_half_float")||!e.colorBufferFloat&&n.getExtension("EXT_color_buffer_float"),i=!e.colorBufferFloat&&n.getExtension("EXT_color_buffer_float"),r=!e.floatBlend&&!e.colorBufferFloat&&n.getExtension("EXT_float_blend");return t||i||r?{textureFloat:!!i,textureHalfFloat:!!t,floatBlend:!!r,R16F:n.R16F,RG16F:n.RG16F,RGBA16F:n.RGBA16F,R32F:n.R32F,RG32F:n.RG32F,RGBA32F:n.RGBA32F,R11F_G11F_B10F:n.R11F_G11F_B10F,RGB16F:n.RGB16F}:null}if(n instanceof WebGLRenderingContext){const t=!e.colorBufferHalfFloat&&n.getExtension("EXT_color_buffer_half_float"),i=!e.colorBufferFloat&&n.getExtension("WEBGL_color_buffer_float"),r=!e.floatBlend&&!e.colorBufferFloat&&n.getExtension("EXT_float_blend");return t||i||r?{textureFloat:!!i,textureHalfFloat:!!t,floatBlend:!!r,RGBA16F:t?t.RGBA16F_EXT:void 0,RGB16F:t?t.RGB16F_EXT:void 0,RGBA32F:i?i.RGBA32F_EXT:void 0}:null}return null}(this.gl,this._disabledExtensions)),this._colorBufferFloat}get blendMinMax(){return this._minMaxBlending||(this._minMaxBlending=function Cn(n,e){if((0,$.Z)(n))return{MIN:n.MIN,MAX:n.MAX};if(e.blendMinMax)return null;{const t=n.getExtension("EXT_blend_minmax");return t?{MIN:t.MIN_EXT,MAX:t.MAX_EXT}:null}}(this.gl,this._disabledExtensions)),this._minMaxBlending}get depthTexture(){return null===this._depthTexture&&(this._depthTexture=tt(this.gl,this._disabledExtensions,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),this._depthTexture}get standardDerivatives(){return null===this._standardDerivatives&&(this._standardDerivatives=tt(this.gl,this._disabledExtensions,"standardDerivatives",!0,["OES_standard_derivatives"])),this._standardDerivatives}get shaderTextureLOD(){return null===this._shaderTextureLOD&&(this._shaderTextureLOD=tt(this.gl,this._disabledExtensions,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),this._shaderTextureLOD}get fragDepth(){return null===this._fragDepth&&(this._fragDepth=tt(this.gl,this._disabledExtensions,"fragDepth",!0,["EXT_frag_depth"])),this._fragDepth}get loseContext(){return this._loseContext||(this._loseContext=function Dn(n,e){const t=e.loseContext&&n.getExtension("WEBGL_lose_context");return t?{loseRenderingContext:()=>t.loseContext()}:null}(this.gl,this._debugWebGLExtensions)),this._loseContext}get textureNorm16(){return this._textureNorm16||(this._textureNorm16=function Pn(n,e){if(!(0,$.Z)(n)||e.textureNorm16)return null;const t=n.getExtension("EXT_texture_norm16");return t?{R16:t.R16_EXT,RG16:t.RG16_EXT,RGB16:t.RGB16_EXT,RGBA16:t.RGBA16_EXT,R16_SNORM:t.R16_SNORM_EXT,RG16_SNORM:t.RG16_SNORM_EXT,RGB16_SNORM:t.RGB16_SNORM_EXT,RGBA16_SNORM:t.RGBA16_SNORM_EXT}:null}(this.gl,this._disabledExtensions)),this._textureNorm16}get textureFloatLinear(){return null===this._textureFloatLinear&&(this._textureFloatLinear=tt(this.gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"])),this._textureFloatLinear}enable(e){return this[e]}}class Ln{constructor(e,t){this.gl=e,this.instanceCounter=new gn,this.programCache=new vn.G(this),this._state=new Mi,this._numOfDrawCalls=0,this._numOfTriangles=0,this.type=(0,$.Z)(e)?et.zO.WEBGL2:et.zO.WEBGL1,this._loadExtensions(),this.configure(t)}configure(e){this._capabilities=new Un(this.gl,e),this._parameters=this._loadParameters(e);const t=this.gl.getParameter(this.gl.VIEWPORT);this._state=new Mi,this._state.viewport={x:t[0],y:t[1],width:t[2],height:t[3]},this._stateTracker=new Oi.jp({setBlending:i=>{if(i){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(i.opRgb,i.opAlpha),this.setBlendFunctionSeparate(i.srcRgb,i.dstRgb,i.srcAlpha,i.dstAlpha);const r=i.color;this.setBlendColor(r.r,r.g,r.b,r.a)}else this.setBlendingEnabled(!1)},setCulling:i=>{i?(this.setFaceCullingEnabled(!0),this.setCullFace(i.face),this.setFrontFace(i.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:i=>{i?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(i.factor,i.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:i=>{i?(this.setDepthTestEnabled(!0),this.setDepthFunction(i.func)):this.setDepthTestEnabled(!1)},setStencilTest:i=>{if(i){this.setStencilTestEnabled(!0);const r=i.function;this.setStencilFunction(r.func,r.ref,r.mask);const a=i.operation;this.setStencilOp(a.fail,a.zFail,a.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:i=>{i?(this.setDepthWriteEnabled(!0),this.setDepthRange(i.zNear,i.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:i=>{i?this.setColorMask(i.r,i.g,i.b,i.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:i=>{this.setStencilWriteMask(i?i.mask:0)}}),this.enforceState(),this._driverTest=new wn(this)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}dispose(){this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(h.w0.ARRAY_BUFFER),this.unbindBuffer(h.w0.ELEMENT_ARRAY_BUFFER),(0,$.Z)(this.gl)&&(this.unbindBuffer(h.w0.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(h.w0.PIXEL_PACK_BUFFER),this.unbindBuffer(h.w0.PIXEL_UNPACK_BUFFER),this.unbindBuffer(h.w0.COPY_READ_BUFFER),this.unbindBuffer(h.w0.COPY_WRITE_BUFFER)),this._state.textureUnitMap.length=0,(0,Fe.hZ)()&&this.instanceCounter.printResourceCount()}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._state.blend!==e&&(!0===e?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var e;null==(e=this._state.program)||e.stop(),this._state.program=null}externalTextureUnitUpdate(e,t){for(let i=0;i<e.length;++i)this._state.textureUnitMap[e[i]]=null;t>=0&&(this._state.activeTexture=t)}externalVertexArrayObjectUpdate(){const e=this.capabilities.vao;e&&(e.bindVertexArray(null),this._state.vertexArrayObject=null),this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(e,t,i,r){e===this._state.blendColor.r&&t===this._state.blendColor.g&&i===this._state.blendColor.b&&r===this._state.blendColor.a||(this.gl.blendColor(e,t,i,r),this._state.blendColor.r=e,this._state.blendColor.g=t,this._state.blendColor.b=i,this._state.blendColor.a=r,this._stateTracker.invalidateBlending())}setBlendFunction(e,t){e===this._state.blendFunction.srcRGB&&t===this._state.blendFunction.dstRGB||(this.gl.blendFunc(e,t),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=e,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=t,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,t,i,r){this._state.blendFunction.srcRGB===e&&this._state.blendFunction.srcAlpha===i&&this._state.blendFunction.dstRGB===t&&this._state.blendFunction.dstAlpha===r||(this.gl.blendFuncSeparate(e,t,i,r),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=i,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=r,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._state.blendEquation.mode!==e&&(this.gl.blendEquation(e),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,t){this._state.blendEquation.mode===e&&this._state.blendEquation.modeAlpha===t||(this.gl.blendEquationSeparate(e,t),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setColorMask(e,t,i,r){this._state.colorMask.r===e&&this._state.colorMask.g===t&&this._state.colorMask.b===i&&this._state.colorMask.a===r||(this.gl.colorMask(e,t,i,r),this._state.colorMask.r=e,this._state.colorMask.g=t,this._state.colorMask.b=i,this._state.colorMask.a=r,this._stateTracker.invalidateColorWrite())}setClearColor(e,t,i,r){this._state.clearColor.r===e&&this._state.clearColor.g===t&&this._state.clearColor.b===i&&this._state.clearColor.a===r||(this.gl.clearColor(e,t,i,r),this._state.clearColor.r=e,this._state.clearColor.g=t,this._state.clearColor.b=i,this._state.clearColor.a=r)}setFaceCullingEnabled(e){this._state.faceCulling!==e&&(!0===e?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._state.polygonOffsetFill!==e&&(!0===e?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,t){this._state.polygonOffset[0]===e&&this._state.polygonOffset[1]===t||(this._state.polygonOffset[0]=e,this._state.polygonOffset[1]=t,this.gl.polygonOffset(e,t),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._state.cullFace!==e&&(this.gl.cullFace(e),this._state.cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._state.frontFace!==e&&(this.gl.frontFace(e),this._state.frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._state.scissorTest!==e&&(!0===e?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=e)}setScissorRect(e,t,i,r){this._state.scissorRect.x===e&&this._state.scissorRect.y===t&&this._state.scissorRect.width===i&&this._state.scissorRect.height===r||(this.gl.scissor(e,t,i,r),this._state.scissorRect.x=e,this._state.scissorRect.y=t,this._state.scissorRect.width=i,this._state.scissorRect.height=r)}setDepthTestEnabled(e){this._state.depthTest!==e&&(!0===e?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._state.clearDepth!==e&&(this.gl.clearDepth(e),this._state.clearDepth=e)}setDepthFunction(e){this._state.depthFunction!==e&&(this.gl.depthFunc(e),this._state.depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._state.depthWrite!==e&&(this.gl.depthMask(e),this._state.depthWrite=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,t){this._state.depthRange.zNear===e&&this._state.depthRange.zFar===t||(this.gl.depthRange(e,t),this._state.depthRange.zNear=e,this._state.depthRange.zFar=t,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._state.stencilTest!==e&&(!0===e?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._state.clearStencil&&(this.gl.clearStencil(e),this._state.clearStencil=e)}setStencilFunction(e,t,i){this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===t&&this._state.stencilFunction.mask===i||(this.gl.stencilFunc(e,t,i),this._state.stencilFunction.face=h.LR.FRONT_AND_BACK,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=t,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,t,i,r){this._state.stencilFunction.face===e&&this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===r||(this.gl.stencilFuncSeparate(e,t,i,r),this._state.stencilFunction.face=e,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._state.stencilWriteMask!==e&&(this.gl.stencilMask(e),this._state.stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,t,i){this._state.stencilOperation.face===h.LR.FRONT_AND_BACK&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===t&&this._state.stencilOperation.zPass===i||(this.gl.stencilOp(e,t,i),this._state.stencilOperation.face=h.LR.FRONT_AND_BACK,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=t,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,t,i,r){this._state.stencilOperation.face===e&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===r||(this.gl.stencilOpSeparate(e,t,i,r),this._state.stencilOperation.face=e,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,t=!1){const i=this._state.activeTexture;return e>=0&&(t||e!==this._state.activeTexture)&&(this.gl.activeTexture(h.Ld+e),this._state.activeTexture=e),i}clear(e){e&&this.gl.clear(e)}clearSafe(e,t=255){e&&(e&h.lk.COLOR_BUFFER_BIT&&this.setColorMask(!0,!0,!0,!0),e&h.lk.DEPTH_BUFFER_BIT&&this.setDepthWriteEnabled(!0),e&h.lk.STENCIL_BUFFER_BIT&&this.setStencilWriteMask(t),this.gl.clear(e))}drawArrays(e,t,i){if((0,Fe.hZ)()&&(this._numOfDrawCalls++,this._numOfTriangles+=Gi(e,i)),this.gl.drawArrays(e,t,i),(0,Fe.hZ)()){const r=(0,Pi.HH)(this);r&&console.error("drawArrays:",r)}}drawElements(e,t,i,r){var a;if((0,Fe.hZ)()&&(this._numOfDrawCalls++,this._numOfTriangles+=Gi(e,t)),this.gl.drawElements(e,t,i,r),(0,Fe.hZ)()){const o=(0,Pi.HH)(this);if(o){const l=this.getBoundVAO(),c=null==l?void 0:l.indexBuffer,f={indexBuffer:c,vertexBuffers:null==l?void 0:l.vertexBuffers},d={mode:e,count:t,type:i,offset:r},m=null!=(a=(0,y.yw)(c,_=>_.size))?a:0,g=r+t;console.error(`drawElements: ${o}${m<g?`. Buffer is too small. Attempted to draw index ${g} of ${m}`:""}`,{args:d,vao:f})}}}logInfo(){(0,Fe.hZ)()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){(0,Fe.hZ)()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(e,t,i,r){i=Math.max(Math.round(i),1),r=Math.max(Math.round(r),1);const a=this._state.viewport;a.x===e&&a.y===t&&a.width===i&&a.height===r||(a.x=e,a.y=t,a.width=i,a.height=r,this.gl.viewport(e,t,i,r))}getViewport(){return{x:this._state.viewport.x,y:this._state.viewport.y,width:this._state.viewport.width,height:this._state.viewport.height}}useProgram(e){var t,i;this._state.program!==e&&(null==(t=this._state.program)||t.stop(),this._state.program=e,this.gl.useProgram(null!=(i=null==e?void 0:e.glName)?i:null))}bindTexture(e,t,i=!1){(t>=this.parameters.maxTextureImageUnits||t<0)&&console.error("Input texture unit is out of range of available units!");const r=this._state.textureUnitMap[t];return(0,y.Wi)(e)||null==e.glName?((0,y.pC)(r)&&(this.setActiveTexture(t,i),this.gl.bindTexture(r.descriptor.target,null)),this._state.textureUnitMap[t]=null,r):i||r!==e?(this.setActiveTexture(t,i),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._state.textureUnitMap[t]=e,r):(e.isDirty&&(this.setActiveTexture(t,i),e.applyChanges()),r)}unbindTexture(e){if(!(0,y.Wi)(e))for(let t=0;t<this.parameters.maxTextureImageUnits;t++)this._state.textureUnitMap[t]===e&&(this.bindTexture(null,t),this._state.textureUnitMap[t]=null)}bindFramebuffer(e,t=!1){if(t||this._state.readFramebuffer!==e||this._state.drawFramebuffer!==e){if((0,y.Wi)(e))return this.gl.bindFramebuffer(h.qi.FRAMEBUFFER,null),this._state.readFramebuffer=null,void(this._state.drawFramebuffer=null);e.initializeAndBind(h.qi.FRAMEBUFFER),this._state.readFramebuffer=e,this._state.drawFramebuffer=e}}bindFramebufferSeparate(e,t,i=!1){const r=t===h.qi.READ_FRAMEBUFFER;(i||(r?this._state.readFramebuffer:this._state.drawFramebuffer)!==e)&&((0,y.Wi)(e)?this.gl.bindFramebuffer(t,null):e.initializeAndBind(t),r?this._state.readFramebuffer=(0,y.Pt)(e,null):this._state.drawFramebuffer=(0,y.Pt)(e,null))}blitFramebuffer(e,t,i=0,r=0,a=e.width,o=e.height,l=0,c=0,u=t.width,f=t.height,d=h.lk.COLOR_BUFFER_BIT,m=h.cw.NEAREST){this.bindFramebufferSeparate(e,h.qi.READ_FRAMEBUFFER),this.bindFramebufferSeparate(t,h.qi.DRAW_FRAMEBUFFER),this.gl.blitFramebuffer(i,r,a,o,l,c,u,f,d,m)}bindBuffer(e,t){if(e)switch(null!=t||(t=e.bufferType),t){case h.w0.ARRAY_BUFFER:this._state.vertexBuffer=te(this.gl,e,t,this._state.vertexBuffer);break;case h.w0.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=te(this.gl,e,t,this._state.indexBuffer);break;case h.w0.UNIFORM_BUFFER:this._state.uniformBuffer=te(this.gl,e,t,this._state.uniformBuffer);break;case h.w0.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=te(this.gl,e,t,this._state.pixelPackBuffer);break;case h.w0.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=te(this.gl,e,t,this._state.pixelUnpackBuffer);break;case h.w0.COPY_READ_BUFFER:this._state.copyReadBuffer=te(this.gl,e,t,this._state.copyReadBuffer);break;case h.w0.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=te(this.gl,e,t,this._state.copyWriteBuffer)}}bindRenderbuffer(e){const t=this.gl;e||(t.bindRenderbuffer(t.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==e&&(t.bindRenderbuffer(t.RENDERBUFFER,e.glName),this._state.renderbuffer=e)}_getBufferBinding(e,t){if(t>=this.parameters.maxUniformBufferBindings||t<0)return console.error("Uniform buffer binding point is out of range!"),null;const i=this._state.uniformBufferBindingPoints;let r=i[t];return(0,y.Wi)(r)&&(r={buffer:null,offset:0,size:0},i[t]=r),r}bindBufferBase(e,t,i){const r=this._getBufferBinding(e,t);(0,y.Wi)(r)||r.buffer===i&&0===r.offset&&0===r.size||(this.gl.bindBufferBase(e,t,i?i.glName:null),r.buffer=i,r.offset=0,r.size=0)}bindBufferRange(e,t,i,r,a){const o=this._getBufferBinding(e,t);if(!(0,y.Wi)(o)&&(o.buffer!==i||o.offset!==r||o.size!==a)){if(r%this._parameters.uniformBufferOffsetAlignment!=0)return void console.error("Uniform buffer binding offset is not a multiple of the context offset alignment");this.gl.bindBufferRange(e,t,i.glName,r,a),o.buffer=i,o.offset=r,o.size=a}}bindUBO(e,t,i,r){(0,y.Wi)(t)?this.bindBufferBase(h.w0.UNIFORM_BUFFER,e,null):((0,Fe.hZ)()&&(null!=r?r:t.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),t.initialize(),void 0!==i&&void 0!==r?this.bindBufferRange(h.w0.UNIFORM_BUFFER,e,t.buffer,i,r):this.bindBufferBase(h.w0.UNIFORM_BUFFER,e,t.buffer))}unbindUBO(e){for(let t=0,i=this._state.uniformBufferBindingPoints.length;t<i;t++){const r=this._state.uniformBufferBindingPoints[t];(0,y.pC)(r)&&r.buffer===e.buffer&&this.bindBufferBase(h.w0.UNIFORM_BUFFER,t,null)}}unbindBuffer(e){switch(e){case h.w0.ARRAY_BUFFER:this._state.vertexBuffer=te(this.gl,null,e,this._state.vertexBuffer);break;case h.w0.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=te(this.gl,null,e,this._state.indexBuffer);break;case h.w0.UNIFORM_BUFFER:this._state.uniformBuffer=te(this.gl,null,e,this._state.uniformBuffer);break;case h.w0.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=te(this.gl,null,e,this._state.pixelPackBuffer);break;case h.w0.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=te(this.gl,null,e,this._state.pixelUnpackBuffer);break;case h.w0.COPY_READ_BUFFER:this._state.copyReadBuffer=te(this.gl,null,e,this._state.copyReadBuffer);break;case h.w0.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=te(this.gl,null,e,this._state.copyWriteBuffer)}}bindVAO(e=null){(0,y.Wi)(e)?this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null):this._state.vertexArrayObject!==e&&(e.bind(),this._state.vertexArrayObject=e)}clientWaitAsync(e=(0,ee.HA)(10)){var t=this;return(0,M.Z)(function*(){const i=t.gl,r=i.fenceSync(h.V7.SYNC_GPU_COMMANDS_COMPLETE,0);let a;t.instanceCounter.increment(h._g.Sync,r),i.flush();do{yield(0,Y.e4)(e),a=i.clientWaitSync(r,0,0)}while(a===h.Y5.TIMEOUT_EXPIRED);if(t.instanceCounter.decrement(h._g.Sync,r),i.deleteSync(r),a===h.Y5.WAIT_FAILED)throw new Error("Client wait failed")})()}getBoundFramebufferObject(e=h.qi.FRAMEBUFFER){return e===h.qi.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(h.w0.ARRAY_BUFFER),this.unbindBuffer(h.w0.ELEMENT_ARRAY_BUFFER),(0,$.Z)(this.gl)&&(this.unbindBuffer(h.w0.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(h.w0.PIXEL_PACK_BUFFER),this.unbindBuffer(h.w0.PIXEL_UNPACK_BUFFER),this.unbindBuffer(h.w0.COPY_READ_BUFFER),this.unbindBuffer(h.w0.COPY_WRITE_BUFFER));for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(h.zi.ONE,h.zi.ZERO),this.setBlendEquation(h.db.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(h.LR.BACK),this.setFrontFace(h.Wf.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(h.wb.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(h.wb.ALWAYS,0,0),this.setStencilOp(h.xS.KEEP,h.xS.KEEP,h.xS.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var i,r,a,o,l,c;const e=this.gl,t=this.capabilities.vao;t&&t.bindVertexArray(null);for(let u=0;u<this.parameters.maxVertexAttributes;u++)e.disableVertexAttribArray(u);if(this._state.vertexBuffer?e.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):e.bindBuffer(h.w0.ARRAY_BUFFER,null),this._state.indexBuffer?e.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):e.bindBuffer(h.w0.ELEMENT_ARRAY_BUFFER,null),(0,$.Z)(e)){this._state.uniformBuffer?e.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):e.bindBuffer(h.w0.UNIFORM_BUFFER,null);for(let u=0;u<this._parameters.maxUniformBufferBindings;u++){const f=this._state.uniformBufferBindingPoints[u];if((0,y.pC)(f)){const{buffer:d,offset:m,size:g}=f;null!==d?0===m&&0===g?e.bindBufferBase(h.w0.UNIFORM_BUFFER,u,d.glName):e.bindBufferRange(h.w0.UNIFORM_BUFFER,u,d.glName,m,g):e.bindBufferBase(h.w0.UNIFORM_BUFFER,u,null)}}this._state.pixelPackBuffer?e.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):e.bindBuffer(h.w0.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?e.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):e.bindBuffer(h.w0.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?e.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):e.bindBuffer(h.w0.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?e.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):e.bindBuffer(h.w0.COPY_WRITE_BUFFER,null),e.bindFramebuffer(h.qi.READ_FRAMEBUFFER,null),e.readBuffer(e.BACK),this._state.readFramebuffer&&(e.bindFramebuffer(h.qi.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),e.readBuffer(h.VY.COLOR_ATTACHMENT0)),e.bindFramebuffer(h.qi.DRAW_FRAMEBUFFER,null!=(r=null==(i=this._state.drawFramebuffer)?void 0:i.glName)?r:null)}else this._state.readFramebuffer=this._state.drawFramebuffer,e.bindFramebuffer(h.qi.FRAMEBUFFER,null!=(o=null==(a=this._state.drawFramebuffer)?void 0:a.glName)?o:null);if(t&&this._state.vertexArrayObject){const u=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(u)}e.useProgram(null!=(c=null==(l=this._state.program)?void 0:l.glName)?c:null),e.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),e.bindRenderbuffer(e.RENDERBUFFER,this._state.renderbuffer?this._state.renderbuffer.glName:null),!0===this._state.blend?e.enable(this.gl.BLEND):e.disable(this.gl.BLEND),e.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),e.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),e.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),e.clearDepth(this._state.clearDepth),e.clearStencil(this._state.clearStencil),e.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),e.cullFace(this._state.cullFace),e.depthFunc(this._state.depthFunction),e.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),!0===this._state.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(this._state.depthWrite),e.frontFace(this._state.frontFace),e.lineWidth(1),!0===this._state.faceCulling?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),!0===this._state.polygonOffsetFill?e.enable(e.POLYGON_OFFSET_FILL):e.disable(e.POLYGON_OFFSET_FILL),e.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),!0===this._state.scissorTest?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),e.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),e.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),!0===this._state.stencilTest?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),e.stencilMask(this._state.stencilWriteMask);for(let u=0;u<this.parameters.maxTextureImageUnits;u++){e.activeTexture(h.Ld+u),e.bindTexture(h.No.TEXTURE_2D,null),e.bindTexture(h.No.TEXTURE_CUBE_MAP,null),(0,$.Z)(e)&&(e.bindTexture(h.No.TEXTURE_3D,null),e.bindTexture(h.No.TEXTURE_2D_ARRAY,null));const f=this._state.textureUnitMap[u];(0,y.pC)(f)&&e.bindTexture(f.descriptor.target,f.glName)}e.activeTexture(h.Ld+this._state.activeTexture),e.viewport(this._state.viewport.x,this._state.viewport.y,this._state.viewport.width,this._state.viewport.height),this.resetInfo()}_loadExtensions(){this.type===et.zO.WEBGL1&&this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("KHR_parallel_shader_compile")}_loadParameters(e){var l;const t=this.capabilities.textureFilterAnisotropic,i=null!=(l=e.maxAnisotropy)?l:1/0,r=(0,$.Z)(this.gl),a=this.gl,o={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:t?Math.min(this.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY),i):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),maxUniformBufferBindings:r?a.getParameter(a.MAX_UNIFORM_BUFFER_BINDINGS):0,maxVertexUniformBlocks:r?a.getParameter(a.MAX_VERTEX_UNIFORM_BLOCKS):0,maxFragmentUniformBlocks:r?a.getParameter(a.MAX_FRAGMENT_UNIFORM_BLOCKS):0,maxUniformBlockSize:r?a.getParameter(a.MAX_UNIFORM_BLOCK_SIZE):0,uniformBufferOffsetAlignment:r?a.getParameter(a.UNIFORM_BUFFER_OFFSET_ALIGNMENT):1,maxArrayTextureLayers:r?a.getParameter(a.MAX_ARRAY_TEXTURE_LAYERS):1,maxSamples:r?a.getParameter(a.MAX_SAMPLES):1};return K.x.TEXTURE_UNIT_FOR_UPDATES=o.maxTextureImageUnits-1,o}}function te(n,e,t,i){return e?i!==e&&n.bindBuffer(t,e.glName):n.bindBuffer(t,null),e}function Gi(n,e){switch(n){case h.MX.POINTS:return 2*e;case h.MX.TRIANGLES:return e/3;case h.MX.TRIANGLE_STRIP:case h.MX.TRIANGLE_FAN:return e-2;default:return 0}}class zn extends Ht.W{constructor(e,t){super(),this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:i=document.createElement("canvas"),alpha:r=!0,stencil:a=!0,contextOptions:o={}}=t;this._canvas=i;const l=(0,et.sj)("2d",i,{alpha:r,antialias:!1,depth:!0,stencil:a});this.context=new Ln((0,y.pC)(l)?l:null,o),this.resourceManager=new tr.Z,this.painter=new un(this.context,this,this.resourceManager),(0,xe.Z)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:t.timeline||new _n.T,renderingOptions:t.renderingOptions,requestRender:()=>this.requestRender(),requireFBO:!1,profiler:new fn(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=(0,er.A)({render:c=>this.renderFrame(c)}),this._taskHandle.pause(),this._lostWebGLContextHandle=(0,ht.on)(i,"webglcontextlost",()=>{this.emit("webgl-error",{error:new G.Z("webgl-context-lost")})}),i.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(i)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=(0,T.YP)(()=>{var t;return null==(t=this._highlightOptions)?void 0:t.version},()=>{this.painter.setHighlightOptions(e),this.requestRender()},T.nn))}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._renderRemainingTime=2e3,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(e){this._renderRemainingTime-=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}_createTransforms(){return{dvs:(0,Tt.c)()}}renderChildren(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)}_renderChildren(e,t){const i=this.context;i.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,t.drawPhase=I.jx.MAP,this.painter.beforeRenderLayers(i,this.background);for(const r of e)r.processRender(t);this.painter.prepareDisplay(t,this.background,this.state.padding),this.painter.renderLayers(i),t.drawPhase=I.jx.HIGHLIGHT,this.painter.beforeRenderLayers(i);for(const r of e)r.processRender(t);if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(e)){t.drawPhase=I.jx.LABEL,this.painter.beforeRenderLayers(i);for(const r of e)r.processRender(t);this.painter.renderLayers(i)}if((0,xe.Z)("esri-tiles-debug")){t.drawPhase=I.jx.DEBUG,this.painter.beforeRenderLayers(i);for(const r of e)r.processRender(t);this.painter.renderLayers(i)}t.profiler.recordEnd("drawLayers"),i.logInfo()}doRender(e){const t=this.context,{state:i,pixelRatio:r}=e;this._resizeCanvas(e),t.setViewport(0,0,r*i.size[0],r*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),super.doRender(e)}takeScreenshot(e){var t=this;return(0,M.Z)(function*(){const{framebufferWidth:i,framebufferHeight:r}={framebufferWidth:Math.round(t.state.size[0]*e.resolutionScale),framebufferHeight:Math.round(t.state.size[1]*e.resolutionScale)},o=t.context,l=t._state.clone();if(null!=e.rotation){const _=l.viewpoint;l.viewpoint.rotation=e.rotation,l.viewpoint=_}const c=ze(se({},t._renderParameters),{drawPhase:null,globalOpacity:1,stationary:!0,state:l,pixelRatio:1,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1}),u=new Z.X(o,{colorTarget:h.Lm.TEXTURE,depthStencilTarget:h.OU.DEPTH_STENCIL_RENDER_BUFFER,width:i,height:r}),f=o.getBoundFramebufferObject(),d=o.getViewport();o.bindFramebuffer(u),o.setViewport(0,0,i,r),t._renderChildren(e.children,c);const m=t._readbackScreenshot(u,ze(se({},e.cropArea),{y:r-(e.cropArea.y+e.cropArea.height)}));o.bindFramebuffer(f),o.setViewport(d.x,d.y,d.width,d.height),t.requestRender();const g=yield m;let p;return 1===e.outputScale?p=g:(p=new ImageData(Math.round(g.width*e.outputScale),Math.round(g.height*e.outputScale)),(0,Si.TT)(g,p,!0)),p})()}_readbackScreenshot(e,t){return(0,M.Z)(function*(){const i=(0,Si.r7)(t.width,t.height,document.createElement("canvas"));return yield e.readPixelsAsync(t.x,t.y,t.width,t.height,h.VI.RGBA,h.Br.UNSIGNED_BYTE,new Uint8Array(i.data.buffer)),i})()}_resizeCanvas(e){const t=this._canvas,i=t.style,{state:{size:r},pixelRatio:a}=e,o=r[0],l=r[1],c=Math.round(o*a),u=Math.round(l*a);t.width===c&&t.height===u||(t.width=c,t.height=u),i.width=o+"px",i.height=l+"px"}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}}_isLabelDrawPhaseRequired(e){let t=!1;for(const i of e){if(!(i instanceof Ht.W)){t=t||!1;break}if(i.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(i.children)}return t}}var D=b(17626),Ve=b(14517),Gn=b(80542),Vn=b(7074),z=b(77712),ke=(b(90912),b(76898)),ne=b(21286),kn=b(42797);class Xn{constructor(e,t){this.width=e,this.height=t;const i=Math.ceil(e/1),r=Math.ceil(t/1);this._cols=i,this._rows=r,this._cells=kn.p.create(i*r)}insertMetrics(e){const t=this._hasCollision(e);return 0===t&&this._markMetrics(e),t}getCellId(e,t){return e+t*this._cols}has(e){return this._cells.has(e)}hasRange(e,t){return this._cells.hasRange(e,t)}set(e){this._cells.set(e)}setRange(e,t){this._cells.setRange(e,t)}_hasCollision(e){const t=e.id;let i=0,r=0;e.save();do{const a=e.boundsCount;i+=a;for(let o=0;o<a;o++){const l=e.boundsComputedAnchorX(o),c=e.boundsComputedAnchorY(o),u=e.boundsWidth(o)+2,f=e.boundsHeight(o)+2;switch(this._collide(l,c,u,f)){case 2:return 2;case 1:r++}}}while(e.peekId()===t&&e.next());return e.restore(),i===r?1:0}_collide(e,t,i,r){const a=e-i/2,o=t-r/2,l=a+i,c=o+r;if(l<0||c<0||a>this.width||o>this.height)return 1;const u=(0,ne.uZ)(Math.floor(a/1),0,this._cols),f=(0,ne.uZ)(Math.floor(o/1),0,this._rows),d=(0,ne.uZ)(Math.ceil(l/1),0,this._cols),m=(0,ne.uZ)(Math.ceil(c/1),0,this._rows);for(let g=f;g<=m;g++)for(let p=u;p<=d;p++){const _=this.getCellId(p,g);if(this.has(_))return 2}return 0}_mark(e,t,i,r){const a=e-i/2,o=t-r/2,l=a+i,c=o+r,u=(0,ne.uZ)(Math.floor(a/1),0,this._cols),f=(0,ne.uZ)(Math.floor(o/1),0,this._rows),d=(0,ne.uZ)(Math.ceil(l/1),0,this._cols),m=(0,ne.uZ)(Math.ceil(c/1),0,this._rows);for(let g=f;g<=m;g++)for(let p=u;p<=d;p++){const _=this.getCellId(p,g);this.set(_)}return!1}_markMetrics(e){const t=e.id;do{const i=e.boundsCount;for(let r=0;r<i;r++){const a=e.boundsComputedAnchorX(r),o=e.boundsComputedAnchorY(r),l=e.boundsWidth(r)+2,c=e.boundsHeight(r)+2;this._mark(a,o,l,c)}}while(e.peekId()===t&&e.next())}}var Wn=b(21254),Be=b(86971);const Hn=Math.PI;function Vi(n,e){switch(e.transformationType){case Be.hL.Additive:return function Zn(n,e){return n+(fe(e.minSize,n)||e.minDataValue)}(n,e);case Be.hL.Constant:return function jn(n,e){const t=n.stops;let i=t&&t.length&&t[0].size;return null==i&&(i=n.minSize),fe(i,e)}(e,n);case Be.hL.ClampedLinear:return function Yn(n,e){const t=(n-e.minDataValue)/(e.maxDataValue-e.minDataValue),i=fe(e.minSize,n),r=fe(e.maxSize,n);return n<=e.minDataValue?i:n>=e.maxDataValue?r:i+t*(r-i)}(n,e);case Be.hL.Proportional:return function Kn(n,e){const t=n/e.minDataValue,i=fe(e.minSize,n),r=fe(e.maxSize,n);let a=null;return a=t*i,(0,ne.uZ)(a,i,r)}(n,e);case Be.hL.Stops:return function $n(n,e){const[t,i,r]=function Qn(n,e){if(!e)return;let t=0,i=e.length-1;return e.some((r,a)=>n<r?(i=a,!0):(t=a,!1)),[t,i,(n-e[t])/(e[i]-e[t])]}(n,e.cache.ipData);if(t===i)return fe(e.stops[t].size,n);{const a=fe(e.stops[t].size,n);return a+(fe(e.stops[i].size,n)-a)*r}}(n,e);case Be.hL.RealWorldSize:return function qn(n,e){const t=Wn.a[e.valueUnit],i=fe(e.minSize,n),r=fe(e.maxSize,n),{valueRepresentation:a}=e;let o=null;return o="area"===a?2*Math.sqrt(n/Hn)/t:"radius"===a||"distance"===a?2*n/t:n/t,(0,ne.uZ)(o,i,r)}(n,e);case Be.hL.Identity:return n;case Be.hL.Unknown:return null}}function fe(n,e){return"number"==typeof n?n:Vi(e,n)}function Xe(n,e){const t=[];n.forEachTile(i=>t.push(i)),t.sort((i,r)=>i.instanceId-r.instanceId),t.forEach(i=>{(0,y.pC)(i.labelMetrics)&&i.isReady&&e(i,i.labelMetrics.getCursor())})}function ea(n){return e=>(0,me.F2)(Vi(e,n))}function ra(n,e){var c;if(!function Jn(n){return n.layer&&("feature"===n.layer.type||"csv"===n.layer.type||"geojson"===n.layer.type||"ogc-feature"===n.layer.type||"stream"===n.layer.type||"subtype-group"===n.layer.type||"wfs"===n.layer.type)}(e))return;const i=e.layer.geometryType,r=!function ia(n){for(const e of n){const t="featureReduction"in e&&e.featureReduction&&"labelingInfo"in e.featureReduction&&e.featureReduction,i=[...e.labelingInfo||[],...(null==t?void 0:t.labelingInfo)||[]];if(e.labelsVisible&&i.length&&i.some(r=>"none"===r.deconflictionStrategy))return!0}return!1}("subtype-group"===e.layer.type?e.layer.sublayers.items:[e.layer]),a={};if("subtype-group"!==e.layer.type){if("heatmap"===(null==(c=e.tileRenderer)?void 0:c.type))return;const u=function ta(n){const e="visualVariables"in n&&n.visualVariables;if(!e)return null;for(const t of e)if("size"===t.type)return ea(t);return null}(e.layer.renderer);a[0]=u}const o=e.tileRenderer;(0,y.Wi)(o)||n.push({tileRenderer:o,vvEvaluators:a,deconflictionEnabled:r,geometryType:i,visible:e.layer.visible&&!e.suspended})}class sa{run(e,t,i){const r=[];for(let a=e.length-1;a>=0;a--)ra(r,e[a]);this._transformMetrics(r,t),this._runCollision(r,t,i)}_runCollision(e,t,i){const[r,a]=t.state.size,o=new Xn(r*t.pixelRatio,a*t.pixelRatio);for(const{tileRenderer:l,deconflictionEnabled:c,visible:u}of e){const f=l.featuresView.attributeView;c?u?(this._prepare(l),this._collideVisible(o,l,i),this._collideInvisible(o,l)):Xe(l,(d,m)=>{for(;m.nextId();)f.setLabelMinZoom(m.id,255)}):Xe(l,(d,m)=>{for(;m.nextId();)f.setLabelMinZoom(m.id,0)})}}_isFiltered(e,t,i){const r=t.getFilterFlags(e),a=!i.hasFilter||!!(r&P.Zd),o=(0,y.Wi)(i.featureEffect)||i.featureEffect.excludedLabelsVisible||!!(r&P.iV);return!(a&&o)}_prepare(e){const t=e.featuresView.attributeView,i=new Set;Xe(e,(r,a)=>{for(;a.nextId();)if(!i.has(a.id)){if(i.add(a.id),this._isFiltered(a.id,t,e.layerView)){t.setLabelMinZoom(a.id,254);continue}0!==t.getLabelMinZoom(a.id)?t.setLabelMinZoom(a.id,255):t.setLabelMinZoom(a.id,0)}})}_collideVisible(e,t,i){const r=t.featuresView.attributeView,a=new Set;Xe(t,(o,l)=>{for(;l.nextId();)if(!a.has(l.id))if(o.key.level===i){if(0===r.getLabelMinZoom(l.id))switch(e.insertMetrics(l)){case 1:break;case 2:r.setLabelMinZoom(l.id,254),a.add(l.id);break;case 0:r.setLabelMinZoom(l.id,0),a.add(l.id)}}else r.setLabelMinZoom(l.id,254)})}_collideInvisible(e,t){const i=t.featuresView.attributeView,r=new Set;Xe(t,(a,o)=>{for(;o.nextId();)if(!r.has(o.id)&&255===i.getLabelMinZoom(o.id))switch(e.insertMetrics(o)){case 1:break;case 2:i.setLabelMinZoom(o.id,255),r.add(o.id);break;case 0:i.setLabelMinZoom(o.id,0),r.add(o.id)}})}_transformMetrics(e,t){for(const{tileRenderer:i,geometryType:r,vvEvaluators:a}of e)Xe(i,(o,l)=>{const c=i.featuresView.attributeView,u=o.transforms.labelMat2d;u[4]=Math.round(u[4]),u[5]=Math.round(u[5]);const f=u[4],d=u[5],m="polyline"===r;for(;l.next();){const g=l.boundsCount,p=l.anchorX,_=l.anchorY;let E=l.size;const F=a[0];if((0,y.pC)(F)){const x=F(c.getVVSize(l.id));E=isNaN(x)||null==x||x===1/0?E:x}const v=l.directionX*(E/2),w=l.directionY*(E/2);for(let x=0;x<g;x++){let A=p,R=l.anchorY;if(m){let S=A+l.boundsX(x)+v,B=R+l.boundsY(x)+w;t.state.rotation?(S=u[0]*S+u[2]*B+u[4],B=u[1]*S+u[3]*B+u[5]):(S+=f,B+=d),l.setBoundsComputedAnchorX(x,Math.floor(S)),l.setBoundsComputedAnchorY(x,Math.floor(B))}else{t.state.rotation?(A=u[0]*p+u[2]*_+u[4],R=u[1]*p+u[3]*_+u[5]):(A+=f,R+=d);const S=A+l.boundsX(x)+v,B=R+l.boundsY(x)+w;l.setBoundsComputedAnchorX(x,S),l.setBoundsComputedAnchorY(x,B)}}}})}}Ye.Z.getLogger("esri.views.2d.layers.labels.LabelManager");let Le=class extends((0,Gn.p)(Ve.Z)){constructor(n){super(n),this._applyVisibilityPassThrottled=(0,Vn.P)(this._applyVisibilityPass,32,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new sa}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}get updating(){return this.updateRequested}update(n){this._applyVisibilityPassThrottled(n)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}processUpdate(n){this._set("updateParameters",n),this.updateRequested&&(this.updateRequested=!1,this.update(n))}_applyVisibilityPass(n){try{const e=this.view.featuresTilingScheme.getClosestInfoForScale(n.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,n,e)}catch(e){}}};(0,D._)([(0,z.Cb)()],Le.prototype,"updateRequested",void 0),(0,D._)([(0,z.Cb)({readOnly:!0})],Le.prototype,"updateParameters",void 0),(0,D._)([(0,z.Cb)()],Le.prototype,"updating",null),(0,D._)([(0,z.Cb)()],Le.prototype,"view",void 0),Le=(0,D._)([(0,ke.j)("esri.views.2d.layers.labels.LabelManager")],Le);const aa=Le;var oa=b(35627),la=b(36275),gt=b(85807),vt=b(49672),ae=b(24926),ki=b(94663);let at=class extends Ve.Z{constructor(n){super(n),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(n){this._handles&&this._handles.forEach(e=>{e.remove()}),this._handles=null,this._destroyOverlay(),this._set("view",n),n&&(n.on("drag",["Shift"],e=>this._handleDrag(e,1),ki.f.INTERNAL),n.on("drag",["Shift","Ctrl"],e=>this._handleDrag(e,-1),ki.f.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(n,e,t,i){this._box.x=n,this._box.y=e,this._box.width=t,this._box.height=i,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(n,e,t,i,r){const a=this.view,o=a.toMap((0,me.vW)(n+.5*t,e+.5*i));let l=Math.max(t/a.width,i/a.height);-1===r&&(l=1/l),this._destroyOverlay(),this.navigation.end(),a.goTo({center:o,scale:a.scale*l})}_updateBox(n,e,t,i){const r=this._boxShape;r.setAttributeNS(null,"x",""+n),r.setAttributeNS(null,"y",""+e),r.setAttributeNS(null,"width",""+t),r.setAttributeNS(null,"height",""+i),r.setAttributeNS(null,"class","esri-zoom-box__outline")}_updateBackground(n,e,t,i){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(n,e,t,i,this.view.width,this.view.height))}_createContainer(){const n=document.createElement("div");n.className="esri-zoom-box__container",this.view.root.appendChild(n),this._container=n}_createOverlay(){const n=this.view.width,e=this.view.height,t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttributeNS(null,"d","M 0 0 L "+n+" 0 L "+n+" "+e+" L 0 "+e+" Z"),t.setAttributeNS(null,"class","esri-zoom-box__overlay-background");const i=document.createElementNS("http://www.w3.org/2000/svg","rect"),r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttributeNS(null,"class","esri-zoom-box__overlay"),r.appendChild(t),r.appendChild(i),this._container.appendChild(r),this._backgroundShape=t,this._boxShape=i,this._overlay=r}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(n,e,t,i,r,a){const o=n+t,l=e+i;return"M 0 0 L "+r+" 0 L "+r+" "+a+" L 0 "+a+" ZM "+n+" "+e+" L "+n+" "+l+" L "+o+" "+l+" L "+o+" "+e+" Z"}_handleDrag(n,e){const t=n.x,i=n.y,r=n.origin.x,a=n.origin.y;let o,l,c,u;switch(t>r?(o=r,c=t-r):(o=t,c=r-t),i>a?(l=a,u=i-a):(l=i,u=a-i),n.action){case"start":this._start();break;case"update":this._update(o,l,c,u);break;case"end":this._end(o,l,c,u,e)}n.stopPropagation()}_redraw(){if(!this._rafId||(this._rafId=null,!this._overlay))return;const{x:n,y:e,width:t,height:i}=this._box;this._updateBox(n,e,t,i),this._updateBackground(n,e,t,i),this._rafId=requestAnimationFrame(this._redraw)}};(0,D._)([(0,z.Cb)()],at.prototype,"navigation",void 0),(0,D._)([(0,z.Cb)()],at.prototype,"view",null),at=(0,D._)([(0,ke.j)("esri.views.2d.navigation.ZoomBox")],at);const ha=at;b(29132);class Ae{constructor(e){this.gain=e}update(e){if(this.hasLastValue){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return void 0!==this.lastValue}get hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return e-this.lastValue}_updateDelta(e){this.filteredDelta=this.hasFilteredDelta?(1-this.gain)*this.filteredDelta+this.gain*e:e}}class zt{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}class ua extends zt{constructor(e,t,i,r,a){super(e,t,i),this.sceneVelocity=r,this.direction=a}value(e){return super.valueFromInitialVelocity(this.sceneVelocity,e)}}class ca{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.time=new Ae(.6),this.screen=[new Ae(.4),new Ae(.4)],this.scene=[new Ae(.6),new Ae(.6),new Ae(.6)],this.tmpDirection=(0,we.c)()}add(e,t,i){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(i)<.015)return;this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.scene[0].update(t[0]),this.scene[1].update(t[1]),this.scene[2].update(t[2]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){(0,De.s)(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const r=(0,De.l)(this.tmpDirection);return r>0&&(0,De.g)(this.tmpDirection,this.tmpDirection,1/r),new ua(e,t,i,r/this.time.filteredDelta,this.tmpDirection)}}let We=class extends Ve.Z{constructor(n){super(n),this.animationTime=0,this.momentumEstimator=new ca(500,6,.92),this.momentum=null,this.tmpMomentum=(0,we.c)(),this.momentumFinished=!1,this.viewpoint=new gt.Z({targetGeometry:new vt.Z,scale:0,rotation:0}),(0,T.gx)(()=>this.momentumFinished,()=>this.navigation.stop())}begin(n,e){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(e),this.previousDrag=e}update(n,e){this.addToEstimator(e);let t=e.center.x,i=e.center.y;const r=this.previousDrag;t=r?r.center.x-t:-t,i=r?i-r.center.y:i,n.viewpoint=(0,ae.Rx)(this.viewpoint,n.viewpoint,[t||0,i||0]),this.previousDrag=e}end(n,e){this.addToEstimator(e),this.momentum=n.navigation.momentumEnabled?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(n),this.previousDrag=null,this.navigation.end()}addToEstimator(n){const e=n.center.x,t=n.center.y,i=(0,me.s1)(-e,t),r=(0,we.f)(-e,t,0);this.momentumEstimator.add(i,r,.001*n.timestamp)}onAnimationUpdate(n){this.navigation.animationManager.animateContinous(n.viewpoint,(e,t)=>{this.momentumFinished=!this.momentum||this.momentum.isFinished(this.animationTime);const i=.001*t;if(!this.momentumFinished){const r=this.momentum.valueDelta(this.animationTime,i);(0,De.g)(this.tmpMomentum,this.momentum.direction,r),(0,ae.Rx)(e,e,this.tmpMomentum),n.constraints.constrainByGeometry(e)}this.animationTime+=i})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};(0,D._)([(0,z.Cb)()],We.prototype,"momentumFinished",void 0),(0,D._)([(0,z.Cb)()],We.prototype,"viewpoint",void 0),(0,D._)([(0,z.Cb)()],We.prototype,"navigation",void 0),We=(0,D._)([(0,ke.j)("esri.views.2d.navigation.actions.Pan")],We);const da=We;class Xi{constructor(e=2.5,t=.01,i=.95,r=12){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.maxVelocity=r,this.enabled=!0,this.value=new Ae(.8),this.time=new Ae(.3)}add(e,t){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta){const i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,ne.uZ)(e,-this.maxVelocity,this.maxVelocity),Math.abs(e)<this.minimumInitialVelocity?null:this.createMomentum(e,this.stopVelocity,this.friction)}createMomentum(e,t,i){return new zt(e,t,i)}}class fa extends Xi{constructor(e=3,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){if(this.value.hasLastValue){const i=this.value.lastValue;let r=e-i;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;e=i+r}super.add(e,t)}}class _a extends zt{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),r=super.value(e+t)-i;return Math.exp(r)}}class ma extends Xi{constructor(e=2.5,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new _a(e,t,i)}}let He=class extends Ve.Z{constructor(n){super(n),this._animationTime=0,this._momentumFinished=!1,this._rotationMomentumEstimator=new fa(.6,.15,.95),this._rotationDirection=1,this._zoomDirection=1,this._zoomMomentumEstimator=new ma,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new gt.Z({targetGeometry:new vt.Z,scale:0,rotation:0}),this.own((0,T.gx)(()=>this._momentumFinished,()=>this.navigation.stop()))}begin(n,e){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=e.angle,this._previousRadius=this._startRadius=e.radius,this._previousCenter=e.center,this._updateTimestamp=null,n.constraints.rotationEnabled&&this.addToRotateEstimator(0,e.timestamp),this.addToZoomEstimator(e,1)}update(n,e){null===this._updateTimestamp&&(this._updateTimestamp=e.timestamp);const t=e.angle,i=e.radius,r=e.center,a=Math.abs(180*(t-this._startAngle)/Math.PI),o=Math.abs(i-this._startRadius),l=this._startRadius/i;if(this._previousRadius){const c=i/this._previousRadius;let u=180*(t-this._previousAngle)/Math.PI;this._rotationDirection=u>=0?1:-1,this._zoomDirection=c>=1?1:-1,n.constraints.rotationEnabled?(null===this._zoomOnly&&e.timestamp-this._updateTimestamp>200&&(this._zoomOnly=o-a>0),null===this._zoomOnly||this._zoomOnly?u=0:this.addToRotateEstimator(t-this._startAngle,e.timestamp)):u=0,this.addToZoomEstimator(e,l),this.navigation.setViewpoint([r.x,r.y],1/c,u,[this._previousCenter.x-r.x,r.y-this._previousCenter.y])}this._previousAngle=t,this._previousRadius=i,this._previousCenter=r}end(n){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(n),this.navigation.end()}addToRotateEstimator(n,e){this._rotationMomentumEstimator.add(n,.001*e)}addToZoomEstimator(n,e){this._zoomMomentumEstimator.add(e,.001*n.timestamp)}canZoomIn(n){const t=n.constraints.effectiveMaxScale;return 0===t||n.scale>t}canZoomOut(n){const t=n.constraints.effectiveMinScale;return 0===t||n.scale<t}onAnimationUpdate(n){this.navigation.animationManager.animateContinous(n.viewpoint,(e,t)=>{const i=!this.canZoomIn(n)&&this._zoomDirection>1||!this.canZoomOut(n)&&this._zoomDirection<1,r=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),a=i||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),o=.001*t;if(this._momentumFinished=r&&a,!this._momentumFinished){const l=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,o))*this._rotationDirection*180/Math.PI:0;let c=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,o)):1;const u=(0,Ge.a)(),f=(0,Ge.a)();if(this._previousCenter){(0,Me.a)(u,this._previousCenter.x,this._previousCenter.y),(0,ae.Dq)(f,n.size,n.padding),(0,Me.b)(u,u,f);const{constraints:d,scale:m}=n,g=m*c;c<1&&!d.canZoomInTo(g)?(c=m/d.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):c>1&&!d.canZoomOutTo(g)&&(c=m/d.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),(0,ae.UZ)(e,n.viewpoint,c,l,u,n.size),n.constraints.constrainByGeometry(e)}}this._animationTime+=o})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};(0,D._)([(0,z.Cb)()],He.prototype,"_momentumFinished",void 0),(0,D._)([(0,z.Cb)()],He.prototype,"viewpoint",void 0),(0,D._)([(0,z.Cb)()],He.prototype,"navigation",void 0),He=(0,D._)([(0,ke.j)("esri.views.2d.navigation.actions.Pinch")],He);const pa=He,Gt=(0,Ge.a)(),Wi=(0,Ge.a)();let ot=class extends Ve.Z{constructor(n){super(n),this._previousCenter=(0,Ge.a)(),this.viewpoint=new gt.Z({targetGeometry:new vt.Z,scale:0,rotation:0})}begin(n,e){this.navigation.begin(),(0,Me.a)(this._previousCenter,e.center.x,e.center.y)}update(n,e){const{state:{size:t,padding:i}}=n;(0,Me.a)(Gt,e.center.x,e.center.y),(0,ae.ni)(Wi,t,i),n.viewpoint=(0,ae.$H)(this.viewpoint,n.state.paddedViewState.viewpoint,(0,ae.dI)(Wi,this._previousCenter,Gt)),(0,Me.c)(this._previousCenter,Gt)}end(){this.navigation.end()}};(0,D._)([(0,z.Cb)()],ot.prototype,"viewpoint",void 0),(0,D._)([(0,z.Cb)()],ot.prototype,"navigation",void 0),ot=(0,D._)([(0,ke.j)("esri.views.2d.actions.Rotate")],ot);const ga=ot,Vt=new gt.Z({targetGeometry:new vt.Z}),kt=[0,0];let ge=class extends Ve.Z{constructor(n){super(n),this._endTimer=null,this.animationManager=null}initialize(){this.pan=new da({navigation:this}),this.rotate=new ga({navigation:this}),this.pinch=new pa({navigation:this}),this.zoomBox=new ha({view:this.view,navigation:this})}destroy(){this.pan.destroy(),this.rotate.destroy(),this.pinch.destroy(),this.zoomBox.destroy(),this.pan=this.rotate=this.pinch=this.zoomBox=this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}zoom(n,e=this._getDefaultAnchor()){var t=this;return(0,M.Z)(function*(){if(t.stop(),t.begin(),t.view.constraints.snapToZoom&&t.view.constraints.effectiveLODs)return n<1?t.zoomIn(e):t.zoomOut(e);t.setViewpoint(e,n,0,[0,0])})()}zoomIn(n){var e=this;return(0,M.Z)(function*(){const t=e.view,i=t.constraints.snapToNextScale(t.scale);return e._zoomToScale(i,n)})()}zoomOut(n){var e=this;return(0,M.Z)(function*(){const t=e.view,i=t.constraints.snapToPreviousScale(t.scale);return e._zoomToScale(i,n)})()}setViewpoint(n,e,t,i){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,n,e,t,i),this.end()}setViewpointImmediate(n,e=0,t=[0,0],i=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,i,n,e,t)}continousRotateClockwise(){const n=this.get("view.viewpoint");this.animationManager.animateContinous(n,e=>{(0,ae.$H)(e,e,-1)})}continousRotateCounterclockwise(){const n=this.get("view.viewpoint");this.animationManager.animateContinous(n,e=>{(0,ae.$H)(e,e,1)})}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-10,0])}continousPanRight(){this._continuousPan([10,0])}continousPanUp(){this._continuousPan([0,10])}continousPanDown(){this._continuousPan([0,-10])}stop(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(n){this.animationManager.animateContinous(this.view.viewpoint,t=>{(0,ae.Rx)(t,t,n),this.view.constraints.constrainByGeometry(t)})}_startTimer(n){return null!==this._endTimer||(this._endTimer=setTimeout(()=>{this._endTimer=null;const e=performance.now()-this._lastEventTimestamp;e<250?this._endTimer=this._startTimer(e):this._set("interacting",!1)},n)),this._endTimer}_getDefaultAnchor(){const{size:n,padding:{left:e,right:t,top:i,bottom:r}}=this.view;return kt[0]=.5*(n[0]-t+e),kt[1]=.5*(n[1]-r+i),kt}_zoomToScale(n,e=this._getDefaultAnchor()){var t=this;return(0,M.Z)(function*(){const{view:i}=t,{constraints:r,scale:a,viewpoint:o,size:l,padding:c}=i,u=r.canZoomInTo(n),f=r.canZoomOutTo(n);if(!(n<a&&!u||n>a&&!f))return(0,ae.gG)(Vt,o,n/a,0,e,l,c),r.constrainByGeometry(Vt),i.goTo(Vt,{animate:!0})})()}_scaleRotateTranslateViewpoint(n,e,t,i,r){const{view:a}=this,{size:o,padding:l,constraints:c,scale:u,viewpoint:f}=a,d=u*t,m=c.canZoomInTo(d),g=c.canZoomOutTo(d);return(t<1&&!m||t>1&&!g)&&(t=1),(0,ae.Rx)(f,f,r),(0,ae.gG)(n,f,t,i,e,o,l),c.constrainByGeometry(n)}};(0,D._)([(0,z.Cb)()],ge.prototype,"animationManager",void 0),(0,D._)([(0,z.Cb)({type:Boolean,readOnly:!0})],ge.prototype,"interacting",void 0),(0,D._)([(0,z.Cb)()],ge.prototype,"pan",void 0),(0,D._)([(0,z.Cb)()],ge.prototype,"pinch",void 0),(0,D._)([(0,z.Cb)()],ge.prototype,"rotate",void 0),(0,D._)([(0,z.Cb)()],ge.prototype,"view",void 0),(0,D._)([(0,z.Cb)()],ge.prototype,"zoomBox",void 0),ge=(0,D._)([(0,ke.j)("esri.views.2d.navigation.MapViewNavigation")],ge);const va=ge;var ba=b(72392),Ea=b(21726),Ta=b(57477);const ji={shaders:{vertexShader:(0,J.w)("magnifier/magnifier.vert"),fragmentShader:(0,J.w)("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};var Yi=b(70026);function Xt(){return(Xt=(0,M.Z)(function*(n){const e=b.e(9080).then(b.bind(b,29080)),t=b.e(5690).then(b.bind(b,5690)),i=(0,Yi.t)((yield e).default,{signal:n}),r=(0,Yi.t)((yield t).default,{signal:n}),a={mask:yield i,overlay:yield r};return(0,Y.k_)(n),a})).apply(this,arguments)}class wa extends Ta.s{constructor(){super(),this._handles=new ba.Z,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,T.YP)(()=>e.version,()=>{this.visible=e.visible&&(0,y.pC)(e.position)&&e.size>0,this.requestRender()},T.nn),(0,T.YP)(()=>[e.maskUrl,e.overlayUrl],()=>this._reloadResources()),(0,T.YP)(()=>e.size,()=>{this._disposeRenderResources(),this.requestRender()})])}_createTransforms(){return{dvs:(0,Tt.c)()}}doRender(e){var U;const t=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==I.jx.MAP||!this._canRender())return;this._updateResources(e);const i=this._magnifier;if((0,y.Wi)(i.position))return;const r=e.pixelRatio,a=i.size*r,l=Math.ceil(1/i.factor*a);this._readbackTexture.resize(l,l);const{size:c}=e.state,u=r*c[0],f=r*c[1],d=.5*l,m=.5*l,g=(0,ne.uZ)(r*i.position.x,d,u-d-1),p=(0,ne.uZ)(f-r*i.position.y,m,f-m-1);t.setBlendingEnabled(!0);const _=g-d,E=p-m,F=this._readbackTexture;t.bindTexture(F,0),t.gl.copyTexImage2D(F.descriptor.target,0,F.descriptor.pixelFormat,_,E,l,l,0);const v=null==(U=this.background)?void 0:U.color,w=v?[v.a*v.r/255,v.a*v.g/255,v.a*v.b/255,v.a]:[1,1,1,1],x=(g+i.offset.x*r)/u*2-1,A=(p-i.offset.y*r)/f*2-1,R=a/u*2,S=a/f*2,B=this._program;t.bindVAO(this._vertexArrayObject),t.bindTexture(this._overlayTexture,6),t.bindTexture(this._maskTexture,7),t.useProgram(B),B.setUniform4fv("u_background",w),B.setUniform1i("u_readbackTexture",0),B.setUniform1i("u_overlayTexture",6),B.setUniform1i("u_maskTexture",7),B.setUniform4f("u_drawPos",x,A,R,S),B.setUniform1i("u_maskEnabled",i.maskEnabled?1:0),B.setUniform1i("u_overlayEnabled",i.overlayEnabled?1:0),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawArrays(h.MX.TRIANGLE_STRIP,0,4),t.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){var e=this;this._resourcesTask&&this._resourcesTask.abort();const t=(0,y.pC)(this._magnifier)?this._magnifier.maskUrl:null,i=(0,y.pC)(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=(0,Y.vr)(function(){var r=(0,M.Z)(function*(a){const o=(0,y.Wi)(t)||(0,y.Wi)(i)?function ya(n){return Xt.apply(this,arguments)}(a):null,l=(0,y.pC)(t)?(0,je.default)(t,{responseType:"image",signal:a}).then(d=>d.data):o.then(d=>d.mask),c=(0,y.pC)(i)?(0,je.default)(i,{responseType:"image",signal:a}).then(d=>d.data):o.then(d=>d.overlay),[u,f]=yield Promise.all([l,c]);e.mask=u,e.overlay=f,e._disposeRenderResources(),e.requestRender()});return function(a){return r.apply(this,arguments)}}())}_disposeRenderResources(){this._readbackTexture=(0,y.O3)(this._readbackTexture),this._overlayTexture=(0,y.O3)(this._overlayTexture),this._maskTexture=(0,y.O3)(this._maskTexture),this._vertexArrayObject=(0,y.O3)(this._vertexArrayObject),this._program=(0,y.O3)(this._program)}_updateResources(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const t=e.context;this._resourcePixelRatio=e.pixelRatio;const i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=function xa(n){return(0,Ze.H)(n,ji)}(t);const r=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new Se.U(t,ji.attributes,xt.cD,{geometry:Ce.f.createVertex(t,h.l1.STATIC_DRAW,r)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new K.x(t,{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.NEAREST,flipped:!0,preMultiplyAlpha:!(0,Ea.zd)(this.overlay.src)||!e.context.driverTest.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new K.x(t,{target:h.No.TEXTURE_2D,pixelFormat:h.VI.ALPHA,internalFormat:h.VI.ALPHA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.NEAREST,flipped:!0},this.mask);const o=1/this._magnifier.factor;this._readbackTexture=new K.x(t,{target:h.No.TEXTURE_2D,pixelFormat:h.VI.RGBA,internalFormat:h.VI.RGBA,dataType:h.Br.UNSIGNED_BYTE,wrapMode:h.e8.CLAMP_TO_EDGE,samplingMode:h.cw.LINEAR,flipped:!1,width:Math.ceil(o*i),height:Math.ceil(o*i)})}}}}]);