"use strict";var Le=Object.defineProperty,je=Object.defineProperties,Ne=Object.getOwnPropertyDescriptors,Re=Object.getOwnPropertySymbols,Be=Object.prototype.hasOwnProperty,We=Object.prototype.propertyIsEnumerable,be=(V,R,n)=>R in V?Le(V,R,{enumerable:!0,configurable:!0,writable:!0,value:n}):V[R]=n,q=(V,R)=>{for(var n in R||(R={}))Be.call(R,n)&&be(V,n,R[n]);if(Re)for(var n of Re(R))We.call(R,n)&&be(V,n,R[n]);return V},$=(V,R)=>je(V,Ne(R));(self.webpackChunkchasse_pwa_front=self.webpackChunkchasse_pwa_front||[]).push([[1607],{59990:(V,R,n)=>{function o(d){var g;const m=d.layer;return"floorInfo"in m&&(null==(g=m.floorInfo)?void 0:g.floorField)&&"floors"in d.view?Z(d.view.floors,m.floorInfo.floorField):null}function h(d,m){var g;return"floorInfo"in m&&(null==(g=m.floorInfo)?void 0:g.floorField)?Z(d,m.floorInfo.floorField):null}function Z(d,m){if(!(null==d?void 0:d.length))return null;const g=d.filter(b=>""!==b).map(b=>`'${b}'`);return g.push("''"),`${m} IN (${g.join(",")}) OR ${m} IS NULL`}n.d(R,{c:()=>o,f:()=>h})},1607:(V,R,n)=>{n.r(R),n.d(R,{default:()=>De});var o=n(15861),h=n(17626),Z=n(88879),d=n(77712),g=(n(85931),n(8314)),x=(n(90912),n(76898));let O=class extends Z.Z{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(t=!1){if(this.popupTemplate)return this.popupTemplate;const e=this.sourceLayer&&this.sourceLayer.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}getObjectId(){return this.objectId}};(0,h._)([(0,d.Cb)({type:Boolean})],O.prototype,"isAggregate",void 0),(0,h._)([(0,d.Cb)({type:[String,Number],json:{read:!0}})],O.prototype,"objectId",void 0),O=(0,h._)([(0,x.j)("esri.AggregateGraphic")],O);const L=O;n(29132);var N=n(74333),U=n(26584),S=n(58817),K=n(63290),a=n(62208),v=n(10699),_=n(32917),ie=n(14517),pe=n(52884);let w=class extends ie.Z{constructor(t){super(t),this._filter=null,this.duration=(0,g.Z)("mapview-transitions-duration"),this._excludedEffectView=new pe.AM(t),this._includedEffectView=new pe.AM(t)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(t){this._get("featureEffect")!==t&&this._transitionTo(t)}get filter(){var t;return this._filter||(null==(t=(0,a.Wg)(this.featureEffect))?void 0:t.filter)||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(t){this._set("scale",t),this._excludedEffectView.scale=t,this._includedEffectView.scale=t}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(t,e){this._set("scale",e),this.transitioning?(this._includedEffectView.transitionStep(t,e),this._excludedEffectView.transitionStep(t,e),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=e,this._includedEffectView.scale=e)}end(){this._includedEffectView.end(),this._excludedEffectView.end(),this._filter=null}_transitionTo(t){const e=this._get("featureEffect"),r=(0,a.Wg)(t),i=(0,a.Wg)(null==r?void 0:r.includedEffect),s=(0,a.Wg)(null==r?void 0:r.excludedEffect),l=this._includedEffectView.canTransitionTo(i)&&this._excludedEffectView.canTransitionTo(s);this._includedEffectView.effect=i,this._excludedEffectView.effect=s,this._set("featureEffect",r),this._filter=(null==r?void 0:r.filter)||(null==e?void 0:e.filter)||null,l||this.end()}};(0,h._)([(0,d.Cb)()],w.prototype,"_filter",void 0),(0,h._)([(0,d.Cb)()],w.prototype,"_excludedEffectView",void 0),(0,h._)([(0,d.Cb)()],w.prototype,"_includedEffectView",void 0),(0,h._)([(0,d.Cb)()],w.prototype,"duration",void 0),(0,h._)([(0,d.Cb)()],w.prototype,"excludedEffects",null),(0,h._)([(0,d.Cb)()],w.prototype,"featureEffect",null),(0,h._)([(0,d.Cb)()],w.prototype,"filter",null),(0,h._)([(0,d.Cb)()],w.prototype,"hasEffects",null),(0,h._)([(0,d.Cb)()],w.prototype,"includedEffects",null),(0,h._)([(0,d.Cb)({value:0})],w.prototype,"scale",null),(0,h._)([(0,d.Cb)()],w.prototype,"transitioning",null),w=(0,h._)([(0,x.j)("esri.layers.effects.FeatureEffectView")],w);const ye=w;var se=n(98624),ne=n(17253),Y=n(84952),fe=n(39351),z=n(37384),ge=n(49391);function ee(){return(ee=(0,o.Z)(function*(t,e){if(!t)return null;switch(t.type){case"symbol":return new((yield Promise.all([n.e(7692),n.e(5314),n.e(5506),n.e(4821),n.e(4589),n.e(4056),n.e(8592),n.e(3036)]).then(n.bind(n,19268))).default)(e);case"heatmap":return new((yield Promise.all([n.e(7692),n.e(5314),n.e(5506),n.e(4821),n.e(4589),n.e(8592),n.e(2900)]).then(n.bind(n,32900))).default)(e)}})).apply(this,arguments)}var te=n(22418),G=n(62192),ve=n(71251);function F(t){return t.some(e=>e.globalId)}function E(t){return t.filter(e=>!e.error).map(e=>{var r;return null!=(r=e.objectId)?r:e.globalId})}function A(t,e){const r=new Set(t);for(const i of e.values())r.add(i);return r}function W(t,e){const r=new Set(t);for(const i of e.values())r.delete(i);return r}let Q=class extends ie.Z{constructor(t){super(t),this._hasGlobalIds=!1}normalizeCtorArgs(t){return this._queueProcessor=new ve.e({concurrency:1,process:t.process}),{}}destroy(){this.clear()}get updating(){return this._queueProcessor.length>0}clear(){this._queueProcessor.clear()}push(t){const e=this._queueProcessor,r=e.last();switch(t.type){case"update":case"refresh":if((null==r?void 0:r.type)===t.type)return;e.push(t).finally(()=>this.notifyChange("updating"));break;case"edit":{const i="processed-edit"===(null==r?void 0:r.type)?r:null;i&&e.popLast();const s=this._mergeEdits(i,t);for(const l of s)e.push(l).finally(()=>this.notifyChange("updating"));break}}this.notifyChange("updating")}_mergeEdits(t,e){var f,c;const{addedFeatures:r,deletedFeatures:i,updatedFeatures:s}=e.edits;if(this._hasGlobalIds=this._hasGlobalIds||F(r)||F(s)||F(i),this._hasGlobalIds)return[t,{type:"processed-edit",edits:{addOrModified:[...r,...s],removed:i}}];const l=new Set(E(null!=(f=null==t?void 0:t.edits.addOrModified)?f:[])),u=new Set(E(null!=(c=null==t?void 0:t.edits.removed)?c:[])),y=new Set([...E(r),...E(s)]),p=new Set(E(i));return[{type:"processed-edit",edits:{addOrModified:Array.from(A(W(l,p),y)).map(C=>({objectId:C})),removed:Array.from(A(W(u,y),p)).map(C=>({objectId:C}))}}]}};(0,h._)([(0,d.Cb)({readOnly:!0})],Q.prototype,"updating",null),Q=(0,h._)([(0,x.j)("esri.views.2d.layers.support.FeatureCommandQueue")],Q);const oe=Q;var ae=n(60330),M=n(59289);let X=class extends ae.D{constructor(t){super(t),this._startupResolver=(0,v.hh)(),this.isReady=!1}initialize(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(t){this.client.tileRenderer=t}get closed(){return this._connection.closed}startup(t,e,r,i){var s=this;return(0,o.Z)(function*(){yield s.when();const l=s._controller.signal,u=function le(t){return Array.isArray(t)}(r.source)?{transferList:r.source,signal:l}:void 0,y={service:r,config:e,tileInfo:t.tileInfo.toJSON(),tiles:i};yield s._connection.invoke("startup",y,u),s._startupResolver.resolve(),s._set("isReady",!0)})()}updateTiles(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,(0,v.R8)(e._connection.invoke("updateTiles",t))})()}update(t){var e=this;return(0,o.Z)(function*(){const r={config:t};return yield e._startupResolver.promise,e._connection.invoke("update",r)})()}applyUpdate(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("applyUpdate",t)})()}setHighlight(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,(0,v.R8)(e._connection.invoke("controller.setHighlight",t))})()}stop(){var t=this;return(0,o.Z)(function*(){if(yield t._startupResolver.promise,!t.closed)return(0,v.R8)(t._connection.invoke("stop"))})()}refresh(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,(0,v.R8)(e._connection.invoke("controller.refresh",t))})()}querySummaryStatistics(t,e,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.querySummaryStatistics",{query:t.toJSON(),params:e},r)})()}queryUniqueValues(t,e,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryUniqueValues",{query:t.toJSON(),params:e},r)})()}queryClassBreaks(t,e,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryClassBreaks",{query:t.toJSON(),params:e},r)})()}queryHistogram(t,e,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryHistogram",{query:t.toJSON(),params:e},r)})()}queryFeatures(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatures",t.toJSON(),e)})()}queryVisibleFeatures(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryVisibleFeatures",t.toJSON(),e)})()}queryObjectIds(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryObjectIds",t.toJSON(),e)})()}queryFeatureCount(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatureCount",t.toJSON(),e)})()}queryExtent(t,e){var r=this;return(0,o.Z)(function*(){return r._connection.invoke("controller.queryExtent",t.toJSON(),e)})()}queryLatestObservations(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryLatestObservations",t.toJSON(),e)})()}queryStatistics(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.queryStatistics",t)})()}getObjectId(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getObjectId",t)})()}getDisplayId(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getDisplayId",t)})()}getFeatures(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getFeatures",t)})()}getAggregates(){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getAggregates")})()}getAggregateValueRanges(){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getAggregateValueRanges")})()}mapValidDisplayIds(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.mapValidDisplayIds",t)})()}onEdits(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,(0,v.R8)(e._connection.invoke("controller.onEdits",t))})()}enableEvent(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,(0,v.R8)(r._connection.invoke("controller.enableEvent",{name:t,value:e}))})()}pauseStream(){return(0,v.R8)(this._connection.invoke("controller.pauseStream"))}resumeStream(){return(0,v.R8)(this._connection.invoke("controller.resumeStream"))}_startWorker(t){var e=this;return(0,o.Z)(function*(){try{e._connection=yield(0,M.bA)("Pipeline",{client:e.client,strategy:"dedicated",signal:t})}catch(r){(0,v.H9)(r)}})()}};(0,h._)([(0,d.Cb)()],X.prototype,"isReady",void 0),(0,h._)([(0,d.Cb)()],X.prototype,"client",void 0),(0,h._)([(0,d.Cb)()],X.prototype,"tileRenderer",null),X=(0,h._)([(0,x.j)("esri.views.2d.layers.support.FeatureLayerProxy")],X);const Oe=X;var Se=n(43930),Ie=n(84378),me=n(58098);class Fe{constructor(e){this._tiles=new Map,this.buffer=0,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.buffer=e.buffer}destroy(){}clear(){this._tiles.forEach(e=>this._releaseTile(e))}tileKeys(){const e=[];return this._tiles.forEach((r,i)=>e.push(i)),e}update(e){const r=this.tileInfoView.getTileCoverage(e.state,this.buffer,"closest"),{spans:i,lodInfo:s}=r,{level:l}=s,u=[],y=[],p=new Set,f=new Set;for(const{row:c,colFrom:C,colTo:T}of i)for(let I=C;I<=T;I++){const B=me.Z.getId(l,c,s.normalizeCol(I),s.getWorldForColumn(I)),j=this._getOrAcquireTile(u,B);p.add(B),j.isReady?j.visible=!0:f.add(j.key)}return f.forEach(c=>this._addPlaceholders(p,c)),this._tiles.forEach(c=>{p.has(c.key.id)||(y.push(c.key.id),this._releaseTile(c))}),Ie.Z.pool.release(r),{hasMissingTiles:f.size>0,added:u,removed:y}}_getOrAcquireTile(e,r){if(!this._tiles.has(r)){const i=this.acquireTile(new me.Z(r));e.push(r),this._tiles.set(r,i),i.visible=!1}return this._tiles.get(r)}_getTile(e){return this._tiles.get(e)}_releaseTile(e){this._tiles.delete(e.key.id),this.releaseTile(e)}_addPlaceholders(e,r){const i=this._addPlaceholderChildren(e,r);Math.abs(1-i)<1e-6||this._addPlaceholderParent(e,r)||(this._getTile(r.id).visible=!0)}_addPlaceholderChildren(e,r){let i=0;return this._tiles.forEach(s=>{i+=this._addPlaceholderChild(e,s,r)}),i}_addPlaceholderChild(e,r,i){return r.key.level<=i.level||!r.hasData||!i.contains(r.key)?0:(r.visible=!0,e.add(r.key.id),1/(1<<2*(r.key.level-i.level)))}_addPlaceholderParent(e,r){let i=r.getParentKey(),s=0,l=null;for(;(0,a.pC)(i);){if(e.has(i.id))return!0;const u=this._getTile(i.id);if(null==u?void 0:u.isReady)return u.visible=!0,e.add(u.key.id),!0;(null==u?void 0:u.hasData)&&u.patchCount>s&&(s=u.patchCount,l=u),i=i.getParentKey()}return!!l&&(l.visible=!0,e.add(l.key.id),!0)}}var _e=n(55538),Pe=n(13812),Te=n(2319),P=n(36630),Ee=n(59990),Ue=n(46679),ue=n(10023);const de=K.Z.getLogger("esri.views.layers.FeatureLayerView"),we=t=>{let e=class extends t{constructor(...r){super(...r),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.handles.add([(0,_.YP)(()=>{var i;const r=this.layer;return[null==(i=null==r?void 0:r.elevationInfo)?void 0:i.featureExpressionInfo,null==r?void 0:r.displayField,null==r?void 0:r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),_.tX),(0,_.on)(()=>{var r;return null==(r=this.view)?void 0:r.floors},"change",()=>this._handleRequiredFieldsChange()),(0,_.on)(()=>{const r=this.layer;return r&&"sublayers"in r&&r.sublayers},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:r,layer:{fieldsIndex:i},requiredFields:s}=this;return(0,P.Q0)(i,"outFields"in r&&r.outFields?[...(0,P.Lk)(i,r.outFields),...s]:s)}set effect(r){(0,_e.Mr)(de,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=r}get effect(){return(0,_e.Mr)(de,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){void 0!==r?this._override("featureEffect",r):this._clearOverride("featureEffect")}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){de.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(r){throw new Error("missing implementation")}createQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},i=(0,a.pC)(this.filter)?this.filter.createQuery(r):new Y.Z(r);if("feature"===this.layer.type){const s=(0,Ee.c)(this);(0,a.pC)(s)&&(i.where=i.where?`(${i.where}) AND (${s})`:s)}return(0,a.pC)(this.timeExtent)&&(i.timeExtent=(0,a.pC)(i.timeExtent)?i.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),i}queryFeatures(r,i){throw new Error("missing implementation")}queryObjectIds(r,i){throw new Error("missing implementation")}queryFeatureCount(r,i){throw new Error("missing implementation")}queryExtent(r,i){throw new Error("missing implementation")}fetchPopupFeatures(r,i){var s=this;return(0,o.Z)(function*(){const l=s.validateFetchPopupFeatures(i);if(l)throw l;return s.fetchClientPopupFeatures(i)})()}_loadArcadeModules(r){if(r.get("expressionInfos.length")||Array.isArray(r.content)&&r.content.some(i=>"expression"===i.type))return(0,Ue.LC)()}_handleRequiredFieldsChange(){const r=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",r),r.then(()=>{this._updatingRequiredFieldsPromise===r&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){var r=this;return(0,o.Z)(function*(){if(!r.layer||!r.view)return;const i="3d"===r.view.type,{layer:s,layer:{fieldsIndex:l,objectIdField:u}}=r,y="renderer"in s&&s.renderer,p="orderBy"in s&&s.orderBy,f=s.featureReduction,c=new Set,C=yield(0,v.as)([y?y.collectRequiredFields(c,l):null,(0,P.Mu)(c,s),i?(0,P.vl)(c,s):null,(0,a.pC)(r.filter)?(0,P.Ll)(c,s,r.filter):null,(0,a.pC)(r.featureEffect)?(0,P.Ll)(c,s,r.featureEffect.filter):null,f?(0,P.ZV)(c,s,f):null,p?(0,P.Qj)(c,s,p):null]);if(s.timeInfo&&r.timeExtent&&(0,P.gd)(c,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),"feature"===s.type&&s.floorInfo&&(0,P.gd)(c,s.fieldsIndex,[s.floorInfo.floorField]),"subtype-group"===s.type){(0,P.AB)(c,l,s.subtypeField);const I=s.sublayers.map(B=>{var j;return Promise.all([null==(j=B.renderer)?void 0:j.collectRequiredFields(c,l),(0,P.Mu)(c,B)])});yield(0,v.as)(I)}for(const I of C)I.error&&de.error(I.error);(0,P.AB)(c,l,u),i&&"displayField"in s&&s.displayField&&(0,P.AB)(c,l,s.displayField);const T=Array.from(c).sort();r._set("requiredFields",T)})()}validateFetchPopupFeatures(r){if((0,a.Wi)(r))return null;for(const i of r.clientGraphics){const s=i.layer;if("popupEnabled"in s&&!s.popupEnabled)return new U.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(i.isAggregate){if(!(s.featureReduction&&"popupTemplate"in s.featureReduction&&s.featureReduction.popupEnabled&&s.featureReduction.popupTemplate))return new U.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!(0,ue.V)(s,r))return new U.Z("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}fetchClientPopupFeatures(r){var i=this;return(0,o.Z)(function*(){const s=(0,a.pC)(r)?r.clientGraphics:null;if(!s||0===s.length)return[];const l=new Array(s.length),u=new Map,y=yield i.createPopupQuery(r);for(let p=0;p<s.length;p++){const f=s[p];if(f.isAggregate){l[p]=f;continue}const{layer:c}=f;if(!("popupEnabled"in c))continue;const C=(0,P.Lk)(i.layer.fieldsIndex,y.outFields),T=(0,ue.V)(c,r);if((0,a.Wi)(T))continue;const I=yield i._loadArcadeModules(T);I&&I.arcadeUtils.hasGeometryOperations(T)||!(0,P.R9)(C,f)?u.set(f.getObjectId(),p):l[p]=f}if("stream"===i.layer.type||0===u.size)return l.filter(Boolean);y.objectIds=Array.from(u.keys());try{const p=yield i.layer.queryFeatures(y);for(const f of p.features)l[u.get(f.getObjectId())]=f}catch(p){}return l.filter(Boolean)})()}createPopupQuery(r){var i=this;return(0,o.Z)(function*(){const s=i.layer.createQuery(),l=new Set;let u=!1;const y=(0,a.pC)(r)&&r.clientGraphics?r.clientGraphics.map(p=>p.layer):[i.layer];for(const p of y){if(!("popupEnabled"in p))continue;const f=(0,ue.V)(p,r);if((0,a.Wi)(f))continue;const c=yield i._loadArcadeModules(f),C=c&&c.arcadeUtils.hasGeometryOperations(f);u=!("point"!==i.layer.geometryType&&!C);const T=yield(0,ue.e)(i.layer,f);for(const I of T)l.add(I)}if(s.returnGeometry=u,s.returnZ=u,s.returnM=u,s.outFields=Array.from(l),s.outSpatialReference=i.view.spatialReference,"feature"===i.layer.type){const p=(0,Ee.c)(i);(0,a.pC)(p)&&(s.where=s.where?`(${s.where}) AND (${p})`:p)}return s})()}canResume(){return!(!super.canResume()||(0,a.pC)(this.timeExtent)&&this.timeExtent.isEmpty)}};return(0,h._)([(0,d.Cb)()],e.prototype,"_updatingRequiredFieldsPromise",void 0),(0,h._)([(0,d.Cb)({readOnly:!0})],e.prototype,"availableFields",null),(0,h._)([(0,d.Cb)()],e.prototype,"effect",null),(0,h._)([(0,d.Cb)({type:Te.Z})],e.prototype,"featureEffect",null),(0,h._)([(0,d.Cb)({type:se.Z})],e.prototype,"filter",void 0),(0,h._)([(0,d.Cb)(Pe.qG)],e.prototype,"timeExtent",void 0),(0,h._)([(0,d.Cb)()],e.prototype,"layer",void 0),(0,h._)([(0,d.Cb)({type:Number})],e.prototype,"maximumNumberOfFeatures",null),(0,h._)([(0,d.Cb)({readOnly:!0,type:Boolean})],e.prototype,"maximumNumberOfFeaturesExceeded",null),(0,h._)([(0,d.Cb)({readOnly:!0})],e.prototype,"requiredFields",void 0),(0,h._)([(0,d.Cb)()],e.prototype,"suspended",void 0),(0,h._)([(0,d.Cb)()],e.prototype,"view",void 0),e=(0,h._)([(0,x.j)("esri.views.layers.FeatureLayerView")],e),e};var Ve=n(45611),Ze=n(94421),Ae=n(31637),Me=n(2004);function Ce(t){return t&&"openPorts"in t}const re=K.Z.getLogger("esri.views.2d.layers.FeatureLayerView2D");let D=class extends(we((0,Ze.Z)((0,z.y)(Ve.Z)))){constructor(){var t;super(...arguments),t=this,this._pipelineIsUpdating=!0,this._commandsQueue=new oe({process:e=>{switch(e.type){case"processed-edit":return this._doEdit(e);case"refresh":return this._doRefresh(e.dataChanged);case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightIds=new Map,this._updateHighlight=(0,v.Ds)((0,o.Z)(function*(){return t._proxy.setHighlight(Array.from(t._highlightIds.keys()))})),this._uploadsLocked=!1,this._needsClusterSizeUpdate=!1,this.featureEffectView=new ye,this._lastDefinitionExpression=null}destroy(){var t;(0,a.yw)(this._updateClusterSizeTask,e=>e.remove()),null==(t=this._proxy)||t.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.handles.add([this.on("valueRangesChanged",t=>{this._set("_aggregateValueRanges",t.valueRanges)}),(0,_.YP)(()=>this.featureEffect,t=>{this.featureEffectView.featureEffect=t},{initial:!0,sync:!0})])}_initProxy(){var t=this;return(0,o.Z)(function*(){const e=t.layer;if("isTable"in e&&e.isTable)throw new U.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:t.layer});if(!("feature"!==e.type&&"subtype-group"!==e.type||"capabilities"in e&&e.capabilities.operations.supportsQuery))throw new U.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});t._proxy&&t._proxy.destroy();const s=t._createClientOptions();return t._set("_proxy",new Oe({client:s})),t._proxy.when()})()}_initServiceOptions(){var t=this;return(0,o.Z)(function*(){return t._set("_serviceOptions",yield t._createServiceOptions()),t._serviceOptions})()}get orderByFields(){return"stream"!==this._serviceOptions.type&&this._serviceOptions.orderByFields}get labelsVisible(){return!this.suspended&&("subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer]).some(e=>e.labelingInfo&&e.labelsVisible)}get queryMode(){return this._serviceOptions.type}get renderingConfigHash(){if(!this.layer)return null;const t=this.availableFields,e=this.layer,r=this.view.floors,{definitionExpression:i}=e,s="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,l="renderer"in e&&e.renderer,u="feature"===e.type?e.gdbVersion:void 0,y="feature"===e.type&&e.historicMoment?e.historicMoment.getTime():void 0,{timeExtent:p}=this,f="customParameters"in e?JSON.stringify(e.customParameters):void 0,c="apiKey"in e?e.apiKey:void 0,C="stream"===e.type?`${JSON.stringify(e.geometryDefinition)}${e.definitionExpression}`:null,T=JSON.stringify(this.clips),I=e.featureReduction&&e.featureReduction.toJSON(),B="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),j="sublayers"in this.layer&&this.layer.sublayers.items.reduce((k,ce)=>k+`${ce.visible?1:0}.${JSON.stringify(ce.renderer)}.${ce.labelsVisible}\n.${JSON.stringify(ce.labelingInfo)}`,"");return JSON.stringify({orderBy:B,sublayerHash:j,subtypeCode:"subtypeCode"in this.layer&&this.layer.subtypeCode,filterHash:(0,a.pC)(this.filter)&&this.filter.toJSON(),effectHash:(0,a.pC)(this.featureEffect)&&this.featureEffect.toJSON(),streamFilter:C,gdbVersion:u,definitionExpression:i,historicMoment:y,availableFields:t,renderer:l,labelingInfo:s,timeExtent:p,floors:r,clipsHash:T,featureReduction:I,customParameters:f,apiKey:c})}highlight(t){let e;return t instanceof Z.Z?e=[t.getObjectId()]:"number"==typeof t||"string"==typeof t?e=[t]:Array.isArray(t)&&t.length>0?e="number"==typeof t[0]||"string"==typeof t[0]?t:t.map(r=>null==r?void 0:r.getObjectId()):N.Z.isCollection(t)&&t.length>0&&(e=t.map(r=>null==r?void 0:r.getObjectId()).toArray()),e=null==e?void 0:e.filter(r=>null!=r),e&&e.length?(this._addHighlight(e),{remove:()=>this._removeHighlight(e)}):{remove:()=>{}}}hasHighlight(){return!!this._highlightIds.size}hitTest(t,e){var r=this;return(0,o.Z)(function*(){if(!r.tileRenderer)return null;const i=yield r.tileRenderer.hitTest(e);if(0===i.length)return null;const{features:s,aggregates:l}=yield r._proxy.getFeatures(i);return[...l.map(u=>r._createGraphicHit(t,L.fromJSON(u))),...s.map(u=>r._createGraphicHit(t,Z.Z.fromJSON(u)))]})()}queryAggregates(){var t=this;return(0,o.Z)(function*(){return(yield t._proxy.getAggregates()).map(e=>L.fromJSON(e))})()}queryStatistics(){return this._proxy.queryStatistics()}querySummaryStatistics(t,e,r){var i=this;return(0,o.Z)(function*(){const s=$(q({},e),{scale:i.view.scale});return i._proxy.querySummaryStatistics(i._cleanUpQuery(t),s,r)})()}queryUniqueValues(t,e,r){var i=this;return(0,o.Z)(function*(){const s=$(q({},e),{scale:i.view.scale});return i._proxy.queryUniqueValues(i._cleanUpQuery(t),s,r)})()}queryClassBreaks(t,e,r){var i=this;return(0,o.Z)(function*(){const s=$(q({},e),{scale:i.view.scale});return i._proxy.queryClassBreaks(i._cleanUpQuery(t),s,r)})()}queryHistogram(t,e,r){var i=this;return(0,o.Z)(function*(){const s=$(q({},e),{scale:i.view.scale});return i._proxy.queryHistogram(i._cleanUpQuery(t),s,r)})()}queryFeatures(t,e){return this.queryFeaturesJSON(t,e).then(r=>{const i=ne.default.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryVisibleFeatures(t,e){return this._proxy.queryVisibleFeatures(this._cleanUpQuery(t),e).then(r=>{const i=ne.default.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryFeaturesJSON(t,e){return this._proxy.queryFeatures(this._cleanUpQuery(t),e)}queryObjectIds(t,e){return this._proxy.queryObjectIds(this._cleanUpQuery(t),e)}queryFeatureCount(t,e){return this._proxy.queryFeatureCount(this._cleanUpQuery(t),e)}queryExtent(t,e){return this._proxy.queryExtent(this._cleanUpQuery(t),e).then(r=>({count:r.count,extent:Me.Z.fromJSON(r.extent)}))}setVisibility(t,e){e?this._visibilityOverrides.delete(t):this._visibilityOverrides.add(t),this._update()}update(t){if(!this._tileStrategy||!this.tileRenderer)return;const{hasMissingTiles:e,added:r,removed:i}=this._tileStrategy.update(t);(r.length||i.length)&&this._proxy.updateTiles({added:r,removed:i}),e&&this.requestUpdate(),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new Fe({acquireTile:t=>this._acquireTile(t),releaseTile:t=>this._releaseTile(t),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.handles.add((0,_.YP)(()=>this.renderingConfigHash,()=>this._update(),_.nn),"attach"),"stream"!==this.layer.type&&this.handles.add(this.layer.on("edits",t=>this._edit(t)),"attach")}detach(){var t;this._commandsQueue.clear(),null==(t=this._proxy)||t.stop(),this.container.removeAllChildren(),this.handles.remove("attach"),this.tileRenderer&&(this.tileRenderer.uninstall(this.container),this.tileRenderer=null),this._tileStrategy&&(this._tileStrategy.destroy(),this._tileStrategy=null),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){var y;const t="renderer"in this.layer&&null!=this.layer.renderer,e=this._commandsQueue.updating,r=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,s=this._pipelineIsUpdating,l=null==this.tileRenderer||(null==(y=this.tileRenderer)?void 0:y.updating),u=t&&(e||r||i||s||l);return(0,g.Z)("esri-2d-log-updating")&&console.log(`Updating FLV2D: ${u}\n  -> hasRenderer ${t}\n  -> hasPendingCommand ${e}\n  -> updatingRequiredFields ${r}\n  -> updatingProxy ${i}\n  -> updatingPipeline ${s}\n  -> updatingTileRenderer ${l}\n`),u}_createClientOptions(){return{setUpdating:t=>{this._set("_pipelineIsUpdating",t)},emitEvent:t=>{this.emit(t.name,t.event)}}}_detectQueryMode(t){var e=this;return(0,o.Z)(function*(){var u;const i="editingInfo"in e.layer&&(null==(u=e.layer.editingInfo)?void 0:u.lastEditDate);if("path"in t&&("feature"===e.layer.type||"subtype-group"===e.layer.type)&&"point"===e.layer.geometryType&&e.layer.capabilities.query.supportsPagination&&!e.layer.capabilities.operations.supportsEditing&&(i||!e.layer.refreshInterval)&&(0,g.Z)("featurelayer-snapshot-enabled"))try{const y=yield e.layer.queryFeatureCount();if(y<=(0,g.Z)("featurelayer-snapshot-point-min-threshold"))return{mode:"snapshot",featureCount:y};const p=(0,g.Z)("featurelayer-snapshot-point-max-threshold"),f=(0,g.Z)("featurelayer-snapshot-point-coverage"),c=e.view.extent,C=(0,a.Wg)(e.layer.fullExtent),T=null==C?void 0:C.clone().intersection(c),I=(0,a.pC)(T)?T.width*T.height:0,B=(null==C?void 0:C.width)*(null==C?void 0:C.height),j=0===B?0:I/B;if(y<=p&&j>=f)return{mode:"snapshot",featureCount:y}}catch(y){re.warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:y})}return{mode:"on-demand"}})()}_createServiceOptions(){var t=this;return(0,o.Z)(function*(){var he;const e=t.layer;if("stream"===e.type)return null;const{capabilities:r,objectIdField:i}=e,s=e.fields.map(k=>k.toJSON()),l=(0,a.pC)(e.fullExtent)&&e.fullExtent.toJSON(),u=(0,Se.oq)(e.geometryType),y=e.timeInfo&&e.timeInfo.toJSON()||null,p=e.spatialReference?e.spatialReference.toJSON():null,f="feature"===e.type?e.globalIdField:null;let c;"ogc-feature"===e.type?c=e.source.getFeatureDefinition():Ce(e.source)?c=yield e.source.openPorts():e.parsedUrl&&(c=(0,S.d9)(e.parsedUrl),"dynamicDataSource"in e&&e.dynamicDataSource&&(c.query={layer:JSON.stringify({source:e.dynamicDataSource})}));const C="datesInUnknownTimezone"in t.layer&&t.layer.datesInUnknownTimezone,T=null!=(he="subtypeField"in t.layer&&t.layer.subtypeField)?he:null,{mode:I,featureCount:B}=yield t._detectQueryMode(c);let j=t.layer.objectIdField;if("feature"===t.layer.type&&(0,a.pC)(t.layer.orderBy)&&t.layer.orderBy.length){const k=!t.layer.orderBy[0].valueExpression&&t.layer.orderBy[0].field;k&&(j=k)}return{type:I,timeReferenceUnknownClient:C,subtypeField:T,featureCount:B,globalIdField:f,maxRecordCount:r.query.maxRecordCount,tileMaxRecordCount:r.query.tileMaxRecordCount,capabilities:r,fields:s,fullExtent:l,geometryType:u,objectIdField:i,source:c,timeInfo:y,spatialReference:p,orderByFields:j}})()}_createMemoryServiceOptions(t){var e=this;return(0,o.Z)(function*(){const r=yield t.openPorts();return $(q({},e._createServiceOptions()),{type:"memory",source:r})})()}_cleanUpQuery(t){const e=Y.Z.from(t)||this.createQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e}_update(){var t=this;return(0,o.Z)(function*(){return t._commandsQueue.push({type:"update"})})()}_edit(t){var e=this;return(0,o.Z)(function*(){return e.suspended?void e._clearTiles():e._validateEdit(t)?e._commandsQueue.push({type:"edit",edits:t}):void 0})()}doRefresh(t){var e=this;return(0,o.Z)(function*(){if(e._tileStrategy.tileKeys().length)return e.suspended&&t?void e._clearTiles():e._commandsQueue.push({type:"refresh",dataChanged:t})})()}_clearTiles(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}_validateEdit(t){const e="globalIdField"in this.layer&&this.layer.globalIdField,r=t.deletedFeatures.some(s=>-1===s.objectId||!s.objectId),i=e&&this.availableFields.includes(e);return r&&!i?(re.error(new U.Z("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${e} to be included the layer's outFields for updates to be reflected on the map`)),null):t}_doUpdate(){var t=this;return(0,o.Z)(function*(){try{if(t.destroyed||!t._hasRequiredSupport(t.layer)||!t._tileStrategy)return;const{featureEffectView:e,filter:r}=t;yield t._updateRequiredFields();const{renderer:i}=t._getEffectiveRenderer();t._set("_effectiveRenderer",i);const s=t._createSchemaConfig(),l=t._createConfiguration(s,r,e.filter),u=t._lastDefinitionExpression!==l.schema.source.definitionExpression;t._lastDefinitionExpression=l.schema.source.definitionExpression;const y=l.schema.tileRenderer,p=t._createTileRendererHash(y);if("snapshot"===t._serviceOptions.type&&(l.schema.source.featureCount=t._serviceOptions.featureCount),p!==t._tileRendererHash){yield t._initTileRenderer(y,i);const f=t.layer,c="stream"===f.type?yield t._initServiceOptions():t._serviceOptions;t.tileRenderer.onConfigUpdate(i),"stream"!==f.type&&Ce(f.source)&&(c.source=yield f.source.openPorts());const C={added:t._tileStrategy.tileKeys(),removed:[]};yield t._proxy.startup(t.view.featuresTilingScheme,l,c,C),t.hasHighlight()&&(yield t._proxy.setHighlight(Array.from(t._highlightIds.keys()))),yield t._onceTilesUpdated(),t.tileRenderer.onConfigUpdate(i)}else{"snapshot"===t._serviceOptions.type&&u&&(l.schema.source.featureCount=yield t.layer.queryFeatureCount());const f=yield t._proxy.update(l);(f.mesh||f.targets.aggregate)&&t._lockGPUUploads();try{yield t._proxy.applyUpdate(f)}catch(c){(0,v.D_)(c)||re.error(c)}(f.mesh||f.targets.aggregate)&&t._unlockGPUUploads(),t.tileRenderer.onConfigUpdate(i),t._updateClusterSizeVariable(),t._forceAttributeTextureUpload()}t._tileRendererHash=p,t.tileRenderer.invalidateLabels(),t.requestUpdate()}catch(e){}})()}_doEdit(t){var e=this;return(0,o.Z)(function*(){try{yield e._proxy.onEdits(t)}catch(r){(0,v.D_)(r)}})()}_doRefresh(t){var e=this;return(0,o.Z)(function*(){var r;e._lockGPUUploads();try{yield e._proxy.refresh(t)}catch(i){(0,v.D_)(i)}e._unlockGPUUploads(),(null==(r=e.layer)?void 0:r.featureReduction)&&e._updateClusterSizeVariable()})()}_updateClusterSizeVariable(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}_createUpdateClusterSizeTask(t,e){return(0,_.YP)(()=>this._aggregateValueRanges,r=>{this._updateClusterEffectiveRendererSizeVariable(t,e,r),this._needsClusterSizeUpdate=!0,this._uploadsLocked||this._updateClusterSizeVariable()})}_updateClusterEffectiveRendererSizeVariable(t,e,r){var i=this;return(0,o.Z)(function*(){if(t.dynamicClusterSize&&"visualVariables"in t&&t.visualVariables){const s=(0,G.os)(t.visualVariables);if((0,a.pC)(s)&&"cluster_count"===s.field){const l=t.visualVariables.indexOf(s);t.visualVariables[l]=(0,G.aV)(e,r);const u=t.clone();u.dynamicClusterSize=!0,i._set("_effectiveRenderer",u)}}})()}_getEffectiveRenderer(){var r;const t="renderer"in this.layer&&this.layer.renderer,e=this.layer.featureReduction;if((0,a.pC)(this._updateClusterSizeTask)&&(this._updateClusterSizeTask.remove(),this._updateClusterSizeTask=null),e&&"renderer"in e&&e.renderer){const i=[];for(const s of null!=(r=e.fields)?r:[])(0,G.OQ)(i,s);return{renderer:e.renderer,aggregateFields:i,featureReduction:e}}if(e&&"cluster"===e.type&&(0,G.yR)(t)){const i=e,s=[],l=(0,G.S1)(s,t,i,this._aggregateValueRanges);return(0,a.yw)(this._updateClusterSizeTask,u=>u.remove()),this._updateClusterSizeTask=this._createUpdateClusterSizeTask(l,i),{renderer:l,aggregateFields:s,featureReduction:e}}return{renderer:t,aggregateFields:[],featureReduction:null}}_acquireTile(t){const e=this.tileRenderer.acquireTile(t);return e.once("attach",()=>{this.requestUpdate()}),e}_releaseTile(t){this.tileRenderer.releaseTile(t)}_initTileRenderer(t,e){var r=this;return(0,o.Z)(function*(){const i=yield function H(t,e){return ee.apply(this,arguments)}(t,{layerView:r,tileInfoView:r.view.featuresTilingScheme,layer:r.layer});return r.tileRenderer&&(r._tileStrategy.clear(),r.tileRenderer.uninstall(r.container),r.tileRenderer.destroy(),r.tileRenderer=null),r.destroyed?null:(r._proxy.tileRenderer=i,r._set("tileRenderer",i),r.tileRenderer.install(r.container),r.tileRenderer.onConfigUpdate(e),r.requestUpdate(),r.tileRenderer)})()}_createTileRendererHash(t){return`${t.type}`}get hasFilter(){return!!(this.filter||"floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length||this._visibilityOverrides.size||this.timeExtent)}_injectOverrides(t){const e=(0,a.pC)(t)?t.timeExtent:null,r=(0,a.pC)(this.timeExtent)&&(0,a.pC)(e)?this.timeExtent.intersection(e):this.timeExtent||e;let i=null;const s="floorInfo"in this.layer&&this.layer.floorInfo;if(s){const u=(0,a.pC)(t)&&t.where;i=this._addFloorFilterClause(u)}if(!this._visibilityOverrides.size&&!r&&!s)return(0,a.pC)(t)?t.toJSON():null;(t=(0,a.pC)(t)&&t.clone()||new se.Z).timeExtent=r,i&&(t.where=i);const l=t.toJSON();return l.hiddenIds=Array.from(this._visibilityOverrides),l}_addFloorFilterClause(t){var i;const e=this.layer;let r=t||"";if("floorInfo"in e&&e.floorInfo){let s=this.view.floors;if(!s||!s.length)return r;(null==(i=e.floorInfo.viewAllLevelIds)?void 0:i.length)&&(s=e.floorInfo.viewAllLevelIds);const l=s.filter(p=>""!==p).map(p=>"'"+p+"'");l.push("''");const u=e.floorInfo.floorField;let y="("+u+" IN ({ids}) OR "+u+" IS NULL)";if(y=y.replace("{ids}",l.join(", ")),(0,a.pC)(r)&&r.includes(u)){let p=new RegExp("AND \\("+u+".*NULL\\)","g");r=r.replace(p,""),p=new RegExp("\\("+u+".*NULL\\)","g"),r=r.replace(p,""),r=r.replace(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+y:y}return""!==r?r:null}_createConfiguration(t,e,r){const i="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,s="feature"===this.layer.type?this.layer.gdbVersion:void 0,l=new Array(fe.m4),u=this._injectOverrides(e);l[0]=u,l[1]=(0,a.pC)(r)?r.toJSON():null;const y=(0,ge.Ew)(t);if((0,a.Wi)(y))return null;const p=(0,Ae.hc)("2d");return{availableFields:this.availableFields,gdbVersion:s,historicMoment:i,devicePixelRatio:window.devicePixelRatio||1,filters:l,schema:y,supportsTextureFloat:p.supportsTextureFloat,maxTextureSize:p.maxTextureSize}}_hasRequiredSupport(t){return!("renderer"in t)||(0,te.TT)(t.renderer)}_onceTilesUpdated(){return this.requestUpdate(),(0,_.N1)(()=>!this._pipelineIsUpdating)}_lockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}_unlockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_createSchemaConfig(){return{renderer:"renderer"in this.layer&&this.layer.renderer,spatialReference:this.layer.spatialReference,timeExtent:this.layer.timeExtent,definitionExpression:this.layer.definitionExpression,featureReduction:this.layer.featureReduction,fields:this.layer.fields,geometryType:this.layer.geometryType,historicMoment:"feature"===this.layer.type?this.layer.historicMoment:null,labelsVisible:"labelsVisible"in this.layer&&this.layer.labelsVisible,labelingInfo:"labelingInfo"in this.layer&&this.layer.labelingInfo,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:"feature"===this.layer.type?this.layer.gdbVersion:null,pixelBuffer:0,orderBy:"orderBy"in this.layer&&this.layer.orderBy?this.layer.orderBy:null,customParameters:$(q({},"customParameters"in this.layer?this.layer.customParameters:void 0),{token:"apiKey"in this.layer?this.layer.apiKey:void 0}),subtypeCode:"subtypeCode"in this.layer?this.layer.subtypeCode:void 0,subtypeField:"subtypeField"in this.layer?this.layer.subtypeField:void 0}}_addHighlight(t){for(const e of t)if(this._highlightIds.has(e)){const r=this._highlightIds.get(e);this._highlightIds.set(e,r+1)}else this._highlightIds.set(e,1);this._updateHighlight().catch(e=>{(0,v.D_)(e)||re.error(e)})}_removeHighlight(t){for(const e of t)if(this._highlightIds.has(e)){const r=this._highlightIds.get(e)-1;0===r?this._highlightIds.delete(e):this._highlightIds.set(e,r)}this._updateHighlight().catch(e=>{(0,v.D_)(e)||re.error(e)})}_setLayersForFeature(t){const e=this.layer;t.layer=e,t.sourceLayer=e}_createGraphicHit(t,e){return this._setLayersForFeature(e),(0,a.pC)(e.geometry)&&(e.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:e,layer:this.layer,mapPoint:t}}};(0,h._)([(0,d.Cb)()],D.prototype,"_serviceOptions",void 0),(0,h._)([(0,d.Cb)()],D.prototype,"_proxy",void 0),(0,h._)([(0,d.Cb)()],D.prototype,"_pipelineIsUpdating",void 0),(0,h._)([(0,d.Cb)()],D.prototype,"_effectiveRenderer",void 0),(0,h._)([(0,d.Cb)()],D.prototype,"_aggregateValueRanges",void 0),(0,h._)([(0,d.Cb)()],D.prototype,"_commandsQueue",void 0),(0,h._)([(0,d.Cb)()],D.prototype,"featureEffectView",void 0),(0,h._)([(0,d.Cb)()],D.prototype,"labelsVisible",null),(0,h._)([(0,d.Cb)({readOnly:!0})],D.prototype,"queryMode",null),(0,h._)([(0,d.Cb)()],D.prototype,"renderingConfigHash",null),(0,h._)([(0,d.Cb)()],D.prototype,"tileRenderer",void 0),(0,h._)([(0,d.Cb)()],D.prototype,"updating",void 0),D=(0,h._)([(0,x.j)("esri.views.2d.layers.FeatureLayerView2D")],D);const De=D},37384:(V,R,n)=>{n.d(R,{y:()=>G});var o=n(17626),h=n(74333),Z=n(89726),d=n(26584),m=n(32917),g=n(77712),L=(n(85931),n(8314),n(90912),n(76898)),J=n(1011),N=n(86810);n(63290),n(82255);let K=class extends N.wq{};K=(0,o._)([(0,L.j)("esri.views.layers.support.ClipArea")],K);const a=K;var v;let _=v=class extends a{constructor(){super(...arguments),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new v({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}get version(){return(this._get("version")||0)+1}};(0,o._)([(0,g.Cb)({type:[Number,String],json:{write:!0}})],_.prototype,"left",void 0),(0,o._)([(0,g.Cb)({type:[Number,String],json:{write:!0}})],_.prototype,"right",void 0),(0,o._)([(0,g.Cb)({type:[Number,String],json:{write:!0}})],_.prototype,"top",void 0),(0,o._)([(0,g.Cb)({type:[Number,String],json:{write:!0}})],_.prototype,"bottom",void 0),(0,o._)([(0,g.Cb)({readOnly:!0})],_.prototype,"version",null),_=v=(0,o._)([(0,L.j)("esri.views.layers.support.ClipRect")],_);const ie=_;n(29132);var Y,w=n(21674),ye=n(91179),se=n(2004),ne=n(37118);const fe={base:w.Z,key:"type",typeMap:{extent:se.Z,polygon:ne.Z}};let z=Y=class extends a{constructor(){super(...arguments),this.type="geometry",this.geometry=null}get version(){return(this._get("version")||0)+1}clone(){return new Y({geometry:this.geometry.clone()})}};(0,o._)([(0,g.Cb)({types:fe,json:{read:ye.im,write:!0}})],z.prototype,"geometry",void 0),(0,o._)([(0,g.Cb)({readOnly:!0})],z.prototype,"version",null),z=Y=(0,o._)([(0,L.j)("esri.views.layers.support.Geometry")],z);const ge=z;let H=class extends a{constructor(){super(...arguments),this.type="path",this.path=[]}get version(){return(this._get("version")||0)+1}};(0,o._)([(0,g.Cb)({type:[[[Number]]],json:{write:!0}})],H.prototype,"path",void 0),(0,o._)([(0,g.Cb)({readOnly:!0})],H.prototype,"version",null),H=(0,o._)([(0,L.j)("esri.views.layers.support.Path")],H);const te=h.Z.ofType({key:"type",base:a,typeMap:{rect:ie,path:H,geometry:ge}}),G=ve=>{let F=class extends ve{constructor(){super(...arguments),this.attached=!1,this.clips=new te,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1}initialize(){var W,Q,oe,ae;const E=null==(Q=null==(W=this.view)?void 0:W.spatialReferenceLocked)||Q;(null==(oe=this.view)?void 0:oe.spatialReference)&&E&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new d.Z("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new J.W),this.container.fadeTransitionEnabled=!0,this.container.opacity=0,this.container.clips=this.clips,this.handles.add([(0,m.YP)(()=>this.suspended,M=>{this.container&&(this.container.visible=!M),this.view&&!M&&this.updateRequested&&this.view.requestUpdate()},m.tX),(0,m.YP)(()=>{var M,le;return null!=(le=null==(M=this.layer)?void 0:M.opacity)?le:1},M=>{this.container&&(this.container.opacity=M)},m.tX),(0,m.YP)(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",M=>{this.container&&(this.container.blendMode=M)},m.tX),(0,m.YP)(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,M=>{this.container&&(this.container.effect=M)},m.tX),(0,m.on)(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)})]),(null==(ae=this.view)?void 0:ae.whenLayerView)?this.view.whenLayerView(this.layer).then(M=>{M===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get spatialReferenceSupported(){var A;const E=null==(A=this.view)?void 0:A.spatialReference;return null==E||this.supportsSpatialReference(E)}get updating(){var E;return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!(null==(E=this.updatingHandles)?void 0:E.updating))}get visibleAtCurrentScale(){return this.isVisibleAtScale(this.view.scale)}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.detach(),this.updateRequested=!1)}isVisibleAtScale(E){const A=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;if(!A)return!0;const{minScale:W,maxScale:Q}=A;return(0===W||E<=W)&&(0===Q||E>=Q)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestUpdate())}processUpdate(E){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",E),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(E))):this.updateRequested=!1}hitTest(E,A){return Promise.resolve(null)}supportsSpatialReference(E){return!0}canResume(){return!!this.spatialReferenceSupported&&!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const E=super.getSuspendInfo(),A=!this.spatialReferenceSupported,W=this.visibleAtCurrentScale;return A&&(E.spatialReferenceNotSupported=A),W&&(E.outsideScaleRange=W),E}};return(0,o._)([(0,g.Cb)()],F.prototype,"attached",void 0),(0,o._)([(0,g.Cb)({type:te,set(E){const A=(0,Z.Z)(E,this._get("clips"),te);this._set("clips",A)}})],F.prototype,"clips",void 0),(0,o._)([(0,g.Cb)()],F.prototype,"container",void 0),(0,o._)([(0,g.Cb)()],F.prototype,"moving",void 0),(0,o._)([(0,g.Cb)({readOnly:!0})],F.prototype,"spatialReferenceSupported",null),(0,o._)([(0,g.Cb)({readOnly:!0})],F.prototype,"updateParameters",void 0),(0,o._)([(0,g.Cb)()],F.prototype,"updateRequested",void 0),(0,o._)([(0,g.Cb)()],F.prototype,"updating",null),(0,o._)([(0,g.Cb)()],F.prototype,"view",void 0),(0,o._)([(0,g.Cb)({readOnly:!0})],F.prototype,"visibleAtCurrentScale",null),F=(0,o._)([(0,L.j)("esri.views.2d.layers.LayerView2D")],F),F}},45611:(V,R,n)=>{n.d(R,{Z:()=>K});var o=n(17626),h=n(14517),Z=n(61885),d=n(80542),m=n(61996),g=n(63290),b=n(62208),x=n(60330),O=n(77712),U=(n(85931),n(8314),n(90912),n(76898));let S=class extends((0,d.p)((0,m.IG)((0,x.v)(Z.Z.EventedMixin(h.Z))))){constructor(a){super(a),this.layer=null,this.parent=null}initialize(){this.when().catch(a=>{if("layerview:create-error"!==a.name){const v=this.layer&&this.layer.id||"no id",_=this.layer&&this.layer.title||"no title";g.Z.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${_}', id: '${v}')`,a)}})}get fullOpacity(){return(0,b.Pt)(this.get("layer.opacity"),1)*(0,b.Pt)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){var a;return!this.suspended&&!0===(null==(a=this.layer)?void 0:a.legendEnabled)}get updating(){var a;return!(!(null==(a=this.updatingHandles)?void 0:a.updating)&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){var a;return!0===(null==(a=this.layer)?void 0:a.visible)}set visible(a){void 0!==a?this._override("visible",a):this._clearOverride("visible")}canResume(){var a,v,_;return this.visible&&(null==(a=this.layer)?void 0:a.loaded)&&!(null==(v=this.parent)?void 0:v.suspended)&&(null==(_=this.view)?void 0:_.ready)||!1}getSuspendInfo(){const a=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(a.viewNotReady=!0),this.layer&&this.layer.loaded||(a.layerNotLoaded=!0),this.visible||(a.layerInvisible=!0),a}isUpdating(){return!1}};(0,o._)([(0,O.Cb)()],S.prototype,"fullOpacity",null),(0,o._)([(0,O.Cb)()],S.prototype,"layer",void 0),(0,o._)([(0,O.Cb)()],S.prototype,"parent",void 0),(0,o._)([(0,O.Cb)({readOnly:!0})],S.prototype,"suspended",null),(0,o._)([(0,O.Cb)({readOnly:!0})],S.prototype,"suspendInfo",null),(0,o._)([(0,O.Cb)({readOnly:!0})],S.prototype,"legendEnabled",null),(0,o._)([(0,O.Cb)({type:Boolean,readOnly:!0})],S.prototype,"updating",null),(0,o._)([(0,O.Cb)({readOnly:!0})],S.prototype,"updatingProgress",null),(0,o._)([(0,O.Cb)()],S.prototype,"visible",null),(0,o._)([(0,O.Cb)()],S.prototype,"view",void 0),S=(0,o._)([(0,U.j)("esri.views.layers.LayerView")],S);const K=S},94421:(V,R,n)=>{n.d(R,{Z:()=>L});var o=n(17626),h=n(63290),Z=n(10699),d=n(32917),m=n(77712),O=(n(85931),n(8314),n(90912),n(76898));const L=J=>{let N=class extends J{initialize(){this.handles.add((0,d.on)(()=>this.layer,"refresh",U=>{this.doRefresh(U.dataChanged).catch(S=>{(0,Z.D_)(S)||h.Z.getLogger(this.declaredClass).error(S)})}),"RefreshableLayerView")}};return(0,o._)([(0,m.Cb)()],N.prototype,"layer",void 0),N=(0,o._)([(0,O.j)("esri.layers.mixins.RefreshableLayerView")],N),N}},10023:(V,R,n)=>{n.d(R,{V:()=>g,e:()=>d});var o=n(15861),h=n(62208),Z=n(36630);function d(b){return m.apply(this,arguments)}function m(){return(m=(0,o.Z)(function*(b,x=b.popupTemplate){if((0,h.Wi)(x))return[];const O=yield x.getRequiredFields(b.fieldsIndex),{lastEditInfoEnabled:L}=x,{objectIdField:J,typeIdField:N,globalIdField:U,relationships:S}=b;if(O.includes("*"))return["*"];const K=L?yield(0,Z.CH)(b):[],a=(0,Z.Q0)(b.fieldsIndex,[...O,...K]);return N&&a.push(N),a&&J&&b.fieldsIndex.has(J)&&!a.includes(J)&&a.push(J),a&&U&&b.fieldsIndex.has(U)&&!a.includes(U)&&a.push(U),S&&S.forEach(v=>{const{keyField:_}=v;a&&_&&b.fieldsIndex.has(_)&&!a.includes(_)&&a.push(_)}),a})).apply(this,arguments)}function g(b,x){return b.popupTemplate?b.popupTemplate:(0,h.pC)(x)&&x.defaultPopupTemplateEnabled&&(0,h.pC)(b.defaultPopupTemplate)?b.defaultPopupTemplate:null}}}]);